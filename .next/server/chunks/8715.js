"use strict";exports.id=8715,exports.ids=[8715],exports.modules={45847:(e,s,r)=>{r.a(e,async(e,t)=>{try{r.d(s,{Z:()=>i});var a=r(20997),o=r(21382),n=r(5716),l=e([o,n]);function i({children:e}){return(0,a.jsxs)("div",{className:"flex min-h-screen flex-col",children:[a.jsx(o.Z,{}),a.jsx("main",{className:"flex-1",children:a.jsx("div",{className:"container",children:e})}),a.jsx(n.Z,{})]})}[o,n]=l.then?(await l)():l,t()}catch(e){t(e)}})},33566:(e,s,r)=>{r.a(e,async(e,t)=>{try{r.d(s,{Z:()=>i});var a=r(20997);r(16689);var o=r(87764),n=r(35037),l=e([n]);n=(l.then?(await l)():l)[0];let i=({title:e,description:s,searchPlaceholder:r="Search...",searchValue:t="",onSearchChange:l,actions:i})=>(console.log(`PageHeader: Rendering for ${e}`),a.jsx("div",{className:"w-full",children:(0,a.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,a.jsxs)("div",{children:[a.jsx("h1",{className:"text-2xl font-semibold text-purple-700",children:e}),s&&a.jsx("p",{className:"text-gray-600 mt-1",children:s})]}),(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[l&&(0,a.jsxs)("div",{className:"relative w-96",children:[a.jsx(o.Z,{className:"absolute left-2 top-2.5 h-4 w-4 text-gray-500"}),a.jsx(n.I,{type:"search",placeholder:r,className:"pl-8",value:t,onChange:l})]}),i]})]})}));t()}catch(e){t(e)}})},17344:(e,s,r)=>{r.d(s,{a:()=>i});var t=r(41649),a=r(11163),o=r(16689),n=r(98225),l=r(65050);function i(e={}){let{data:s,status:r}=(0,t.useSession)(),i=(0,a.useRouter)(),{toast:c}=(0,l.pm)(),[u,d]=(0,o.useState)(!1),[h,m]=(0,o.useState)(!0),[f,g]=(0,o.useState)(null),[p,v]=(0,o.useState)(!1),{redirectTo:S="/auth/login",requiredRoles:x=[]}=e;(0,o.useEffect)(()=>{if(console.log("Auth effect running, status:",r,"verified:",p),"loading"===r||p)return;if(s?.user){if(console.log("Found NextAuth session, storing to localStorage"),n.UserSession.storeSession(s.user),x.length>0){let e=(s?.user?.role||"").toLowerCase();if(!x.some(s=>s.toLowerCase()===e)){console.log(`Required role not found. User role: ${e}`),d(!1),m(!1),g("You do not have permission to access this page"),v(!0),i.push("/dashboard");return}}d(!0),m(!1),g(null),v(!0);return}let e=n.UserSession.getSession();if(e){if(console.log("Found valid localStorage session, using as fallback"),x.length>0){let s=(e.role||"").toLowerCase();if(!x.some(e=>e.toLowerCase()===s)){console.log(`Required role not found. Local user role: ${s}`),d(!1),m(!1),g("You do not have permission to access this page"),v(!0),i.push("/dashboard");return}}d(!0),m(!1),g(null),v(!0);return}console.log("No valid session found, redirecting to login"),i.push(`${S}?callbackUrl=${encodeURIComponent(window.location.href)}`)},[r,s,i,S,x,p]);let w=(0,o.useCallback)(()=>n.UserSession.getAuthHeaders(),[]),y=(0,o.useCallback)(async()=>n.UserSession.getCurrentUser(),[]),b=(0,o.useCallback)(e=>n.UserSession.hasRole(e),[]),U=(0,o.useCallback)(()=>{console.log("Handling expired session"),n.UserSession.clearSession(),(0,t.signOut)({redirect:!1});let e=window.location.href;i.push(`${S}?callbackUrl=${encodeURIComponent(e)}&expired=true`)},[S,i]),k=(0,o.useCallback)(e=>{switch(e.status){case 401:return console.log("Detected 401 unauthorized response - session likely expired"),U(),!1;case 403:return console.log("Detected 403 forbidden response - permission denied"),c({title:"Permission Denied",description:"You don't have permission to access this resource",variant:"destructive"}),!1;case 429:return console.log("Detected 429 response - rate limited"),c({title:"Rate Limited",description:"Too many requests. Please try again later.",variant:"destructive"}),!1;case 500:case 502:case 503:case 504:return console.log(`Detected server error (${e.status})`),c({title:"Server Error",description:"The server encountered an error. Please try again later.",variant:"destructive"}),!1}return!0},[U,c]);return{session:s,status:r,isAuthorized:u,isLoading:h,authError:f,getAuthHeaders:w,getCurrentUser:y,hasRole:b,handleExpiredSession:U,checkResponseAuth:k}}},87942:(e,s,r)=>{r.d(s,{MX:()=>m});var t=r(47449),a=r.n(t),o=r(98432),n=r.n(o);r(62113),r(60614);var l=r(41649),i=r(53524);let c=global.prisma||new i.PrismaClient;async function u(e){console.log("[ServerAuth] Checking authentication for path:",e.resolvedUrl);let s=await (0,l.getSession)(e);console.log("[ServerAuth] Session result:",s?"Found":"Not found");let r={isAuthenticated:!!s,user:s?.user,headers:{"Content-Type":"application/json",Cookie:e.req.headers.cookie||""},fallbackUsed:!1};if(!s){let s=e.req.cookies.p_chart_auth_user;if(console.log("[ServerAuth] Checking fallback cookie:",s?"Found":"Not found"),s)try{let e;try{e=JSON.parse(s),console.log("[ServerAuth] Successfully parsed JSON user data from cookie")}catch(r){if(console.warn("[ServerAuth] Could not parse JSON from cookie, value:",s),"1"===s)e={id:"1",role:"admin"};else try{let r=s.match(/"id"\s*:\s*"([^"]+)"/),t=s.match(/"role"\s*:\s*"([^"]+)"/),a=s.match(/"name"\s*:\s*"([^"]+)"/);e={id:r?r[1]:"1",role:t?t[1]:"user",name:a?a[1]:"Anonymous"},console.log("[ServerAuth] Extracted partial user data from malformed cookie:",e)}catch(s){e={id:"1",role:"admin"},console.warn("[ServerAuth] Using default admin as fallback after extraction failure")}}r.isAuthenticated=!0,r.user=e,r.fallbackUsed=!0,r.headers["X-User-Id"]=e.id||"1",r.headers["X-User-Role"]=e.role?.toLowerCase()||"admin",console.log("[ServerAuth] Using fallback auth with user:",e)}catch(e){console.error("[ServerAuth] Error processing fallback auth:",e)}}return r}async function d(e){if(!(await u(e)).isAuthenticated){let s=e.resolvedUrl,r=`/auth/login${s?`?callbackUrl=${encodeURIComponent(s)}`:""}`;return console.log("[ServerAuth] Not authenticated, redirecting to:",r),{redirect:{destination:r,permanent:!1}}}return null}async function h(e){let s=await u(e);return async(e,r={})=>{let t=e.startsWith("http")?e:`http://localhost:3000${e.startsWith("/")?"":"/"}${e}`,a={...r,headers:{...s.headers,...r.headers||{}}};return console.log(`[ServerAuth] Fetching ${t}`),fetch(t,a)}}function m(e){return async s=>{let r=await d(s);if(r)return r;let t=await u(s),a=await h(s);return e(s,{user:t.user,isAuthenticated:!0,fetchWithAuth:a})}}a()({name:"credentials",credentials:{username:{label:"Username",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.username||!e?.password)return null;try{let s=await c.user.findUnique({where:{username:e.username}});if(!s||!s.password||!await n().compare(e.password,s.password))return null;return{id:String(s.id),username:s.username,name:s.name||s.username,email:s.email,role:s.role}}catch(e){return console.error("Error during authentication:",e),null}}}),process.env.NEXTAUTH_DEBUG}};