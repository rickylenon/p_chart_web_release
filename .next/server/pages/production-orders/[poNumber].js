"use strict";(()=>{var e={};e.id=2410,e.ids=[2410,2888,660],e.modules={47653:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("AlertCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]])},76789:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]])},1757:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Book",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20",key:"t4utmx"}]])},13742:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]])},98814:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]])},64998:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("ChevronRight",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]])},50316:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]])},50868:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("ClipboardCheck",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"m9 14 2 2 4-4",key:"df797q"}]])},66942:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]])},56989:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]])},23217:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},45977:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]])},78051:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("LogOut",[["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}],["polyline",{points:"16 17 21 12 16 7",key:"1gabdz"}],["line",{x1:"21",x2:"9",y1:"12",y2:"12",key:"1uyos4"}]])},77232:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]])},90250:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Moon",[["path",{d:"M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z",key:"a7tn18"}]])},36467:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("MoreHorizontal",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]])},90470:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]])},45657:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("PlusCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]])},87764:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]])},71408:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]])},39455:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Shield",[["path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10",key:"1irkt0"}]])},77705:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z",key:"1lpok0"}]])},58532:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Sun",[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]])},13718:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]])},28142:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]])},94933:(e,t,r)=>{r.d(t,{Z:()=>a});/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,r(84297).Z)("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]])},31905:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>x,default:()=>p,getServerSideProps:()=>h,getStaticPaths:()=>g,getStaticProps:()=>m,reportWebVitals:()=>y,routeModule:()=>j,unstable_getServerProps:()=>w,unstable_getServerSideProps:()=>N,unstable_getStaticParams:()=>k,unstable_getStaticPaths:()=>b,unstable_getStaticProps:()=>f});var s=r(87093),o=r(35244),i=r(1323),n=r(91777),l=r.n(n),d=r(65143),c=r(46317),u=e([d,c]);[d,c]=u.then?(await u)():u;let p=(0,i.l)(c,"default"),m=(0,i.l)(c,"getStaticProps"),g=(0,i.l)(c,"getStaticPaths"),h=(0,i.l)(c,"getServerSideProps"),x=(0,i.l)(c,"config"),y=(0,i.l)(c,"reportWebVitals"),f=(0,i.l)(c,"unstable_getStaticProps"),b=(0,i.l)(c,"unstable_getStaticPaths"),k=(0,i.l)(c,"unstable_getStaticParams"),w=(0,i.l)(c,"unstable_getServerProps"),N=(0,i.l)(c,"unstable_getServerSideProps"),j=new s.PagesRouteModule({definition:{kind:o.x.PAGES,page:"/production-orders/[poNumber]",pathname:"/production-orders/[poNumber]",bundlePath:"",filename:""},components:{App:d.default,Document:l()},userland:c});a()}catch(e){a(e)}})},30346:(e,t,r)=>{r.d(t,{y:()=>o});var a=r(20997),s=r(16689);function o({children:e}){let[t,r]=(0,s.useState)(!1);return(0,s.useEffect)(()=>{r(!0)},[]),a.jsx(a.Fragment,{children:e})}},2577:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{m:()=>x});var s=r(20997),o=r(16689),i=r.n(o),n=r(37622),l=r(87249),d=r(21989),c=r(6655),u=r(17344),p=r(65050),m=r(23217),g=r(47653),h=e([n,l,d,c]);function x({open:e,onClose:t,poNumber:r,operationId:a,defectId:h,type:x,title:y}){let{getAuthHeaders:f}=(0,u.a)(),{toast:b}=(0,p.pm)(),[k,w]=(0,o.useState)(!1),[N,j]=(0,o.useState)(null),[v,q]=(0,o.useState)([]),[C,R]=(0,o.useState)({total:0,page:1,limit:10,pages:0}),S=async(t=1)=>{w(!0),j(null),console.log(`AuditLogModal: Loading audit logs - open: ${e}, poNumber: ${r}, operationId: ${a}, defectId: ${h}, type: ${x}`);try{let e="/api/audit-logs/operations?";"defect"===x&&h?e+=`defectId=${h}&`:a?e+=`operationId=${a}&`:r&&(e+=`poNumber=${r}&`),e+=`type=${x}&limit=10&page=${t}`,console.log("Fetching audit logs with URL:",e);let s=await fetch(e,{headers:f()});if(!s.ok){let e=await s.json();throw Error(e.error||`Failed to fetch ${x} audit logs`)}let o=await s.json();console.log(`Fetched ${o.data.length} ${x} audit logs:`,o),q(o.data),R(o.pagination)}catch(e){console.error(`Error fetching ${x} audit logs:`,e),j(e instanceof Error?e.message:"An unknown error occurred"),b({variant:"destructive",title:"Error",description:e instanceof Error?e.message:"Failed to load audit logs"})}finally{w(!1)}};(0,o.useEffect)(()=>{e?(console.log(`AuditLogModal: Loading audit logs - open: ${e}, poNumber: ${r}, operationId: ${a}, defectId: ${h}, type: ${x}`),S(1)):console.log("AuditLogModal: Not open, skipping log fetch")},[e]);let I=e=>{S(e)},E=e=>new Date(e).toLocaleString(),$=e=>{if(!e||0===Object.keys(e).length)return s.jsx("span",{className:"text-gray-400 dark:text-gray-500",children:"No changes"});let t=Object.keys(e),r=[];for(let e=0;e<t.length;e+=2)e+1<t.length?r.push([t[e],t[e+1]]):r.push([t[e]]);return s.jsx("table",{className:"min-w-full text-xs border-collapse",children:s.jsx("tbody",{children:r.map((t,r)=>(0,s.jsxs)("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-900",children:[t.map(t=>(0,s.jsxs)(i().Fragment,{children:[s.jsx("td",{className:"py-1 px-2 border border-gray-200 dark:border-gray-700 font-medium bg-gray-50 dark:bg-gray-900 w-1/6",children:t}),s.jsx("td",{className:"py-1 px-2 border border-gray-200 dark:border-gray-700 w-1/3 break-words dark:text-gray-300",children:null===e[t]?s.jsx("span",{className:"text-gray-400 dark:text-gray-500",children:"null"}):String(e[t])})]},t)),1===t.length&&(0,s.jsxs)(s.Fragment,{children:[s.jsx("td",{className:"py-1 px-2 border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 w-1/6"}),s.jsx("td",{className:"py-1 px-2 border border-gray-200 dark:border-gray-700 w-1/3"})]})]},r))})})},T=e=>{switch(e.toLowerCase()){case"create":return"text-green-600 dark:text-green-400";case"update":return"text-blue-600 dark:text-blue-400";case"delete":return"text-red-600 dark:text-red-400";default:return"text-gray-600 dark:text-gray-400"}},D=(e,t)=>{if(!e)return{};let r=["quantity","quantityRework","quantityNogood","defectName","startTime","endTime","inputQuantity","outputQuantity","rf","lineNo"];return"create"===t.toLowerCase()?e:Object.keys(e).filter(e=>r.includes(e)).reduce((t,r)=>(t[r]=e[r],t),{})};return s.jsx(n.Vq,{open:e,onOpenChange:e=>!e&&t(),children:(0,s.jsxs)(n.cZ,{className:"sm:max-w-[700px] max-h-[90vh] overflow-y-auto",children:[(0,s.jsxs)(n.fK,{children:[s.jsx(n.$N,{className:"text-xl font-semibold",children:y}),(0,s.jsxs)(n.Be,{children:["Audit logs show a history of all changes made to this ","operation"===x?"operation":"defect","."]})]}),k?(0,s.jsxs)("div",{className:"flex justify-center py-8",children:[s.jsx(m.Z,{className:"h-8 w-8 animate-spin text-gray-500 dark:text-gray-400"}),s.jsx("span",{className:"ml-2 text-gray-500 dark:text-gray-400",children:"Loading audit logs..."})]}):N?(0,s.jsxs)("div",{className:"bg-red-50 dark:bg-red-950/30 p-4 rounded-md flex items-center",children:[s.jsx(g.Z,{className:"h-5 w-5 text-red-500 dark:text-red-400 mr-2"}),s.jsx("p",{className:"text-red-600 dark:text-red-400",children:N})]}):0===v.length?s.jsx("div",{className:"bg-gray-50 dark:bg-black p-6 rounded-md text-center",children:(0,s.jsxs)("p",{className:"text-gray-500 dark:text-gray-400",children:["No audit logs found for this ","operation"===x?"operation":"defect","."]})}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(d.iA,{children:[s.jsx(d.xD,{children:(0,s.jsxs)(d.SC,{children:[s.jsx(d.ss,{className:"w-[120px]",children:"Timestamp"}),s.jsx(d.ss,{className:"w-[80px]",children:"Action"}),s.jsx(d.ss,{className:"w-[100px]",children:"User"})]})}),s.jsx(d.RM,{children:v.map(e=>(0,s.jsxs)(i().Fragment,{children:[(0,s.jsxs)(d.SC,{className:"border-t-2 border-t-gray-300 dark:border-t-gray-700",children:[s.jsx(d.pj,{className:"font-mono text-xs dark:text-gray-300",children:E(e.timestamp)}),s.jsx(d.pj,{className:T(e.action),children:e.action}),s.jsx(d.pj,{className:"dark:text-gray-300",children:e.user})]}),s.jsx(d.SC,{children:(0,s.jsxs)(d.pj,{colSpan:3,className:"p-2 bg-gray-50 dark:bg-gray-900",children:[s.jsx("div",{className:"flex items-center mb-1",children:s.jsx("div",{className:"text-xs font-medium text-gray-500 dark:text-gray-400",children:"update"===e.action.toLowerCase()?"From:":"Data:"})}),s.jsx("div",{className:"rounded border border-gray-200 dark:border-gray-700 overflow-x-auto",children:$(D("update"===e.action.toLowerCase()?e.oldValues:e.newValues||e.oldValues,e.action))})]})}),"update"===e.action.toLowerCase()&&s.jsx(d.SC,{className:"border-b-2 border-b-gray-200 dark:border-b-gray-700",children:(0,s.jsxs)(d.pj,{colSpan:3,className:"p-2 bg-gray-50 dark:bg-gray-900",children:[s.jsx("div",{className:"flex items-center mb-1",children:s.jsx("div",{className:"text-xs font-medium text-gray-500 dark:text-gray-400",children:"To:"})}),s.jsx("div",{className:"rounded border border-gray-200 dark:border-gray-700 overflow-x-auto",children:$(D(e.newValues,e.action))})]})}),"update"!==e.action.toLowerCase()&&s.jsx(d.SC,{className:"border-b-2 border-b-gray-200 dark:border-b-gray-700",children:s.jsx(d.pj,{colSpan:3,className:"p-0 h-2"})})]},e.id))})]}),C.pages>1&&s.jsx(c.tl,{className:"mt-4",children:(0,s.jsxs)(c.ng,{children:[s.jsx(c.nt,{children:s.jsx(c.dN,{onClick:()=>C.page>1&&I(C.page-1),className:C.page<=1?"pointer-events-none opacity-50":"cursor-pointer"})}),Array.from({length:Math.min(C.pages,5)},(e,t)=>{let r=C.page,a=C.pages,o=[1];return r>2&&o.push(r-1),r>1&&r<a&&o.push(r),r<a-1&&o.push(r+1),a>1&&o.push(a),(o=[...new Set(o)].sort((e,t)=>e-t)).map((e,t)=>t>0&&e>o[t-1]+1?(0,s.jsxs)(i().Fragment,{children:[s.jsx(c.nt,{children:s.jsx(c.Dj,{})}),s.jsx(c.nt,{children:s.jsx(c.kN,{onClick:()=>I(e),isActive:e===r,children:e})},e)]},`ellipsis-${t}`):s.jsx(c.nt,{children:s.jsx(c.kN,{onClick:()=>I(e),isActive:e===r,children:e})},e))}),s.jsx(c.nt,{children:s.jsx(c.$0,{onClick:()=>C.page<C.pages&&I(C.page+1),className:C.page>=C.pages?"pointer-events-none opacity-50":"cursor-pointer"})})]})})]}),s.jsx(n.cN,{children:s.jsx(l.z,{onClick:t,children:"Close"})})]})})}[n,l,d,c]=h.then?(await h)():h,a()}catch(e){a(e)}})},82477:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{Z:()=>g});var s=r(20997),o=r(16689),i=r(87249),n=r(35037),l=r(65765),d=r(37622),c=r(65050),u=r(98225),p=r(59165),m=e([i,n,l,d,p]);function g({open:e,onClose:t,defect:r,operationId:a,operationCode:m,poNumber:g}){console.log("Rendering DefectAddRequestDialog with defect:",r);let{toast:h}=(0,c.pm)(),{socket:x,isConnected:y,emit:f}=(0,p.lm)(),[b,k]=(0,o.useState)(!1),[w,N]=(0,o.useState)(""),[j,v]=(0,o.useState)({quantity:1,quantityRework:(r.reworkable,0),quantityNogood:(r.reworkable,1),quantityReplacement:"op10"===m.toLowerCase()?1:0});(0,o.useEffect)(()=>{v({quantity:1,quantityRework:(r.reworkable,0),quantityNogood:(r.reworkable,1),quantityReplacement:"op10"===m.toLowerCase()?1:0}),N("")},[r,m]);let q=(e,t)=>{console.log(`Updating ${e} to ${t}`),v(a=>{let s={...a};if("quantity"===e&&(s.quantity=t,r.reworkable?(s.quantityRework=Math.min(a.quantityRework,t),s.quantityNogood=t-s.quantityRework):(s.quantityRework=0,s.quantityNogood=t),"op10"===m.toLowerCase()&&(s.quantityReplacement=t)),"quantityRework"===e){let e=Math.min(t,a.quantity);s.quantityRework=e,s.quantityNogood=a.quantity-e}if("quantityNogood"===e){let e=Math.min(t,a.quantity);s.quantityNogood=e,s.quantityRework=a.quantity-e}return"quantityReplacement"===e&&(s.quantityReplacement=Math.min(t,a.quantity)),s})},C=async()=>{if(!(j.quantity<=0)&&w.trim()&&!b){if(console.log("Submit request with poNumber:",g),!a){h({title:"Error",description:"Operation ID is missing",variant:"destructive"});return}if(!g){h({title:"Error",description:"Production Order Number is missing",variant:"destructive"});return}k(!0);try{console.log("Submitting defect add request:",{defect:r,operationId:a,values:j,poNumber:g});let e=[];if(a||e.push("operationId"),g||e.push("poNumber"),w.trim()||e.push("reason"),r.id||e.push("defectId"),r.name||e.push("defectName"),j.quantity<=0&&e.push("quantity (must be > 0)"),e.length>0)throw console.error("Missing required fields for add request:",{operationId:a,poNumber:g,hasReason:!!w.trim(),defectId:r.id,defectName:r.name,qty:j.quantity,rw:j.quantityRework,ng:j.quantityNogood,rp:j.quantityReplacement}),Error(`Missing required fields: ${e.join(", ")}`);let s={requestType:"add",operationId:Number(a),defectId:Number(r.id),defectName:r.name,defectCategory:r.category||"",defectReworkable:!!r.reworkable,defectMachine:r.machine||"",poNumber:g,currentQty:0,currentRw:0,currentNg:0,currentReplacement:0,requestedQty:j.quantity,requestedRw:j.quantityRework,requestedNg:j.quantityNogood,requestedReplacement:j.quantityReplacement,reason:w.trim(),operationCode:m};console.log("Request payload:",JSON.stringify(s,null,2));let o=await fetch("/api/operation-defect-edit-requests",{method:"POST",headers:{"Content-Type":"application/json",...u.UserSession.getAuthHeaders()},body:JSON.stringify(s)});if(console.log("Response status:",o.status),!o.ok){let e=await o.json();throw console.error("Error response:",e),Error(e.error||`Failed to submit add request (${o.status})`)}let i=await o.json();if(console.log("Success response:",i),y&&x){console.log("Emitting defect-add-requested event via WebSocket for real-time updates");let e=await u.UserSession.getCurrentUser();f("defect-edit-requested",{id:i.editRequest?.id,requestType:"add",defectId:r.id,defectName:r.name,poNumber:g,requestedQty:j.quantity,requestedById:e?.id,userName:e?.name,userRole:e?.role,createdAt:new Date().toISOString()})}else console.warn("Socket not connected, only server-side notification will be created");h({title:"Add request submitted",description:i.message||"Your request to add this defect has been sent for approval"}),t(),N(""),v({quantity:1,quantityRework:(r.reworkable,0),quantityNogood:(r.reworkable,1),quantityReplacement:"op10"===m.toLowerCase()?1:0})}catch(e){console.error("Error submitting add request:",e),h({title:"Error",description:e instanceof Error?e.message:"Failed to submit request",variant:"destructive"})}finally{k(!1)}}};return s.jsx(d.Vq,{open:e,onOpenChange:e=>!e&&t(),children:(0,s.jsxs)(d.cZ,{className:"sm:max-w-md",children:[s.jsx(d.fK,{children:s.jsx(d.$N,{className:"text-xl font-semibold",children:"Request to Add Defect"})}),(0,s.jsxs)("div",{className:"space-y-4 py-2",children:[(0,s.jsxs)("div",{children:[s.jsx("h3",{className:"font-medium text-lg dark:text-white",children:r.name}),s.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:r.category}),r.machine&&(0,s.jsxs)("p",{className:"text-xs text-gray-400 dark:text-gray-500",children:["Machine: ",r.machine]}),r.reworkable&&s.jsx("p",{className:"text-xs text-green-500 dark:text-green-400 mt-1 font-medium",children:"Reworkable"})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[s.jsx("div",{className:"text-sm font-medium mb-1 dark:text-gray-300",children:"Requested Quantity *"}),(0,s.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"QTY"}),s.jsx(n.I,{type:"number",min:"1",className:"h-9 dark:bg-black",value:j.quantity,onChange:e=>q("quantity",parseInt(e.target.value)||0)})]}),(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"RW"}),s.jsx(n.I,{type:"number",min:"0",className:`h-9 ${r.reworkable?"dark:bg-black":"bg-gray-100 dark:bg-black/70"}`,value:j.quantityRework,onChange:e=>q("quantityRework",parseInt(e.target.value)||0),disabled:!r.reworkable})]}),(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"NG"}),s.jsx(n.I,{type:"number",min:"0",className:"h-9 dark:bg-black",value:j.quantityNogood,onChange:e=>q("quantityNogood",parseInt(e.target.value)||0)})]})]}),"op10"===m.toLowerCase()&&s.jsx("div",{className:"grid grid-cols-3 gap-2 mt-2",children:(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"RP"}),s.jsx(n.I,{type:"number",min:"0",max:j.quantity,className:"h-9 border-blue-300 dark:border-blue-700 dark:bg-black",value:j.quantityReplacement,onChange:e=>q("quantityReplacement",parseInt(e.target.value)||0)})]})})]}),(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-sm font-medium mb-1 dark:text-gray-300",children:"Reason for Adding *"}),s.jsx(l.g,{placeholder:"Provide a detailed reason for adding this defect",className:"resize-none dark:bg-black",value:w,onChange:e=>N(e.target.value)})]})]}),(0,s.jsxs)(d.cN,{className:"sm:justify-end",children:[s.jsx(i.z,{variant:"outline",onClick:t,children:"Cancel"}),s.jsx(i.z,{onClick:C,disabled:j.quantity<=0||!w.trim()||b,children:b?"Submitting...":"Submit Request"})]})]})})}[i,n,l,d,p]=m.then?(await m)():m,a()}catch(e){a(e)}})},53641:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{o:()=>y});var s=r(20997),o=r(16689),i=r.n(o),n=r(87249),l=r(35037),d=r(65765),c=r(41310),u=r(90470),p=r(13718),m=r(65050),g=r(98225),h=r(59165),x=e([n,l,d,c,h]);function y({defect:e,operationCode:t,poNumber:r,disabled:a=!1,onClose:x}){let{toast:y}=(0,m.pm)(),{socket:f,isConnected:b,emit:k}=(0,h.lm)(),w=i().useMemo(()=>e.defectName||e.name,[e.defectName,e.name]),N=i().useMemo(()=>e.defectCategory||e.category,[e.defectCategory,e.category]),j=i().useMemo(()=>e.defectMachine||e.machine,[e.defectMachine,e.machine]),v=i().useMemo(()=>void 0!==e.defectReworkable?e.defectReworkable:e.reworkable,[e.defectReworkable,e.reworkable]),[q,C]=(0,o.useState)(()=>({quantity:e.quantity,quantityRework:e.quantityRework,quantityNogood:e.quantityNogood,quantityReplacement:void 0!==e.quantityReplacement?e.quantityReplacement:e.quantity})),R=i().useMemo(()=>0===q.quantity,[q.quantity]),S=i().useMemo(()=>q.quantity!==e.quantity||q.quantityRework!==e.quantityRework||q.quantityNogood!==e.quantityNogood||"op10"===t.toLowerCase()&&q.quantityReplacement!==(void 0!==e.quantityReplacement?e.quantityReplacement:e.quantity),[q,e.quantity,e.quantityRework,e.quantityNogood,e.quantityReplacement,t]);(0,o.useEffect)(()=>(console.log("DefectEditRequestPopover mounted for defect:",{id:e.id,name:e.name||e.defectName,category:e.category||e.defectCategory,operationDefectId:e.operationDefectId}),C({quantity:e.quantity,quantityRework:e.quantityRework,quantityNogood:e.quantityNogood,quantityReplacement:void 0!==e.quantityReplacement?e.quantityReplacement:e.quantity}),console.log("Operation code:",t),console.log("PO number:",r),()=>{console.log("DefectEditRequestPopover unmounted")}),[e.category,e.defectCategory,e.defectName,e.id,e.name,e.operationId,e.quantity,e.quantityRework,e.quantityNogood,e.quantityReplacement,t,r]);let[I,E]=(0,o.useState)(!1),[$,T]=(0,o.useState)(""),[D,L]=(0,o.useState)(!1),[O,P]=(0,o.useState)(null),[A,F]=(0,o.useState)(!1),M=(0,o.useCallback)(()=>{P(null),C({quantity:e.quantity,quantityRework:e.quantityRework,quantityNogood:e.quantityNogood,quantityReplacement:void 0!==e.quantityReplacement?e.quantityReplacement:e.quantity}),T("")},[e.quantity,e.quantityRework,e.quantityNogood,e.quantityReplacement]),Z=(0,o.useCallback)(async()=>{try{if(F(!0),console.log("[fetchExistingRequest] Fetching existing requests for defect:",e),!e.operationDefectId){console.log("[fetchExistingRequest] No operationDefectId available, skipping fetch"),M(),F(!1);return}let t=Number(e.operationDefectId);if(isNaN(t)){console.log("[fetchExistingRequest] Invalid operationDefectId, skipping fetch"),M(),F(!1);return}let r=`operationDefectId=${t}`;console.log("[fetchExistingRequest] Using query param for fetch:",r);let a=await fetch(`/api/operation-defect-edit-requests?${r}`,{method:"GET",headers:{...g.UserSession.getAuthHeaders()}});if(!a.ok)throw Error("[fetchExistingRequest] Failed to fetch existing requests");let s=await a.json();if(console.log("[fetchExistingRequest] Existing requests response:",s),s.editRequests&&s.editRequests.length>0){console.log("[fetchExistingRequest] All edit requests with statuses:",s.editRequests.map(e=>({id:e.id,operationDefectId:e.operationDefectId,status:e.status})));let t=s.editRequests.filter(t=>t.operationDefectId===(e.operationDefectId?Number(e.operationDefectId):Number(e.id)));if(0===t.length){console.log(`[fetchExistingRequest] No requests with matching operationDefectId ${e.operationDefectId} found. All requests have different IDs.`),M();return}console.log("[fetchExistingRequest] Matching requests by operationDefectId:",t.length);let r=t.filter(e=>"pending"===e.status);if(console.log("[fetchExistingRequest] Pending requests found:",r.length),r.length>0){let e=r[0];console.log("[fetchExistingRequest] Using pending request:",e),console.log("[fetchExistingRequest] Pending request requestedBy type:",typeof e.requestedBy),console.log("[fetchExistingRequest] Pending request requestedBy value:",e.requestedBy);let t={id:e.id?.toString()||"",requestedQty:Number(e.requestedQty)||0,requestedRw:Number(e.requestedRw)||0,requestedNg:Number(e.requestedNg)||0,requestedReplacement:Number(e.requestedReplacement)||0,reason:e.reason||"",requestedBy:e.requestedBy||"Unknown",status:e.status||"pending"};console.log("[fetchExistingRequest] Processed request:",t),P(t),C({quantity:t.requestedQty,quantityRework:t.requestedRw,quantityNogood:t.requestedNg,quantityReplacement:t.requestedReplacement||t.requestedQty}),T(t.reason||""),e.requestType&&console.log("[fetchExistingRequest] Existing request type:",e.requestType)}else console.log("[fetchExistingRequest] No pending requests found"),M()}else console.log("[fetchExistingRequest] No edit requests found in response"),M()}catch(e){console.error("[fetchExistingRequest] Error fetching existing requests:",e),y({title:"Error",description:"Failed to check for existing edit requests",variant:"destructive"}),M()}finally{F(!1)}},[e.id,e.operationDefectId,e.quantity,e.quantityRework,e.quantityNogood,e.quantityReplacement,M,y]);(0,o.useEffect)(()=>{I&&Z()},[I,Z]);let U=(e,r)=>{console.log(`Updating ${e} to ${r}`),C(a=>{let s={...a};if("quantity"===e&&(s.quantity=r,0===r?(s.quantityRework=0,s.quantityNogood=0,s.quantityReplacement=0):(s.quantityRework=0,s.quantityNogood=r,"op10"===t.toLowerCase()&&(s.quantityReplacement=r,console.log(`OP10 detected: Setting replacement to match quantity: ${r}`)))),"quantityRework"===e){let e=Math.min(r,a.quantity);s.quantityRework=e,s.quantityNogood=a.quantity-e}if("quantityNogood"===e){let e=Math.min(r,a.quantity);s.quantityNogood=e,s.quantityRework=a.quantity-e}return"quantityReplacement"===e&&(s.quantityReplacement=r),s})},z=async()=>{if(S&&$.trim()&&!D){L(!0);try{if(console.log("Submitting edit request for defect:",e.id,e.defectName||e.name),console.log("Is delete request:",R),O){let e=0===O.requestedQty;e!==R&&console.log(`Request type changed: from ${e?"delete":"edit"} to ${R?"delete":"edit"}`)}let a=e.operationDefectId||e.id;console.log("Using operation defect ID for submission:",a),console.log(`${O?"Updating":"Creating"} edit request`);let s={operationDefectId:a,defectName:e.defectName||e.name,poNumber:r,currentQty:e.quantity,currentRw:e.quantityRework,currentNg:e.quantityNogood,currentReplacement:void 0!==e.quantityReplacement?e.quantityReplacement:e.quantity,requestedQty:q.quantity,requestedRw:q.quantityRework,requestedNg:q.quantityNogood,requestedReplacement:q.quantityReplacement,reason:$,requestType:R?"delete":"edit",operationCode:t,...O&&{requestId:O.id}};console.log("Request payload:",s),console.log("Request type being sent:",R?"delete":"edit"),O&&console.log("Updating existing request ID:",O.id);let o=await fetch("/api/operation-defect-edit-requests",{method:"POST",headers:{"Content-Type":"application/json",...g.UserSession.getAuthHeaders()},body:JSON.stringify(s)});if(console.log("Response status:",o.status),!o.ok){let e=await o.json();throw console.error("Error response:",e),Error(e.error||`Failed to submit edit request (${o.status})`)}let i=await o.json();if(console.log("Success response:",i),b&&f){console.log("Emitting defect-edit-requested event via WebSocket for real-time updates");let t=await g.UserSession.getCurrentUser();k("defect-edit-requested",{id:i.editRequest?.id,operationDefectId:a,defectName:e.defectName||e.name,poNumber:r,requestedQty:q.quantity,requestedById:t?.id,userName:t?.name,userRole:t?.role,createdAt:new Date().toISOString()})}else console.warn("Socket not connected, only server-side notification will be created");y({title:O?"Edit request updated":R?"Delete request submitted":"Edit request submitted",description:i.message||(O?"Your request has been updated":R?"Your request to delete this defect has been sent to admin for approval":"Your request has been sent to admin for approval")}),Q(),x&&x(),T(""),C({quantity:e.quantity,quantityRework:e.quantityRework,quantityNogood:e.quantityNogood,quantityReplacement:void 0!==e.quantityReplacement?e.quantityReplacement:e.quantity})}catch(e){console.error("Error submitting edit request:",e),y({title:"Error",description:e instanceof Error?e.message:"Failed to submit request",variant:"destructive"})}finally{L(!1)}}},Q=()=>{E(!1),x&&x()},V=i().useCallback(e=>{E(e),!e&&x&&x()},[x]);return(0,s.jsxs)(c.J2,{open:I,onOpenChange:V,children:[s.jsx(c.xo,{asChild:!0,children:(0,s.jsxs)(n.z,{variant:"ghost",size:"icon",className:"text-white hover:text-white-800 bg-primary/80 hover:bg-primary/100 h-5 w-5 p-1 -mt-1 -mr-1 rounded-full border border-primay",disabled:a,children:[s.jsx(u.Z,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Request edit permission"})]})}),I&&s.jsx(c.yk,{className:"w-80",children:A?s.jsx("div",{className:"flex justify-center py-4",children:s.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"})}):(0,s.jsxs)("div",{className:"space-y-4 max-h-[40vh] overflow-y-auto pr-1",children:[(0,s.jsxs)("div",{children:[s.jsx("h3",{className:"font-medium text-lg",children:R?"Request Delete Permission":"Request Edit Permission"}),s.jsx("p",{className:"text-sm text-gray-500",children:w}),(0,s.jsxs)("p",{className:"text-xs text-gray-400",children:[N,j&&` | Machine: ${j}`]})]}),O&&(0,s.jsxs)("div",{className:"bg-amber-50 border border-amber-200 rounded-md p-3",children:[s.jsx("div",{className:"font-medium text-amber-700",children:"Pending Request Exists"}),(0,s.jsxs)("p",{className:"text-sm text-amber-600",children:["There is already a pending request submitted by"," ","object"==typeof O.requestedBy?O.requestedBy.name:O.requestedBy,". You can update it below."]})]}),R&&(0,s.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-md p-3",children:[s.jsx("div",{className:"font-medium text-red-700",children:"Delete Request"}),s.jsx("p",{className:"text-sm text-red-600",children:"Setting quantity to zero will request deletion of this defect. Admin approval is required."})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[s.jsx("div",{className:"text-sm font-medium mb-1",children:"Requested Value *"}),!R&&(0,s.jsxs)(n.z,{variant:"ghost",size:"sm",className:"text-red-600 hover:text-red-800 hover:bg-red-50 h-7 px-2 py-1",onClick:()=>{C({quantity:0,quantityRework:0,quantityNogood:0,quantityReplacement:0})},children:[s.jsx(p.Z,{className:"h-3.5 w-3.5 mr-1"}),s.jsx("span",{className:"text-xs",children:"Delete"})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"QTY"}),s.jsx(l.I,{type:"number",min:"0",className:`h-9 ${R?"border-red-300 focus:ring-red-500":""}`,value:q.quantity,onChange:e=>U("quantity",parseInt(e.target.value)||0)})]}),(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"RW"}),s.jsx(l.I,{type:"number",min:"0",className:`h-9 ${v?"":"bg-gray-100"} ${R?"bg-gray-100":""}`,value:q.quantityRework,onChange:e=>U("quantityRework",parseInt(e.target.value)||0),disabled:!v||R})]}),(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"NG"}),s.jsx(l.I,{type:"number",min:"0",className:`h-9 ${R?"bg-gray-100":""}`,value:q.quantityNogood,onChange:e=>U("quantityNogood",parseInt(e.target.value)||0),disabled:R})]})]}),"op10"===t.toLowerCase()&&s.jsx("div",{className:"grid grid-cols-3 gap-2 mt-2",children:(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"RP"}),s.jsx(l.I,{type:"number",min:"0",max:q.quantity,className:`h-9 border-blue-300 focus:ring-blue-500 ${R?"bg-gray-100":""}`,value:q.quantityReplacement,onChange:e=>U("quantityReplacement",parseInt(e.target.value)||0),disabled:R})]})})]}),(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-sm font-medium mb-1",children:"Reason for Change *"}),s.jsx(d.g,{placeholder:R?"Provide a detailed reason for this deletion request":"Provide a detailed reason for this change request",className:"resize-none",value:$,onChange:e=>T(e.target.value)})]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2",children:[s.jsx(n.z,{variant:"outline",size:"sm",onClick:Q,children:"Cancel"}),s.jsx(n.z,{size:"sm",onClick:z,disabled:!S||!$.trim()||D,className:R?"bg-red-600 hover:bg-red-700":"",children:D?"Submitting...":O?"Update Request":R?"Request Delete":"Submit Request"})]})]})})]})}[n,l,d,c,h]=x.then?(await x)():x,a()}catch(e){a(e)}})},44775:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{H:()=>g});var s=r(20997),o=r(16689),i=r(37622),n=r(87249),l=r(98225),d=r(65050),c=r(45657),u=r(77705),p=r(13718),m=e([i,n]);function g({open:e,onClose:t,operationId:r,operationCode:a,poNumber:m,onRefresh:g,isAdmin:h}){let[x,y]=(0,o.useState)([]),[f,b]=(0,o.useState)(!1),{toast:k}=(0,d.pm)();(0,o.useEffect)(()=>{e&&r&&w()},[e,r]);let w=async()=>{if(r){b(!0);try{console.log(`Fetching pending requests for operation ${r}`);let e=await fetch(`/api/operation-defect-edit-requests?operationId=${r}&status=pending`,{method:"GET",headers:{...l.UserSession.getAuthHeaders()}});if(!e.ok)throw Error(`Failed to fetch pending requests (${e.status})`);let t=await e.json();console.log("Pending requests response:",t),t.editRequests&&Array.isArray(t.editRequests)&&y(t.editRequests)}catch(e){console.error("Error fetching pending requests:",e),k({title:"Error",description:"Failed to load pending defect requests",variant:"destructive"})}finally{b(!1)}}},N=async(e,t,r="")=>{if(h)try{console.log(`${t} request ${e} with comment: ${r}`);let a=await fetch(`/api/operation-defect-edit-requests/${e}/resolve`,{method:"PUT",headers:{"Content-Type":"application/json",...l.UserSession.getAuthHeaders()},body:JSON.stringify({status:t,comments:r})});if(!a.ok){let e=await a.json();throw Error(e.error||`Failed to ${t} request`)}k({title:"Success",description:`Request ${t} successfully`}),w(),g()}catch(e){console.error(`Error ${t} request:`,e),k({title:"Error",description:e instanceof Error?e.message:`Failed to ${t} request`,variant:"destructive"})}},j=e=>{switch(e){case"add":return s.jsx(c.Z,{className:"w-4 h-4 text-green-500"});case"edit":return s.jsx(u.Z,{className:"w-4 h-4 text-blue-500"});case"delete":return s.jsx(p.Z,{className:"w-4 h-4 text-red-500"});default:return s.jsx(u.Z,{className:"w-4 h-4 text-gray-500"})}},v=e=>{switch(e){case"add":return"Add";case"edit":return"Edit";case"delete":return"Delete";default:return"Update"}},q=e=>{switch(e){case"add":return"border-l-green-400 bg-green-50 dark:bg-green-950/30 dark:border-l-green-600";case"edit":return"border-l-blue-400 bg-blue-50 dark:bg-blue-950/30 dark:border-l-blue-600";case"delete":return"border-l-red-400 bg-red-50 dark:bg-red-950/30 dark:border-l-red-600";default:return"border-l-purple-400 bg-purple-50 dark:bg-purple-950/30 dark:border-l-purple-600"}};return s.jsx(i.Vq,{open:e,onOpenChange:e=>!e&&t(),children:(0,s.jsxs)(i.cZ,{className:"sm:max-w-lg max-h-[85vh] overflow-hidden flex flex-col",children:[s.jsx(i.fK,{children:s.jsx(i.$N,{className:"flex items-center gap-2",children:s.jsx("span",{children:"Pending Defect Requests"})})}),s.jsx("div",{className:"py-4 overflow-y-auto pr-1",children:f?s.jsx("div",{className:"flex justify-center py-8",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-white"})}):0===x.length?s.jsx("div",{className:"text-center py-6 bg-gray-50 dark:bg-black rounded-md border border-gray-200 dark:border-gray-800",children:s.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No pending defect requests for this operation."})}):s.jsx("div",{className:"space-y-4",children:x.map(e=>s.jsx("div",{className:`border border-l-4 rounded-md p-4 bg-white dark:bg-black shadow-sm ${q(e.requestType)}`,children:(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[j(e.requestType),(0,s.jsxs)("span",{className:"font-medium text-sm uppercase dark:text-gray-300",children:[v(e.requestType)," Request"]})]}),s.jsx("h3",{className:"font-medium text-md dark:text-white",children:"add"===e.requestType?e.defectName:e.operationDefect?.defectName||e.defectName||"Unknown Defect"}),s.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"add"===e.requestType?e.defectCategory:e.operationDefect?.defectCategory||e.defectCategory||"Unknown Category"}),("add"===e.requestType?e.defectMachine:e.operationDefect?.defectMachine)&&(0,s.jsxs)("p",{className:"text-xs text-gray-400 dark:text-gray-500",children:["Machine:"," ","add"===e.requestType?e.defectMachine:e.operationDefect?.defectMachine]}),("add"===e.requestType?e.defectReworkable:e.operationDefect?.defectReworkable)===!0&&s.jsx("p",{className:"text-xs text-green-500 dark:text-green-400 mt-1",children:"Reworkable"}),(0,s.jsxs)("div",{className:"mt-2 text-sm dark:text-gray-300",children:[(0,s.jsxs)("p",{children:["Requested by: ",e.requestedBy?.name||"Unknown"]}),(0,s.jsxs)("p",{children:["Reason: ",e.reason]}),s.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:new Date(e.createdAt).toLocaleString()})]})]}),(0,s.jsxs)("div",{className:"sm:text-right",children:["delete"!==e.requestType&&(0,s.jsxs)("div",{className:"grid grid-cols-4 gap-2 mb-2",children:[(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"QTY"}),(0,s.jsxs)("div",{className:"flex flex-col",children:["edit"===e.requestType&&s.jsx("div",{className:"text-xs text-gray-400 dark:text-gray-500 line-through",children:e.currentQty}),s.jsx("div",{className:"font-medium dark:text-white",children:e.requestedQty})]})]}),(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"RW"}),(0,s.jsxs)("div",{className:"flex flex-col",children:["edit"===e.requestType&&s.jsx("div",{className:"text-xs text-gray-400 dark:text-gray-500 line-through",children:e.currentRw}),s.jsx("div",{className:"font-medium dark:text-white",children:e.requestedRw})]})]}),(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"NG"}),(0,s.jsxs)("div",{className:"flex flex-col",children:["edit"===e.requestType&&s.jsx("div",{className:"text-xs text-gray-400 dark:text-gray-500 line-through",children:e.currentNg}),s.jsx("div",{className:"font-medium dark:text-white",children:e.requestedNg})]})]}),e.operationCode?.toLowerCase()==="op10"&&(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-blue-500 dark:text-blue-400",children:"RP"}),(0,s.jsxs)("div",{className:"flex flex-col",children:["edit"===e.requestType&&s.jsx("div",{className:"text-xs text-gray-400 dark:text-gray-500 line-through",children:void 0!==e.currentReplacement?e.currentReplacement:e.currentQty}),s.jsx("div",{className:"font-medium text-blue-600 dark:text-blue-400",children:void 0!==e.requestedReplacement?e.requestedReplacement:e.requestedQty})]})]})]}),"delete"===e.requestType&&s.jsx("div",{className:"text-sm font-medium text-red-500 dark:text-red-400 mb-2",children:"Request to delete this defect"}),h&&(0,s.jsxs)("div",{className:"flex flex-row gap-2 justify-end mt-3",children:[s.jsx(n.z,{size:"sm",variant:"outline",className:"text-red-600 hover:text-red-800 hover:bg-red-50 dark:text-red-400 dark:hover:text-red-300 dark:hover:bg-red-950/30 border-red-200 dark:border-red-800",onClick:()=>N(e.id,"rejected","Request rejected"),children:"Reject"}),s.jsx(n.z,{size:"sm",variant:"outline",className:"text-green-600 hover:text-green-800 hover:bg-green-50 dark:text-green-400 dark:hover:text-green-300 dark:hover:bg-green-950/30 border-green-200 dark:border-green-800",onClick:()=>N(e.id,"approved"),children:"Approve"})]})]})]})},e.id))})})]})})}[i,n]=m.then?(await m)():m,a()}catch(e){a(e)}})},32832:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{w:()=>d});var s=r(20997),o=r(16689),i=r(87249),n=r(35037),l=e([i,n]);function d({showEndOperationModal:e,activeTab:t,lineNo:r,rfValue:a,isCompletingOperation:l,setLineNo:d,setShowEndOperationModal:c,submitCompleteOperation:u}){let[p,m]=(0,o.useState)([]),[g,h]=(0,o.useState)(!1),[x,y]=(0,o.useState)(!1),[f,b]=(0,o.useState)(null);(0,o.useEffect)(()=>{e&&k()},[e,t]);let k=async()=>{try{h(!0),b(null),console.log(`Fetching line number options for operation: ${t}`);let e=await fetch(`/api/operation-lines?operation=${t}`);if(!e.ok)throw Error("Failed to fetch line options");let r=await e.json();console.log("Operation-specific line options fetched:",r.lines),r.lines&&r.lines.length>0?m(r.lines):(console.log("No operation-specific lines found, falling back to generic options"),await w())}catch(e){console.error("Error fetching operation-specific line options:",e),b("Failed to load line options. Using generic options instead."),await w()}finally{h(!1)}},w=async()=>{try{console.log("Falling back to generic line options");let e=await fetch("/api/dashboard/filter-options");if(!e.ok)throw Error("Failed to fetch fallback line options");let t=await e.json();console.log("Fallback line options fetched:",t.lines),m(t.lines||[])}catch(e){console.error("Error fetching fallback line options:",e),m([])}},N=e=>{console.log("Selected line:",e),d(e),y(!1)};if(!e)return null;let j=p.filter(e=>e?.toLowerCase().includes(r.toLowerCase()));return s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-900 p-6 rounded-lg shadow-lg w-full max-w-md",children:[(0,s.jsxs)("h2",{className:"text-xl font-semibold mb-4 dark:text-white",children:["End Operation: ",t.toUpperCase()]}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"relative",children:[s.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-200",children:"Line Number *"}),f&&s.jsx("p",{className:"text-xs text-amber-600 mb-1",children:f}),s.jsx(n.I,{type:"text",value:r,onChange:e=>{let t=e.target.value;d(t),y(t.length>0)},onFocus:()=>y(!0),onBlur:()=>setTimeout(()=>y(!1),200),placeholder:"Enter line number",required:!0,className:"dark:bg-gray-800 dark:text-white"}),x&&s.jsx("div",{className:"absolute z-10 w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto",children:g?s.jsx("div",{className:"flex justify-center py-4",children:s.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900 dark:border-white"})}):s.jsx(s.Fragment,{children:j.length>0?j.map((e,t)=>s.jsx("div",{className:"p-2 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer text-sm dark:text-white",onClick:()=>N(e),children:e},t)):s.jsx("div",{className:"p-2 text-center text-gray-500 dark:text-gray-400 text-sm",children:"No matching lines found"})})})]}),s.jsx("div",{children:(0,s.jsxs)("label",{className:"block text-sm font-medium mb-1 dark:text-gray-200",children:["Current Resource Factor (RF): ",a]})})]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2 mt-6",children:[s.jsx(i.z,{variant:"outline",onClick:()=>c(!1),disabled:l,className:"dark:text-white",children:"Cancel"}),s.jsx(i.z,{className:"bg-red-600 hover:bg-red-700 text-white",onClick:u,disabled:l||!r.trim(),children:l?(0,s.jsxs)("div",{className:"flex items-center",children:[s.jsx("span",{className:"animate-spin mr-2",children:"⟳"})," Processing..."]}):"End Operation"})]})]})})}[i,n]=l.then?(await l)():l,a()}catch(e){a(e)}})},99419:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{J:()=>y});var s=r(20997),o=r(16689),i=r(35037),n=r(51853),l=r(87764),d=r(13718),c=r(53641),u=r(87249),p=r(44775),m=r(98225),g=r(41649),h=r(37622),x=e([i,c,u,p,h]);function y({activeTab:e,defects:t,isAdmin:r,operationStatuses:a,isUpdatingDefects:x,isLoadingDefects:y,poNumber:f,handleDefectQuantityChange:b,refreshDefectsForOperationCallback:k,selectedDefectId:w,selectedDefectName:N,setSelectedDefectId:j,setSelectedDefectName:v,setShowDefectItemAuditLog:q,deleteDefect:C,masterDefects:R,isLoadingMasterDefects:S,handleAddDefect:I,existingDefects:E}){let[$,T]=(0,o.useState)(null),[D,L]=(0,o.useState)(""),[O,P]=(0,o.useState)(!1),[A,F]=(0,o.useState)(0),{data:M}=(0,g.useSession)();console.log("User role in OperationDefectsList:",M?.user?.role);let Z=t.filter(e=>null!==e.operationDefectId),U=""===D.trim()?Z:Z.filter(e=>e.name.toLowerCase().includes(D.toLowerCase())||e.category.toLowerCase().includes(D.toLowerCase())||e.machine&&e.machine.toLowerCase().includes(D.toLowerCase()));console.log(`Rendering OperationDefectsList for tab: ${e}, defects count: ${Z.length}, filtered count: ${U.length}`),(0,o.useEffect)(()=>{a[e]?.operationId&&z()},[e,a]);let z=async()=>{try{let t=a[e]?.operationId;if(!t)return;let r=await fetch(`/api/operation-defect-edit-requests?operationId=${t}&status=pending&count=true`,{method:"GET",headers:{...m.UserSession.getAuthHeaders()}});if(!r.ok)throw Error(`Failed to fetch pending requests count (${r.status})`);let s=await r.json();console.log("Pending requests count:",s.count),void 0!==s.count&&F(s.count)}catch(e){console.error("Error fetching pending requests count:",e)}},Q=e=>{let r=t.find(t=>t.id===e);r&&T({id:r.id,name:r.name})};return(0,s.jsxs)("div",{children:[s.jsx(h.Vq,{open:!!$,onOpenChange:e=>!e&&T(null),children:(0,s.jsxs)(h.cZ,{className:"sm:max-w-md",children:[(0,s.jsxs)(h.fK,{children:[(0,s.jsxs)(h.$N,{className:"flex items-center gap-2",children:[s.jsx(n.Z,{className:"h-5 w-5 text-red-500"}),"Confirm Delete"]}),(0,s.jsxs)(h.Be,{children:['Are you sure you want to delete the defect "',$?.name,'"? This action cannot be undone.']})]}),(0,s.jsxs)(h.cN,{className:"flex flex-row justify-end gap-2 sm:justify-end",children:[s.jsx(u.z,{type:"button",variant:"outline",onClick:()=>{T(null)},children:"Cancel"}),s.jsx(u.z,{type:"button",variant:"destructive",onClick:()=>{$&&C&&(C($.id),T(null))},children:"Delete"})]})]})}),s.jsx(p.H,{open:O,onClose:()=>P(!1),operationId:a[e]?.operationId,operationCode:e,poNumber:"string"==typeof f?f:Array.isArray(f)?f[0]:"",onRefresh:()=>{z(),k()},isAdmin:r}),(0,s.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsxs)("div",{className:"relative w-40",children:[s.jsx("div",{className:"absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none",children:s.jsx(l.Z,{className:"h-3.5 w-3.5 text-gray-500 dark:text-gray-400"})}),s.jsx(i.I,{type:"search",placeholder:"Search recorded...",className:"h-7 pl-8 text-xs w-full",value:D,onChange:e=>L(e.target.value)})]}),s.jsx("h3",{className:"text-sm font-medium dark:text-white",children:"Recorded Defects"}),A>0&&(0,s.jsxs)(u.z,{variant:"ghost",size:"sm",className:"h-7 text-xs px-2 flex items-center gap-1 text-purple-600 dark:text-purple-400",onClick:()=>P(!0),children:[s.jsx("span",{children:"Pending Requests"}),s.jsx("span",{className:"bg-purple-100 text-purple-600 dark:bg-purple-900 dark:text-purple-300 text-xs font-medium px-2 py-0.5 rounded-full",children:A})]})]}),(0,s.jsxs)("div",{className:"flex items-center",children:[x&&s.jsx("span",{className:"mr-2 text-amber-500 animate-pulse",children:s.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:s.jsx("path",{d:"M21 12a9 9 0 1 1-6.219-8.56"})})}),(0,s.jsxs)("span",{className:"text-sm font-medium dark:text-white",children:["Total:"," ",U.reduce((e,t)=>e+t.quantity,0)]})]})]}),y?s.jsx("div",{className:"flex justify-center py-8",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-white"})}):(0,s.jsxs)("div",{className:"space-y-2",children:[U.map(t=>(0,s.jsxs)("div",{className:"border-l-4 border-l-purple-400 bg-purple-50 dark:bg-black dark:border-l-purple-600 p-3 rounded-md shadow-sm transition-all hover:shadow relative",children:[!r&&M?.user?.role?.toLowerCase()!=="viewer"&&a[e]?.isCompleted&&(console.log("Rendering DefectEditRequestPopover for defect:",{id:t.id,name:t.name,category:t.category,machine:t.machine,operationId:a[e]?.operationId,operationDefectId:t.operationDefectId}),(0,s.jsxs)("div",{className:"absolute top-0 right-2 flex items-center",children:[C&&r&&s.jsx(u.z,{variant:"ghost",size:"icon",className:"h-8 w-8 mr-1 text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950/30 dark:text-red-400 dark:hover:text-red-300",onClick:()=>Q(t.id),title:"Delete defect",children:s.jsx(d.Z,{className:"h-4 w-4"})}),s.jsx(c.o,{defect:{id:t.id,name:t.name,operationId:a[e]?.operationId||0,operationDefectId:t.operationDefectId,defectName:t.name,defectCategory:t.category,defectMachine:t.machine,defectReworkable:t.reworkable,quantity:t.quantity,quantityRework:t.quantityRework,quantityNogood:t.quantityNogood},operationCode:e,poNumber:f,onClose:k})]})),C&&(r||!a[e]?.isCompleted)&&!(!r&&a[e]?.isCompleted)&&s.jsx("div",{className:"absolute top-0 right-2",children:s.jsx(u.z,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950/30 dark:text-red-400 dark:hover:text-red-300",onClick:()=>Q(t.id),title:"Delete defect",children:s.jsx(d.Z,{className:"h-4 w-4"})})}),(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row",children:[(0,s.jsxs)("div",{className:"w-full sm:w-1/2 pr-0 sm:pr-3 mb-3 sm:mb-0",children:[(0,s.jsxs)("div",{className:"font-medium flex items-center",children:[s.jsx("span",{className:"w-2 h-2 bg-purple-500 dark:bg-purple-400 rounded-full mr-2 flex-shrink-0"}),(0,s.jsxs)("div",{className:"truncate dark:text-white",children:[t.operationDefectId?`#${t.operationDefectId} - `:"","[",t.id,"] ",t.name]}),r&&t.operationDefectId&&s.jsx("button",{onClick:()=>{j(String(t.operationDefectId)),v(t.name),q(!0)},className:"text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 ml-2 flex-shrink-0 flex items-center",title:"View defect audit log",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-1",children:[s.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),s.jsx("polyline",{points:"14 2 14 8 20 8"}),s.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),s.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),s.jsx("polyline",{points:"10 9 9 9 8 9"})]})})]}),s.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:t.category}),t.machine&&(0,s.jsxs)("div",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:["Machine: ",t.machine]}),!0===t.reworkable&&s.jsx("div",{className:"text-xs text-green-500 dark:text-green-400 mt-1 font-medium",children:"Reworkable"})]}),(0,s.jsxs)("div",{className:`w-full sm:w-1/2 grid ${"op10"===e.toLowerCase()?"grid-cols-4":"grid-cols-3"} gap-2`,children:[(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"QTY"}),s.jsx("div",{className:"flex",children:s.jsx(i.I,{type:"number",min:"0",className:`h-8 border-purple-300 dark:border-purple-700 bg-white dark:bg-black ${!r&&a[e]?.isCompleted?"bg-gray-50 dark:bg-black/70":""}`,value:t.quantity,onChange:e=>b(t.id,"quantity",parseInt(e.target.value)||0),disabled:!r&&a[e]?.isCompleted})})]}),(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"RW"}),s.jsx(i.I,{type:"number",min:"0",className:`h-8 ${t.reworkable?t.quantityRework>0?"border-green-300 dark:border-green-700 bg-white dark:bg-black":"":"bg-gray-100 dark:bg-black/70"} ${!r&&a[e]?.isCompleted?"bg-gray-50 dark:bg-black/70":""}`,value:t.quantityRework,onChange:e=>b(t.id,"quantityRework",parseInt(e.target.value)||0),disabled:!t.reworkable||!r&&a[e]?.isCompleted})]}),(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"NG"}),s.jsx(i.I,{type:"number",min:"0",className:`h-8 ${t.quantityNogood>0?"border-red-300 dark:border-red-700 bg-white dark:bg-black":""} ${t.reworkable?"":"bg-gray-100 dark:bg-black/70"} ${!r&&a[e]?.isCompleted?"bg-gray-50 dark:bg-black/70":""}`,value:t.quantityNogood,onChange:e=>b(t.id,"quantityNogood",parseInt(e.target.value)||0),disabled:!t.reworkable||!r&&a[e]?.isCompleted})]}),"op10"===e.toLowerCase()&&(0,s.jsxs)("div",{children:[s.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"RP"}),s.jsx(i.I,{type:"number",min:"0",max:t.quantity,className:`h-8 border-blue-300 dark:border-blue-700 bg-white dark:bg-black ${!r&&a[e]?.isCompleted?"bg-gray-50 dark:bg-black/70":""}`,value:void 0!==t.quantityReplacement?t.quantityReplacement>t.quantity?t.quantity:t.quantityReplacement:"op10"===e.toLowerCase()?t.quantity:0,onChange:e=>{let r=parseInt(e.target.value)||0,a=Math.min(r,t.quantity);console.log(`RP input: ${r}, Max allowed: ${t.quantity}, Using: ${a}`),b(t.id,"quantityReplacement",a)},disabled:!r&&a[e]?.isCompleted})]})]})]})]},t.id)),0===U.length&&s.jsx("div",{className:"text-center py-6 bg-gray-50 dark:bg-black rounded-md border border-gray-200 dark:border-gray-800",children:(0,s.jsxs)("div",{children:[s.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-2",children:""!==D.trim()?"No defects match your search.":"No defects recorded for this operation."}),s.jsx("p",{className:"text-sm text-gray-400 dark:text-gray-500",children:""!==D.trim()?"Try a different search term.":"Search for defects to add."})]})})]})]})}[i,c,u,p,h]=x.then?(await x)():x,a()}catch(e){a(e)}})},9761:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{$:()=>d});var s=r(20997),o=r(87249),i=r(35037),n=r(41649),l=e([o,i]);function d({activeTab:e,operationStatus:t,operationStatuses:r,rfValue:a,setRfValue:l,defects:d,isAdmin:c,orderData:u,isSubmitting:p,isCompletingOperation:m,isUpdatingDefects:g,showOperationAuditLog:h,showDefectAuditLog:x,setShowOperationAuditLog:y,setShowDefectAuditLog:f,handleStartOperation:b,handleCompleteOperation:k}){console.log(`Rendering OperationInfo for tab: ${e}, status: ${t}`);let{data:w}=(0,n.useSession)();return console.log("User role in OperationInfo:",w?.user?.role),(0,s.jsxs)("div",{className:"bg-gray-50 dark:bg-black p-4 md:p-6 rounded-md",children:[(0,s.jsxs)("h2",{className:"text-lg font-medium mb-4 flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsxs)("span",{className:"dark:text-white",children:["[",r[e]?.operationId,"] Operation Information"]}),r[e]?.isCompleted&&!c&&(0,s.jsxs)("div",{className:"ml-2 bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-300 text-xs px-2 py-1 rounded-md flex items-center",children:[(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-1",children:[s.jsx("rect",{x:"3",y:"11",width:"18",height:"11",rx:"2",ry:"2"}),s.jsx("path",{d:"M7 11V7a5 5 0 0 1 10 0v4"})]}),"View Only"]})]}),s.jsx("span",{className:"text-sm font-normal text-gray-500 dark:text-gray-400",children:t})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6",children:[(0,s.jsxs)("div",{className:"border border-gray-200 dark:border-gray-800 rounded-md p-3 bg-white dark:bg-gray-950",children:[s.jsx("label",{className:"block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1",children:"Start Time"}),s.jsx("div",{className:"text-sm font-medium dark:text-white",children:e&&r[e]?.startTime?new Date(r[e].startTime).toLocaleString():"Not started"})]}),(0,s.jsxs)("div",{className:"border border-gray-200 dark:border-gray-800 rounded-md p-3 bg-white dark:bg-gray-950",children:[s.jsx("label",{className:"block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1",children:r[e]?.endTime?"End Time":"Status"}),s.jsx("div",{className:"text-sm font-medium dark:text-white",children:e&&r[e]?.endTime?new Date(r[e].endTime).toLocaleString():r[e]?.isStarted?"In progress":"Not started"})]}),(0,s.jsxs)("div",{className:"border border-gray-200 dark:border-gray-800 rounded-md p-3 bg-white dark:bg-gray-950",children:[s.jsx("label",{className:"block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1",children:"Input Quantity"}),s.jsx("div",{className:"text-sm font-medium dark:text-white",children:e&&r[e]?.inputQuantity||0})]}),(0,s.jsxs)("div",{className:"border border-gray-200 dark:border-gray-800 rounded-md p-3 bg-white dark:bg-gray-950",children:[(0,s.jsxs)("label",{className:"block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1",children:["Output Quantity",g&&s.jsx("span",{className:"ml-2 inline-block animate-pulse text-amber-500 dark:text-amber-400",children:"Updating..."})]}),s.jsx("div",{className:"text-sm font-medium text-purple-700 dark:text-purple-400",children:e&&r[e]?.isStarted?r[e]?.outputQuantity!==null?r[e]?.outputQuantity:"Calculating...":"-"}),d.filter(e=>e.quantity>0).length>0&&(0,s.jsxs)("div",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Input:"}),s.jsx("span",{children:r[e]?.inputQuantity||0})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Total Defects:"}),s.jsx("span",{children:d.reduce((e,t)=>e+t.quantity,0)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Reworkable:"}),s.jsx("span",{children:d.reduce((e,t)=>e+(t.reworkable?t.quantityRework:0),0)})]}),(0,s.jsxs)("div",{className:"flex justify-between font-medium dark:text-gray-300",children:[s.jsx("span",{children:"Effective Loss:"}),s.jsx("span",{children:d.reduce((e,t)=>e+(t.reworkable?t.quantity-t.quantityRework:t.quantity),0)})]}),(0,s.jsxs)("div",{className:"flex justify-between font-medium text-blue-600 dark:text-blue-400 mt-1",children:[s.jsx("span",{children:"Replacements:"}),s.jsx("span",{children:d.reduce((e,t)=>e+(t.quantityReplacement||0),0)})]})]})]})]}),r[e]?.isStarted&&!r[e]?.isCompleted&&(0,s.jsxs)("div",{className:"border border-gray-200 dark:border-gray-800 rounded-md p-3 bg-white dark:bg-gray-950 col-span-1 sm:col-span-2",children:[s.jsx("label",{className:"block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1",children:"Resource Factor (RF)"}),s.jsx(i.I,{type:"number",min:"1",className:"mb-1 dark:bg-black",value:a,onChange:e=>l(e.target.value),placeholder:"Enter RF value"})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[!r[e]?.startTime&&w?.user?.role?.toLowerCase()!=="viewer"&&s.jsx(o.z,{onClick:b,className:"bg-purple-600 hover:bg-purple-700 dark:bg-purple-700 dark:hover:bg-purple-800 text-white w-full",disabled:p||!c&&u?.status==="completed",children:p?(0,s.jsxs)("div",{className:"flex items-center",children:[s.jsx("span",{className:"animate-spin mr-2",children:"⟳"})," Starting..."]}):"Start Operation"}),r[e]?.isStarted&&!r[e]?.isCompleted&&w?.user?.role?.toLowerCase()!=="viewer"&&s.jsx(o.z,{onClick:k,className:"bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 text-white w-full",disabled:m||!c&&u?.status==="completed",children:"End Operation"}),!c&&r[e]?.isCompleted&&s.jsx("div",{className:"mt-2 text-sm text-amber-600 dark:text-amber-400",children:"Admin access required to edit completed operations"})]}),c&&(0,s.jsxs)("div",{className:"flex items-center justify-between mt-5 pt-4 border-t border-gray-200 dark:border-gray-800",children:[s.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Audit Logs:"}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsxs)("button",{onClick:()=>y(!0),className:"text-xs text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 flex items-center",title:"View Operation Audit Logs",children:[(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-1",children:[s.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),s.jsx("polyline",{points:"14 2 14 8 20 8"}),s.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),s.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),s.jsx("polyline",{points:"10 9 9 9 8 9"})]}),"Operation"]}),(0,s.jsxs)("button",{onClick:()=>f(!0),className:"text-xs text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 flex items-center",title:"View Defect Audit Logs",children:[(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-1",children:[s.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),s.jsx("polyline",{points:"14 2 14 8 20 8"}),s.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),s.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),s.jsx("polyline",{points:"10 9 9 9 8 9"})]}),"Defects"]})]})]})]})}[o,i]=l.then?(await l)():l,a()}catch(e){a(e)}})},78535:(e,t,r)=>{r.d(t,{v:()=>s});var a=r(20997);function s({operationSteps:e,activeTab:t,operationStatuses:r,isAdmin:s,handleTabChange:o}){return console.log(`Rendering OperationTabs with ${e.length} steps, activeTab: ${t}`),a.jsx("div",{className:"w-full bg-gray-100 dark:bg-gray-800 rounded-lg p-1",children:a.jsx("div",{className:"grid w-full gap-1",style:{gridTemplateColumns:`repeat(${e.length||5}, 1fr)`},children:e.length>0?e.map((i,n)=>{let l=i.code.toLowerCase(),d=r[l],c=n>0&&!d?.isStarted&&!d?.isCompleted&&e[n-1]&&!r[e[n-1].code.toLowerCase()]?.isCompleted,u=t===l;return(0,a.jsxs)("button",{onClick:()=>!c&&o(i.code.toLowerCase()),disabled:c,className:`relative h-10 flex items-center justify-center rounded-md transition-all ${d?.isCompleted?"bg-green-500 dark:bg-green-600 text-white":d?.isStarted?"bg-blue-500 dark:bg-blue-600 text-white":u?"bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm":"bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-500"} ${u?"ring-2 ring-purple-500 dark:ring-purple-400 ring-offset-1 dark:ring-offset-gray-800":""} ${c?"opacity-50 cursor-not-allowed":""}`,children:[(0,a.jsxs)("div",{className:"hidden md:flex items-center gap-1",children:[d?.isCompleted&&a.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-white",children:a.jsx("path",{d:"M20 6L9 17l-5-5"})}),d?.isStarted&&!d?.isCompleted&&(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-white animate-pulse",children:[a.jsx("circle",{cx:"12",cy:"12",r:"10"}),a.jsx("path",{d:"M12 6v6l4 2"})]}),a.jsx("span",{children:i.name}),d?.isCompleted&&!s&&(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-yellow-300 dark:text-yellow-200 ml-1",children:[a.jsx("rect",{x:"3",y:"11",width:"18",height:"11",rx:"2",ry:"2"}),a.jsx("path",{d:"M7 11V7a5 5 0 0 1 10 0v4"})]})]}),(0,a.jsxs)("div",{className:"md:hidden flex flex-col items-center text-xs",children:[a.jsx("span",{children:i.code}),d?.isCompleted&&!s&&(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-yellow-300 dark:text-yellow-200 mt-1",children:[a.jsx("rect",{x:"3",y:"11",width:"18",height:"11",rx:"2",ry:"2"}),a.jsx("path",{d:"M7 11V7a5 5 0 0 1 10 0v4"})]})]}),n<e.length-1&&a.jsx("div",{className:"absolute -right-2 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 md:block hidden z-10",children:"→"})]},i.code)}):a.jsx("div",{className:"col-span-5 bg-gray-50 dark:bg-gray-800 py-2 flex items-center justify-center dark:text-gray-300",children:"Loading..."})})})}},8597:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{k:()=>l});var s=r(20997),o=r(87249),i=r(35037),n=e([o,i]);function l({poNumber:e,formData:t,handleChange:r,handleUpdate:a,isSubmitting:n,isAdmin:l,session:d,orderData:c}){return console.log(`Rendering OrderDetailsForm for PO: ${e}`),s.jsx("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow p-4 mb-6",children:(0,s.jsxs)("div",{className:"flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4",children:[(0,s.jsxs)("div",{className:"w-full md:w-1/6",children:[s.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"PO Number"}),s.jsx(i.I,{value:e,disabled:!0,className:"bg-gray-50 dark:bg-gray-900 dark:text-white h-8 text-sm"})]}),(0,s.jsxs)("div",{className:"w-full md:w-1/6",children:[s.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"Lot Number"}),s.jsx(i.I,{name:"lotNumber",value:t.lotNumber,onChange:r,disabled:!l,className:`h-8 text-sm ${l?"":"bg-gray-50"}`})]}),(0,s.jsxs)("div",{className:"w-full md:w-1/6",children:[s.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"Status"}),s.jsx(i.I,{value:c?.status||"CREATED",disabled:!0,className:"bg-gray-50 h-8 text-sm"})]}),(0,s.jsxs)("div",{className:"w-full md:w-1/6",children:[s.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"Quantity"}),s.jsx(i.I,{name:"quantity",type:"number",min:"1",value:t.quantity,onChange:r,disabled:!l,className:`h-8 text-sm ${l?"":"bg-gray-50"}`})]}),(0,s.jsxs)("div",{className:"w-full md:w-1/6",children:[s.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"Item Name"}),s.jsx(i.I,{name:"itemName",value:t.itemName,onChange:r,disabled:!l,className:`h-8 text-sm ${l?"":"bg-gray-50"}`})]}),(0,s.jsxs)("div",{className:"w-full md:w-1/6",children:[s.jsx("label",{className:"block text-xs font-medium text-gray-600 invisible",children:"Action"}),s.jsx(o.z,{className:"bg-purple-600 hover:bg-purple-700 text-white h-8 w-full",onClick:a,disabled:n||!d||!d.user||!l,children:n?"Saving...":l?"Save":"View Only"})]})]})})}[o,i]=n.then?(await n)():n,a()}catch(e){a(e)}})},20056:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{x:()=>u});var s=r(20997),o=r(16689),i=r(35037),n=r(87764),l=r(82477),d=r(41649),c=e([i,l]);function u({activeTab:e,masterDefects:t,isAdmin:r,operationStatuses:a,isLoading:c,handleAddDefect:u,existingDefects:p=[],poNumber:m,refreshDefectsForOperationCallback:g}){let[h,x]=(0,o.useState)(""),[y,f]=(0,o.useState)(null),[b,k]=(0,o.useState)(!1),{data:w}=(0,d.useSession)();console.log(`Rendering SearchMasterDefectsList for tab: ${e}, defects count: ${t.length}, existing defects: ${p.length}`),console.log("User role:",w?.user?.role);let N=a[e]?.operationId,j=a[e]?.isCompleted,v=a[e]?.isStarted,q=p.filter(e=>e.operationId===N).map(e=>String(e.defectId));console.log(`Operation ID: ${N}, Existing defect IDs: ${q.join(", ")}`),console.log(`Operation completed: ${j}, Operation started: ${v}, Is admin: ${r}`);let C=e=>{console.log(`Selected defect from search: ${e.name}`),!r&&j?(f(e),k(!0)):u(e.id),x("")};return(0,s.jsxs)("div",{className:"mb-1",children:[y&&s.jsx(l.Z,{open:b,onClose:()=>{k(!1),f(null),g&&g()},defect:y,operationId:N,operationCode:e,poNumber:"string"==typeof m?m:Array.isArray(m)?m[0]:""}),(0,s.jsxs)("div",{className:"relative w-full",children:[s.jsx(n.Z,{className:"absolute left-2 top-2.5 h-4 w-4 text-gray-500 dark:text-gray-400"}),s.jsx(i.I,{type:"search",placeholder:v?"Search master defects...":"Start operation to search master defects",className:"pl-8",value:h,onChange:e=>x(e.target.value),disabled:!v||w?.user?.role?.toLowerCase()==="viewer"}),h&&s.jsx("div",{className:"absolute z-10 w-full bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-md shadow-lg mt-1 max-h-80 overflow-y-auto",children:c?s.jsx("div",{className:"flex justify-center py-4",children:s.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900 dark:border-white"})}):(0,s.jsxs)(s.Fragment,{children:[t.filter(e=>(e.name.toLowerCase().includes(h.toLowerCase())||e.category.toLowerCase().includes(h.toLowerCase()))&&!q.includes(String(e.id))).map(e=>(0,s.jsxs)("div",{className:"p-3 border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-900 cursor-pointer",onClick:()=>C(e),children:[(0,s.jsxs)("div",{className:"font-medium dark:text-white",children:["[",e.id,"] ",e.name]}),(0,s.jsxs)("div",{className:"flex justify-between text-xs text-gray-500 dark:text-gray-400",children:[s.jsx("span",{children:e.category}),e.machine&&(0,s.jsxs)("span",{children:["Machine: ",e.machine]})]}),e.reworkable&&s.jsx("div",{className:"text-xs text-green-500 dark:text-green-400 mt-1",children:"Reworkable"}),!r&&j&&s.jsx("div",{className:"text-xs text-blue-500 dark:text-blue-400 mt-1",children:"+ Request to add"})]},e.id)),0===t.filter(e=>(e.name.toLowerCase().includes(h.toLowerCase())||e.category.toLowerCase().includes(h.toLowerCase()))&&!q.includes(String(e.id))).length&&(0,s.jsxs)("div",{className:"p-3 text-center text-gray-500 dark:text-gray-400",children:['No defects found matching "',h,'"']})]})})]})]})}[i,l]=c.then?(await c)():c,a()}catch(e){a(e)}})},6655:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{$0:()=>y,Dj:()=>f,dN:()=>x,kN:()=>h,ng:()=>m,nt:()=>g,tl:()=>p});var s=r(20997),o=r(16689),i=r(98814),n=r(64998),l=r(36467),d=r(32676),c=r(87249),u=e([d,c]);[d,c]=u.then?(await u)():u;let p=({className:e,...t})=>s.jsx("nav",{role:"navigation","aria-label":"pagination",className:(0,d.cn)("mx-auto flex w-full justify-center",e),...t});p.displayName="Pagination";let m=o.forwardRef(({className:e,...t},r)=>s.jsx("ul",{ref:r,className:(0,d.cn)("flex flex-row items-center gap-1",e),...t}));m.displayName="PaginationContent";let g=o.forwardRef(({className:e,...t},r)=>s.jsx("li",{ref:r,className:(0,d.cn)("",e),...t}));g.displayName="PaginationItem";let h=({className:e,isActive:t,size:r="icon",...a})=>s.jsx("a",{"aria-current":t?"page":void 0,className:(0,d.cn)((0,c.d)({variant:t?"outline":"ghost",size:r}),t&&"pointer-events-none",e),...a});h.displayName="PaginationLink";let x=({className:e,...t})=>(0,s.jsxs)(h,{"aria-label":"Go to previous page",size:"default",className:(0,d.cn)("gap-1 pl-2.5",e),...t,children:[s.jsx(i.Z,{className:"h-4 w-4"}),s.jsx("span",{children:"Previous"})]});x.displayName="PaginationPrevious";let y=({className:e,...t})=>(0,s.jsxs)(h,{"aria-label":"Go to next page",size:"default",className:(0,d.cn)("gap-1 pr-2.5",e),...t,children:[s.jsx("span",{children:"Next"}),s.jsx(n.Z,{className:"h-4 w-4"})]});y.displayName="PaginationNext";let f=({className:e,...t})=>(0,s.jsxs)("span",{"aria-hidden":!0,className:(0,d.cn)("flex h-9 w-9 items-center justify-center",e),...t,children:[s.jsx(l.Z,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"More pages"})]});f.displayName="PaginationEllipsis",a()}catch(e){a(e)}})},41310:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{J2:()=>d,xo:()=>c,yk:()=>u});var s=r(20997),o=r(16689),i=r(98680),n=r(32676),l=e([i,n]);[i,n]=l.then?(await l)():l;let d=i.Root,c=i.Trigger,u=o.forwardRef(({className:e,align:t="center",sideOffset:r=4,...a},o)=>s.jsx(i.Portal,{children:s.jsx(i.Content,{ref:o,align:t,sideOffset:r,className:(0,n.cn)("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e),...a})}));u.displayName=i.Content.displayName,a()}catch(e){a(e)}})},21989:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{RM:()=>d,SC:()=>c,iA:()=>n,pj:()=>p,ss:()=>u,xD:()=>l});var s=r(20997);r(16689);var o=r(32676),i=e([o]);function n({className:e,...t}){return s.jsx("div",{"data-slot":"table-container",className:"relative w-full overflow-x-auto",children:s.jsx("table",{"data-slot":"table",className:(0,o.cn)("w-full caption-bottom text-sm",e),...t})})}function l({className:e,...t}){return s.jsx("thead",{"data-slot":"table-header",className:(0,o.cn)("[&_tr]:border-b",e),...t})}function d({className:e,...t}){return s.jsx("tbody",{"data-slot":"table-body",className:(0,o.cn)("[&_tr:last-child]:border-0",e),...t})}function c({className:e,...t}){return s.jsx("tr",{"data-slot":"table-row",className:(0,o.cn)("hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",e),...t})}function u({className:e,...t}){return s.jsx("th",{"data-slot":"table-head",className:(0,o.cn)("text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",e),...t})}function p({className:e,...t}){return s.jsx("td",{"data-slot":"table-cell",className:(0,o.cn)("p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",e),...t})}o=(i.then?(await i)():i)[0],a()}catch(e){a(e)}})},53355:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{SP:()=>u,dr:()=>c,mQ:()=>d,nU:()=>p});var s=r(20997),o=r(16689),i=r(6860),n=r(32676),l=e([i,n]);[i,n]=l.then?(await l)():l;let d=i.Root,c=o.forwardRef(({className:e,...t},r)=>s.jsx(i.List,{ref:r,className:(0,n.cn)("inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",e),...t}));c.displayName=i.List.displayName;let u=o.forwardRef(({className:e,...t},r)=>s.jsx(i.Trigger,{ref:r,className:(0,n.cn)("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-blue-500 data-[state=active]:text-white data-[state=active]:shadow",e),...t}));u.displayName=i.Trigger.displayName;let p=o.forwardRef(({className:e,...t},r)=>s.jsx(i.Content,{ref:r,className:(0,n.cn)("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",e),...t}));p.displayName=i.Content.displayName,a()}catch(e){a(e)}})},65765:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{g:()=>l});var s=r(20997),o=r(16689),i=r(32676),n=e([i]);i=(n.then?(await n)():n)[0];let l=o.forwardRef(({className:e,...t},r)=>s.jsx("textarea",{className:(0,i.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",e),ref:r,...t}));l.displayName="Textarea",a()}catch(e){a(e)}})},46317:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>I,getServerSideProps:()=>T});var s=r(20997),o=r(16689),i=r(87249),n=r(11163),l=r(45847),d=r(40968),c=r.n(d),u=r(53355),p=r(17344),m=r(65050),g=r(93908),h=r.n(g),x=r(41649),y=r(33566),f=r(2577),b=r(30346),k=r(87942),w=r(9761),N=r(99419),j=r(20056),v=r(32832),q=r(8597),C=r(78535),R=r(45977),S=e([i,l,u,y,f,w,N,j,v,q]);[i,l,u,y,f,w,N,j,v,q]=S.then?(await S)():S;let $=0;function I({initialOrderData:e,initialError:t,initialErrorStatus:r,poNumberFromServer:a}){console.log("RENDER: ProductionOrderDetails component rendering with initialData:",!!e),$++,console.log("RENDER COUNT: #"+$);let{data:d}=(0,x.useSession)(),u=d?.user?.role||"unknown",p="admin"===u.toLowerCase();console.log("RENDER: User role:",u,"isAdmin:",p);let m=(0,n.useRouter)(),g=a||m.query.poNumber,[h,f]=(0,o.useState)(!0),[k,w]=(0,o.useState)(!1),[N,j]=(0,o.useState)(!1),[v,q]=(0,o.useState)(null),[C,S]=(0,o.useState)(!1),I=(0,o.useCallback)(async()=>{if(!g||!d?.user?.id)return!1;if(d?.user?.role?.toLowerCase()==="viewer")return console.log("Viewer role detected, bypassing lock acquisition"),f(!1),!0;try{f(!0),console.log(`Attempting to acquire lock for: ${g}`);let e=await fetch("/api/locks/acquire",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({resourceType:"productionOrder",resourceId:g})}),t=await e.json();if(console.log("Lock acquisition response:",t),e.ok&&t.success)return w(!0),j(!0),q(t.lockInfo),!0;if(423===e.status)return w(!0),j(!1),q(t.lockInfo),!1;return console.error("Lock acquisition failed:",t.error),!1}catch(e){return console.error("Error acquiring lock:",e),!1}finally{f(!1)}},[g,d?.user?.id,d?.user?.role]),T=(0,o.useCallback)(async()=>{if(g)try{S(!0);let e=await fetch("/api/locks/release",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({resourceType:"productionOrder",resourceId:g})}),t=await e.json();e.ok&&t.success?m.push("/production-orders"):console.error("Failed to release lock:",t.error)}catch(e){console.error("Error releasing lock:",e)}finally{S(!1)}},[g,m]),D=(0,o.useCallback)(async()=>{if(g&&p)try{S(!0);let e=await fetch("/api/locks/force-release",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({resourceType:"productionOrder",resourceId:g})}),t=await e.json();e.ok&&t.success?await I()?window.location.reload():m.push("/production-orders"):console.error("Failed to force release lock:",t.error)}catch(e){console.error("Error force releasing lock:",e)}finally{S(!1)}},[g,p,I,m]);return((0,o.useEffect)(()=>{g&&d?.user?.id&&I()},[g,d?.user?.id,I]),!k||N||h||d?.user?.role?.toLowerCase()==="viewer")?h?(0,s.jsxs)(s.Fragment,{children:[s.jsx(c(),{children:s.jsx("title",{children:`P-Chart System - Production Order ${g}`})}),s.jsx(l.Z,{children:(0,s.jsxs)("div",{className:"py-6",children:[s.jsx(y.Z,{title:`Production Order - ${g}`,description:"Loading..."}),s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"})})]})})]}):(console.log("RENDER: Rendering full order details"),s.jsx(b.y,{children:s.jsx(E,{initialOrderData:e,initialError:t,initialErrorStatus:r,poNumberFromServer:a,onReleaseLock:T,isReleasingLock:C})})):(0,s.jsxs)(s.Fragment,{children:[s.jsx(c(),{children:s.jsx("title",{children:`P-Chart System - Production Order ${g} (Locked)`})}),s.jsx(l.Z,{children:(0,s.jsxs)("div",{className:"py-6",children:[s.jsx(y.Z,{title:`Production Order ${g} (Locked)`,description:"This production order is currently locked by another user."}),s.jsx("div",{className:"bg-white dark:bg-black p-6 rounded-lg shadow mb-4",children:s.jsx("div",{className:"border-l-4 border-amber-500 p-4 bg-amber-50 dark:bg-gray-900 mb-4",children:(0,s.jsxs)("div",{className:"flex items-start",children:[s.jsx("div",{className:"mr-2 text-amber-500",children:s.jsx(R.Z,{className:"h-6 w-6"})}),(0,s.jsxs)("div",{children:[s.jsx("h3",{className:"text-amber-800 font-semibold",children:"This production order is currently locked"}),s.jsx("p",{className:"text-amber-700 mt-1",children:v?`This production order is being edited by ${v.userName} since ${new Date(v.lockedAt).toLocaleString()}`:"This production order is currently locked by another user."}),(0,s.jsxs)("div",{className:"mt-3 flex space-x-2",children:[s.jsx(i.z,{variant:"outline",onClick:()=>m.push("/production-orders"),children:"Return to List"}),p&&s.jsx(i.z,{variant:"destructive",onClick:D,disabled:C,children:C?"Releasing...":"Force Release Lock"})]})]})]})})})]})})]})}function E({initialOrderData:e,initialError:t,initialErrorStatus:r,poNumberFromServer:a,onReleaseLock:d,isReleasingLock:g}){let b=(0,o.useRef)(!1),{isAuthorized:k,authError:R,getAuthHeaders:S,checkResponseAuth:I}=(0,p.a)(),{data:E}=(0,x.useSession)(),$=E?.user?.role?.toLowerCase()==="admin";console.log("AUTH: User role:",E?.user?.role,"Is admin?",$);let{toast:T}=(0,m.pm)(),D=(0,n.useRouter)(),{newOrder:L}=D.query,O=a||D.query.poNumber,[P,A]=(0,o.useState)(""),[F,M]=(0,o.useState)(""),[Z,U]=(0,o.useState)("Not Started"),[z,Q]=(0,o.useState)(t||null),[V,G]=(0,o.useState)(e||null),[B,H]=(0,o.useState)(!1),[J,W]=(0,o.useState)([]),[Y,_]=(0,o.useState)([]),[K,X]=(0,o.useState)({lotNumber:"",quantity:"",itemName:""}),[ee,et]=(0,o.useState)({}),[er,ea]=(0,o.useState)(!1),[es,eo]=(0,o.useState)("1"),[ei,en]=(0,o.useState)(!1),[el,ed]=(0,o.useState)(!1),[ec,eu]=(0,o.useState)(!1),[ep,em]=(0,o.useState)(""),[eg,eh]=(0,o.useState)(""),[ex,ey]=(0,o.useState)(!1),[ef,eb]=(0,o.useState)(!1),[ek,ew]=(0,o.useState)(!1),[eN,ej]=(0,o.useState)(!!e),[ev,eq]=(0,o.useState)("string"==typeof O?O:""),[eC,eR]=(0,o.useState)(null),[eS,eI]=(0,o.useState)(!1),[eE,e$]=(0,o.useState)(null),[eT,eD]=(0,o.useState)(null),[eL,eO]=(0,o.useState)([]),[eP,eA]=(0,o.useState)(!1),eF=(0,o.useCallback)(async()=>{if(b.current){console.log("Already performed initial data load, skipping redundant fetch");return}if(e){console.log("Initial order data provided, skipping API fetch"),G(e),ej(!0),"string"==typeof O&&eq(O),b.current=!0;return}if(!O||"string"!=typeof O){console.log("No valid poNumber available, skipping fetch");return}Q(null),console.log("Fetching production order:",O);try{b.current=!0;let e=await fetch(`/api/production-orders/${O}`,{headers:S()});if(!I(e)){console.log("Response checking failed, aborting fetch"),b.current=!1;return}if(!e.ok){b.current=!1;try{let t=await e.clone().json();throw console.error("DIAGNOSTIC: Production order API error response data:",t),Error(t.error||"Failed to fetch production order")}catch(t){console.error("DIAGNOSTIC: Could not parse JSON error response");try{let t=await e.text();throw console.error("DIAGNOSTIC: Raw error response:",t.substring(0,500)),Error(`Failed to fetch production order: Response is not JSON. Status: ${e.status}`)}catch(t){throw console.error("DIAGNOSTIC: Error parsing response as text:",t),Error(`Failed to fetch production order: ${e.status}`)}}}let t=await e.json();console.log("Production order fetched:",t),G(t),ej(!0),"string"==typeof O&&eq(O)}catch(e){if(console.error("DIAGNOSTIC ERROR in fetchProductionOrder:",e),console.error("DIAGNOSTIC ERROR details:",e),b.current=!1,e instanceof TypeError&&e.message.includes("fetch")){console.error("Network error detected - unable to reach server"),T({title:"Network Error",description:"Unable to connect to the server. Please check your connection.",variant:"destructive"});return}Q(e instanceof Error?e.message:"An unknown error occurred"),T({title:"Error",description:e instanceof Error?e.message:"Failed to fetch production order",variant:"destructive"})}},[S,O,T,I,e]),eM=(0,o.useCallback)(async(e,t=!1)=>{if(!e||"string"!=typeof e){console.log("Invalid operation code, skipping defects fetch");return}if(eC===e&&!t){console.log(`Already fetched defects for ${e}, skipping redundant fetch`);return}if(!O||"string"!=typeof O){console.log("No valid poNumber available yet, will try again when it is available");return}t||eR(e);try{if(await new Promise(e=>setTimeout(e,0)),eC===e&&!t){console.log(`After timeout check: already fetched defects for ${e}, skipping redundant fetch`);return}console.log(`Fetching defects for operation: ${e}, PO: ${O}`),eA(!0);let r=await fetch(`/api/defects?operation=${e}&poNumber=${O}&active=true`,{headers:S()});if(!I(r)){console.log("Response checking failed, aborting defects fetch"),eA(!1),t||eR(null);return}if(!r.ok){let e=await r.json();throw eA(!1),t||eR(null),Error(e.error||"Failed to fetch defects")}let a=await r.json();console.log(`Fetched ${a.data.length} master defects for operation ${e}`),eO(a.data||[]),eA(!1);let s=ee[e]?.operationId;if(s){let t;console.log(`Fetching recorded defects for operation ID: ${s}`);let r=await fetch("/api/operation-defects/list",{method:"POST",headers:{...S(),"Content-Type":"application/json"},body:JSON.stringify({operationId:s})});if(!I(r)){console.log("Response checking failed, aborting operation defects fetch");return}if(!r.ok){let e=await r.json();throw Error(e.error||"Failed to fetch operation defects")}try{t=await r.json(),console.log(`Fetched ${t.data?.length||0} recorded defects for operation ${e}`),t.data&&t.data.length>0&&console.log("First operation defect structure:",JSON.stringify(t.data[0],null,2));let s=a.data.map(e=>{let r=t.data?.find(t=>parseInt(t.defectId)===parseInt(e.id));return r?(console.log(`Found recorded defect: ${e.name} with quantity ${r.quantity}`),{...e,quantity:r.quantity||0,quantityRework:r.quantityRework||0,quantityNogood:r.quantityNogood||0,quantityReplacement:r.quantityReplacement||0,operationDefectId:r.id||null}):{...e,quantity:0,quantityRework:0,quantityNogood:0,quantityReplacement:0,operationDefectId:null}}),o=s.filter(e=>e.quantity>0);console.log("Defects with quantity > 0:",o.map(e=>({id:e.id,name:e.name,quantity:e.quantity}))),_(s),eR(e)}catch(t){console.error("Failed to parse operation defects response:",t),_(a.data.map(e=>({...e,quantity:0,quantityRework:0,quantityNogood:0,quantityReplacement:0,operationDefectId:null}))),eR(e)}}else console.log("No operation ID available, using master defects list only"),_(a.data.map(e=>({...e,quantity:0,quantityRework:0,quantityNogood:0,quantityReplacement:0,operationDefectId:null}))),eR(e)}catch(t){console.error("Error fetching defects:",t);let e=t instanceof Error?t.message:"An unknown error occurred";T({title:"Error",description:`Failed to load defects: ${e}`,variant:"destructive"}),_([]),eO([]),eA(!1)}},[S,eC,ee,O,T,I]),eZ=(0,o.useCallback)(async e=>{console.log(`Tab changing from ${F} to ${e}`);try{if(F===e){console.log("Tab already active, skipping change");return}if(M(e),console.log(`Operation status for ${e}:`,ee[e]),eC===e){console.log(`Tab ${e} already has defects loaded, skipping fetch`);return}if(!O||"string"!=typeof O){console.log("PO number not available yet, will fetch defects when it becomes available");return}console.log(`Loading defects for newly selected tab ${e}`),await eM(e,!0)}catch(e){console.error("Error in handleTabChange:",e),T({title:"Error",description:`Tab change error: ${e instanceof Error?e.message:"Unknown error"}`,variant:"destructive"})}},[F,eM,eC,ee,O,T]),eU=(0,o.useCallback)(async()=>{if(!(!O||!F||ee[F]?.isStarted))try{console.log(`Starting operation ${F} for PO: ${O}`),H(!0);let e=await fetch("/api/operations/start",{method:"POST",headers:{...S(),"Content-Type":"application/json"},body:JSON.stringify({poNumber:O,operationCode:F})});if(!I(e)){console.log("Response checking failed, aborting operation start"),H(!1);return}if(!e.ok){let t=await e.json();throw Error(t.error||"Failed to start operation")}let t=await e.json();G(t),U("In Progress"),T({title:"Success",description:`${F.toUpperCase()} operation started successfully!`})}catch(t){console.error("Error starting operation:",t);let e=t instanceof Error?t.message:"An unknown error occurred";T({title:"Error",description:e,variant:"destructive"})}finally{H(!1)}},[F,S,ee,O,T]),ez=(0,o.useCallback)(async()=>{if(!$&&ee[F]?.isCompleted){console.log("Non-admin user tried to edit a completed operation"),T({title:"Permission Denied",description:"Only admin users can edit completed operations",variant:"destructive"});return}!O||!F||!ee[F]?.isStarted||ee[F]?.isCompleted||ey(!0)},[F,$,ee,O,T]),eQ=(0,o.useCallback)(async()=>{if(b.current){console.log("Already fetched operation steps, skipping");return}try{console.log("DIAGNOSTIC: Starting fetchOperationStepsApi call");try{let e=await fetch("/api/operation-steps",{headers:S()});if(!I(e)){console.log("Response checking failed, aborting fetch");return}if(!e.ok){console.error("DIAGNOSTIC: API call to fetch operation steps failed",{status:e.status,statusText:e.statusText});try{let t=await e.json();throw console.error("DIAGNOSTIC: Operation steps API error response data:",t),Error(t.error||"Failed to fetch operation steps")}catch(t){console.error("DIAGNOSTIC: Could not parse JSON error response");try{let t=await e.text();throw console.error("DIAGNOSTIC: Raw error response:",t.substring(0,500)),Error(`Failed to fetch operation steps: Response is not JSON. Status: ${e.status}`)}catch(t){throw console.error("DIAGNOSTIC: Error parsing response as text:",t),Error(`Failed to fetch operation steps: ${e.status} ${e.statusText}`)}}}let t=await e.json();console.log("DIAGNOSTIC: fetchOperationStepsApi succeeded"),console.log("Operation steps fetched:",t),W(t),b.current=!0}catch(e){if(console.error("DIAGNOSTIC ERROR in fetchOperationStepsApi:",e),console.error("DIAGNOSTIC ERROR details:",{message:e.message,stack:e.stack,name:e.name}),e.message&&e.message.includes("JSON")&&(console.error("DIAGNOSTIC: JSON parsing error detected in fetchOperationStepsApi"),e.response))try{let t=await e.response.text();console.error("DIAGNOSTIC: Raw response body:",t.substring(0,500))}catch(e){console.error("DIAGNOSTIC: Could not read raw response:",e)}throw e}}catch(e){console.error("Error fetching operation steps:",e),Q("Failed to fetch operation steps")}},[S,T,I]),eV=(0,o.useCallback)(h()(async e=>{if(O&&F){console.log(`Sending defect update to server: ${e.name}, quantity: ${e.quantity}`),en(!0);try{let t=await fetch("/api/operation-defects",{method:"POST",headers:{...S(),"Content-Type":"application/json"},body:JSON.stringify({poNumber:O,operationCode:F,defect:e})});if(!I(t)){console.log("Response checking failed, aborting defect update"),en(!1);return}if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to update defect")}let r=await t.json();console.log("Defect update successful, updated order:",r),G(r);let a={};J.forEach(e=>{a[e.code.toLowerCase()]={isStarted:!1,isCompleted:!1,inputQuantity:0,outputQuantity:null,startTime:null,endTime:null}}),r.operations.forEach(e=>{a[e.operation.toLowerCase()]={isStarted:!!e.startTime,isCompleted:!!e.endTime,inputQuantity:e.inputQuantity,outputQuantity:e.outputQuantity,startTime:e.startTime?new Date(e.startTime):null,endTime:e.endTime?new Date(e.endTime):null,operationId:e.id}}),et(a),eR(F)}catch(t){console.error("Error updating defect:",t);let e=t instanceof Error?t.message:"An unknown error occurred";T({title:"Error",description:e,variant:"destructive"})}finally{en(!1)}}},500),[F,S,J,O,T,I]),eG=(0,o.useCallback)((e,t,r)=>{if(!$&&ee[F]?.isCompleted){console.log("Non-admin user tried to edit a completed operation defect"),T({title:"Permission Denied",description:"Only admin users can edit completed operations",variant:"destructive"});return}let a=Math.max(0,r);_(r=>r.map(r=>{if(r.id===e){let e={...r};if("quantity"===t&&(e.quantity=a,e.quantityNogood=a,e.quantityRework=0,"op10"===F.toLowerCase()&&(e.quantityReplacement=a),console.log(`QTY updated: QTY=${a}, NG=${a}, RW=0${"op10"===F.toLowerCase()?`, RP=${a}`:""}`)),"quantityNogood"===t){let t=Math.min(a,r.quantity);e.quantityNogood=t,e.quantityRework=r.quantity-t,console.log(`NG updated: QTY=${r.quantity}, NG=${t}, RW=${e.quantityRework}`)}if("quantityRework"===t){let t=Math.min(a,r.quantity);e.quantityRework=t,e.quantityNogood=r.quantity-t,console.log(`RW updated: QTY=${r.quantity}, NG=${e.quantityNogood}, RW=${t}`)}return"quantityReplacement"===t&&("op10"===F.toLowerCase()?(e.quantityReplacement=a,console.log(`RP updated: RP=${a}`)):(e.quantityReplacement=0,console.log("RP update ignored for non-OP10 operation"))),F&&ee[F]?.isStarted&&eV(e),e}return r}))},[F,$,ee,eV,T]),eB=(0,o.useCallback)(e=>{let{name:t,value:r}=e.target;X({...K,[t]:r})},[K]),eH=(0,o.useCallback)(async()=>{if(!$){console.log("Non-admin user tried to edit a production order"),T({title:"Permission Denied",description:"Only admin users can edit production orders",variant:"destructive"});return}if(O&&V){H(!0),Q(null);try{let e=await fetch(`/api/production-orders/${O}`,{method:"PUT",headers:{...S(),"Content-Type":"application/json"},body:JSON.stringify({lotNumber:K.lotNumber,quantity:K.quantity,itemName:K.itemName})});if(!I(e)){console.log("Response checking failed, aborting order update"),H(!1);return}if(!e.ok){let t=await e.json();throw Error(t.error||"Failed to update production order")}let t=await e.json();G(t),T({title:"Success",description:"Production order updated successfully!"})}catch(t){console.error("Error updating production order:",t);let e=t instanceof Error?t.message:"An unknown error occurred";Q(e),T({title:"Error",description:e,variant:"destructive"})}finally{H(!1)}}},[K,S,$,V,O,T]),eJ=(0,o.useCallback)(async e=>{if(!$&&ee[F]?.isCompleted){console.log("Non-admin user tried to add a defect to a completed operation"),T({title:"Permission Denied",description:"Only admin users can edit completed operations",variant:"destructive"});return}if(!O||!F||!ee[F]?.isStarted){T({title:"Operation Not Started",description:"Please start the operation before adding defects",variant:"destructive"});return}try{console.log(`Adding defect ${e} to operation ${F}`),en(!0);let t=eL.find(t=>t.id===e);if(!t)throw Error("Defect not found in master list");let r={...t,quantity:1,quantityRework:0,quantityNogood:1},a=await fetch("/api/operation-defects",{method:"POST",headers:{...S(),"Content-Type":"application/json"},body:JSON.stringify({poNumber:O,operationCode:F,defect:r})});if(!I(a)){console.log("Response checking failed, aborting defect add"),en(!1);return}if(!a.ok){let e=await a.json();throw Error(e.error||"Failed to add defect")}let s=await a.json();console.log("Defect added successfully, updated order:",s),G(s),await eM(F,!0),T({title:"Success",description:`Added ${t.name} to operation`})}catch(t){console.error("Error adding defect:",t);let e=t instanceof Error?t.message:"An unknown error occurred";T({title:"Error",description:e,variant:"destructive"})}finally{en(!1)}},[F,eM,S,$,eL,ee,O,T,I]),eW=(0,o.useCallback)(()=>{console.log("refreshDefectsForOperationCallback called")},[]);(0,o.useEffect)(()=>(console.log("EFFECT: fetchOperationSteps effect running"),eQ(),()=>console.log("EFFECT: fetchOperationSteps cleanup")),[eQ]),(0,o.useEffect)(()=>(console.log("EFFECT: Initial tab setting effect",{operationStepsLength:J.length,activeTab:F}),J.length>0&&!F&&(console.log("EFFECT: Initial tab setting to:",J[0].code.toLowerCase()),M(J[0].code.toLowerCase())),()=>console.log("EFFECT: Initial tab setting cleanup")),[J,F]),(0,o.useEffect)(()=>(console.log("EFFECT: Defect loading check effect",{activeTab:F,lastFetchedTab:eC,poNumber:O}),F&&eC!==F&&O?(console.log("EFFECT: Initial defect load triggered for active tab:",F),O&&"string"==typeof O&&(console.log("EFFECT: Triggering initial defect load for tab:",F),eM(F,!0))):console.log("EFFECT: Skipping defect load:",{activeTab:F,lastFetchedTab:eC,havePoNumber:!!O&&"string"==typeof O}),()=>console.log("EFFECT: Defect loading check cleanup")),[F,eM,eC,O]),(0,o.useEffect)(()=>{if(V&&(console.log("OrderData updated",V),X({lotNumber:V.lotNumber||"",quantity:V.poQuantity.toString(),itemName:V.itemName||""}),V.operations&&V.currentOperation)){let e=localStorage.getItem("lastUpdateType");if((!F||!e||"pageLoad"===e)&&!eC){let e=V.currentOperation.toLowerCase();console.log("Setting active tab to current operation:",e),M(e),console.log("INIT PAGE LOAD - Will trigger defect load for",e)}}},[V,F,eC]),(0,o.useEffect)(()=>{if(!V||!V.operations||0===J.length)return;console.log("Updating operation statuses based on order data:",V);let e={};if(J.forEach(t=>{let r=t.code.toLowerCase();console.log(`Initialized status for ${r}:`,{isStarted:!1,isCompleted:!1,inputQuantity:0,outputQuantity:null,startTime:null,endTime:null}),e[r]={isStarted:!1,isCompleted:!1,inputQuantity:0,outputQuantity:null,startTime:null,endTime:null}}),V.operations.forEach(t=>{let r=t.operation.toLowerCase(),a={isStarted:!!t.startTime,isCompleted:!!t.endTime,inputQuantity:t.inputQuantity,outputQuantity:t.outputQuantity,startTime:t.startTime?new Date(t.startTime):null,endTime:t.endTime?new Date(t.endTime):null,operationId:t.id};console.log(`Updated status for ${r}:`,a),e[r]=a}),console.log("Final operation statuses:",e),et(e),V.currentOperation){let t=V.currentOperation.toLowerCase();console.log("Current operation:",t,"Status:",e[t]),e[t]?.isStarted&&!e[t]?.isCompleted?U("In Progress"):e[t]?.isCompleted?U("Completed"):U("Not Started")}else U("Not Started")},[V,J]),(0,o.useEffect)(()=>{R&&T({title:"Authentication Error",description:R,variant:"destructive"})},[R,T]),(0,o.useEffect)(()=>{if(console.log("EFFECT: Main production order fetch effect triggered",{poNumber:O,hasInitialData:!!e,alreadyLoaded:b.current,orderLoaded:eN,loadedOrderNumber:ev}),b.current){console.log("Already fetched data, skipping");return}if(e){console.log("Using provided initial data, skipping fetch"),G(e),ej(!0),"string"==typeof O&&eq(O),b.current=!0;return}if(!O||"string"!=typeof O){console.log("No valid poNumber available, waiting...");return}if(eN&&ev===O){console.log("Order already loaded for this poNumber, skipping");return}console.log("Triggering production order fetch for:",O),eF()},[O,e,eN,ev,eF]),(0,o.useEffect)(()=>(console.log("EFFECT: localStorage effect running"),localStorage.setItem("lastUpdateType","pageLoad"),()=>{console.log("EFFECT: localStorage effect cleanup"),localStorage.removeItem("lastUpdateType")}),[]),(0,o.useEffect)(()=>{if(e||b.current){console.log("Router ready effect: already have data, skipping fetch");return}let t=()=>{console.log("Router is ready, checking for poNumber:",D.query.poNumber);let e=D.query.poNumber;if(b.current){console.log("Skipping router ready effect: already fetched data");return}e&&"string"==typeof e&&!b.current&&(console.log("Router is ready with poNumber:",e),eF())};return D.isReady&&t(),D.events.on("routeChangeComplete",t),()=>{D.events.off("routeChangeComplete",t)}},[D,eF,e,b]);let eY=(0,o.useCallback)(async e=>{if(!$&&ee[F]?.isCompleted){console.log("Non-admin user tried to delete a defect in a completed operation"),T({title:"Permission Denied",description:"Only admin users can edit completed operations",variant:"destructive"});return}if(O&&F&&ee[F]?.isStarted)try{console.log(`Deleting defect ${e} from operation ${F}`),ed(!0);let t=Y.find(t=>t.id===e);if(!t)throw Error("Defect not found");if(!t.operationDefectId){_(t=>t.filter(t=>t.id!==e)),console.log("Defect was not saved to server, removed from UI only");return}let r=await fetch(`/api/operation-defects/${t.operationDefectId}`,{method:"DELETE",headers:S()});if(!I(r)){console.log("Response checking failed, aborting defect deletion"),ed(!1);return}if(!r.ok){let e=await r.json();throw Error(e.error||"Failed to delete defect")}console.log("Defect deleted successfully"),await eM(F,!0),T({title:"Success",description:"Defect deleted successfully"})}catch(t){console.error("Error deleting defect:",t);let e=t instanceof Error?t.message:"An unknown error occurred";T({title:"Error",description:e,variant:"destructive"})}finally{ed(!1)}},[F,Y,eM,S,$,ee,O,T,I]),e_=(0,o.useCallback)(async()=>{if(!ep){T({title:"Error",description:"Line Number is required",variant:"destructive"});return}try{console.log(`Completing operation ${F} for PO: ${O} with Line No: ${ep}`),ea(!0),eu(!0),localStorage.setItem("lastUpdateType","operationComplete");let e={poNumber:O,operationCode:F,rf:es,defects:Y,lineNo:ep};eg&&(e.timestamp=eg,console.log(`Including custom timestamp: ${eg}`));let t=await fetch("/api/operations/complete",{method:"POST",headers:{...S(),"Content-Type":"application/json"},body:JSON.stringify(e)});if(!I(t)){console.log("Response checking failed, aborting operation completion"),ea(!1);return}if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to complete operation")}let r=await t.json();if(G(r),U("Completed"),r.currentOperation){let e=r.currentOperation.toLowerCase();console.log(`Moving to next operation: ${e}`),eR(null),M(e),console.log(`Force fetching defects for next operation: ${e}`),eM(e),console.log(`Auto-starting next operation: ${e}`);try{let t=await fetch("/api/operations/start",{method:"POST",headers:{...S(),"Content-Type":"application/json"},body:JSON.stringify({poNumber:O,operationCode:e})});if(!I(t)){console.log("Response checking failed, aborting auto-start"),U("Not Started");return}if(!t.ok){let r=await t.json();console.error("Failed to auto-start next operation:",r.error),U("Not Started"),T({title:"Warning",description:`Moved to ${e.toUpperCase()} but failed to auto-start: ${r.error}`,variant:"destructive"});return}let r=await t.json();G(r),U("In Progress"),T({title:"Success",description:`${e.toUpperCase()} operation started automatically!`})}catch(t){console.error("Error auto-starting next operation:",t),U("Not Started"),T({title:"Warning",description:`Moved to ${e.toUpperCase()} but failed to auto-start. Please start manually.`,variant:"destructive"})}}T({title:"Success",description:`${F.toUpperCase()} operation completed successfully!`}),eo("1"),em(""),eh(""),ey(!1)}catch(t){console.error("Error completing operation:",t);let e=t instanceof Error?t.message:"An unknown error occurred";T({title:"Error",description:e,variant:"destructive"})}finally{ea(!1)}},[F,Y,eM,S,ep,O,es,eg,T,I]);return(0,s.jsxs)(s.Fragment,{children:[s.jsx(c(),{children:s.jsx("title",{children:`P-Chart System - Production Order ${"string"==typeof O?O:""}`})}),(0,s.jsxs)(l.Z,{children:[(0,s.jsxs)("div",{className:"py-6",children:[s.jsx(y.Z,{title:`Production Order - ${O}`,actions:(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[$&&s.jsx("div",{className:"text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded-md",children:"Admin Mode"}),E?.user?.role?.toLowerCase()==="viewer"&&(0,s.jsxs)(s.Fragment,{children:[s.jsx("div",{className:"text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded-md",children:"Viewer Mode"}),s.jsx(i.z,{variant:"outline",onClick:()=>D.push("/production-orders"),className:"mr-2",children:"Back to List"})]}),E?.user?.role?.toLowerCase()!=="viewer"&&s.jsx(i.z,{variant:"outline",onClick:d,disabled:g,className:"mr-2",children:g?"Releasing...":"Release Lock"})]})}),s.jsx(q.k,{poNumber:O,formData:K,handleChange:eB,handleUpdate:eH,isSubmitting:B,isAdmin:$,session:E,orderData:V}),s.jsx("div",{className:"mt-4 bg-white dark:bg-gray-800 rounded-lg shadow",children:s.jsx("div",{className:"p-4 border-b",children:(0,s.jsxs)(u.mQ,{defaultValue:F,value:F,onValueChange:eZ,children:[s.jsx("div",{className:"overflow-x-auto pb-1",children:s.jsx(C.v,{operationSteps:J,activeTab:F,operationStatuses:ee,isAdmin:$,handleTabChange:eZ})}),J.length>0?J.map(e=>s.jsx(u.nU,{value:e.code.toLowerCase(),className:"py-4",children:ee[e.code.toLowerCase()]?.isStarted||"op10"===e.code.toLowerCase()||J.findIndex(t=>t.code.toLowerCase()===e.code.toLowerCase())>0&&ee[J[J.findIndex(t=>t.code.toLowerCase()===e.code.toLowerCase())-1].code.toLowerCase()]?.isCompleted?(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8",children:[s.jsx(w.$,{activeTab:F,operationStatus:Z,operationStatuses:ee,rfValue:es,setRfValue:eo,defects:Y,isAdmin:$,orderData:V,isSubmitting:B,isCompletingOperation:er,isUpdatingDefects:ei,showOperationAuditLog:ef,showDefectAuditLog:ek,setShowOperationAuditLog:eb,setShowDefectAuditLog:ew,handleStartOperation:eU,handleCompleteOperation:ez}),(0,s.jsxs)("div",{className:"flex flex-col space-y-6",children:[s.jsx(j.x,{activeTab:F,masterDefects:eL,isAdmin:$,operationStatuses:ee,isLoading:eP,handleAddDefect:eJ,existingDefects:Y.filter(e=>e.quantity>0||e.operationDefectId).map(e=>({id:e.id,defectId:e.id,operationId:ee[F]?.operationId||0})),poNumber:O,refreshDefectsForOperationCallback:eW}),s.jsx(N.J,{activeTab:F,defects:Y,isAdmin:$,operationStatuses:ee,isUpdatingDefects:ei,isLoadingDefects:!1,poNumber:O,handleDefectQuantityChange:eG,refreshDefectsForOperationCallback:eW,selectedDefectId:eE,selectedDefectName:eT,setSelectedDefectId:e$,setSelectedDefectName:eD,setShowDefectItemAuditLog:eI,deleteDefect:eY})]})]}):(0,s.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[J.find(e=>e.code.toLowerCase()===F)?.name," ","details will be available after previous operations are completed."]})},e.code)):s.jsx(u.nU,{value:"loading",className:"p-4",children:s.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading operation details..."})})]})})})]}),s.jsx(v.w,{showEndOperationModal:ex,activeTab:F,lineNo:ep,rfValue:es,isCompletingOperation:er,setLineNo:em,setShowEndOperationModal:ey,submitCompleteOperation:e_}),$&&(0,s.jsxs)(s.Fragment,{children:[s.jsx(f.m,{open:ef,onClose:()=>eb(!1),poNumber:O,operationId:ee[F]?.operationId,type:"operation",title:`Operation Audit Logs - ${F?.toUpperCase()}`}),s.jsx(f.m,{open:ek,onClose:()=>ew(!1),poNumber:O,operationId:ee[F]?.operationId,type:"defect",title:`Defect Audit Logs - ${F?.toUpperCase()}`})]}),$&&s.jsx(f.m,{open:eS,onClose:()=>eI(!1),poNumber:O,defectId:eE?parseInt(eE):void 0,operationId:ee[F]?.operationId,type:"defect",title:`Defect Audit Log - ${eT}`})]})]})}let T=(0,k.MX)(async(e,t)=>{let{poNumber:r}=e.params;return console.log("[SSP] Processing request for PO:",r),{props:{poNumberFromServer:r}}});a()}catch(e){a(e)}})},53524:e=>{e.exports=require("@prisma/client")},98432:e=>{e.exports=require("bcryptjs")},93908:e=>{e.exports=require("lodash/debounce")},60614:e=>{e.exports=require("next-auth/jwt")},62113:e=>{e.exports=require("next-auth/next")},47449:e=>{e.exports=require("next-auth/providers/credentials")},41649:e=>{e.exports=require("next-auth/react")},62785:e=>{e.exports=require("next/dist/compiled/next-server/pages.runtime.prod.js")},40968:e=>{e.exports=require("next/head")},16689:e=>{e.exports=require("react")},66405:e=>{e.exports=require("react-dom")},20997:e=>{e.exports=require("react/jsx-runtime")},25458:e=>{e.exports=import("@radix-ui/react-avatar")},77715:e=>{e.exports=import("@radix-ui/react-dialog")},31481:e=>{e.exports=import("@radix-ui/react-dropdown-menu")},2932:e=>{e.exports=import("@radix-ui/react-hover-card")},98680:e=>{e.exports=import("@radix-ui/react-popover")},14338:e=>{e.exports=import("@radix-ui/react-slot")},6860:e=>{e.exports=import("@radix-ui/react-tabs")},61329:e=>{e.exports=import("@radix-ui/react-toast")},99648:e=>{e.exports=import("axios")},16926:e=>{e.exports=import("class-variance-authority")},16593:e=>{e.exports=import("clsx")},46812:e=>{e.exports=import("react-error-boundary")},86201:e=>{e.exports=import("react-hot-toast")},14612:e=>{e.exports=import("socket.io-client")},68097:e=>{e.exports=import("tailwind-merge")},57147:e=>{e.exports=require("fs")},71017:e=>{e.exports=require("path")},12781:e=>{e.exports=require("stream")},59796:e=>{e.exports=require("zlib")}};var t=require("../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[6255,1267,1777,8559,5143,9266,8715],()=>r(31905));module.exports=a})();