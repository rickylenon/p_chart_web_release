"use strict";(()=>{var e={};e.id=4337,e.ids=[4337],e.modules={53524:e=>{e.exports=require("@prisma/client")},98432:e=>{e.exports=require("bcryptjs")},60614:e=>{e.exports=require("next-auth/jwt")},62113:e=>{e.exports=require("next-auth/next")},47449:e=>{e.exports=require("next-auth/providers/credentials")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},31163:(e,t,r)=>{r.r(t),r.d(t,{config:()=>u,default:()=>d,routeModule:()=>p});var o={};r.r(o),r.d(o,{default:()=>l});var a=r(71802),n=r(47153),s=r(56249),i=r(44507);let l=(0,r(66826).QO)(async function(e,t,r){if("GET"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let o,a;console.log("API: P.O. progress auth session validated, user:",r?.user?.name),console.log("Fetching P.O. progress data with query params:",e.query);let{year:n,month:s,line:l,series:d,status:u,poNumber:p}=e.query;if(n&&!/^\d{4}$/.test(n))return console.warn("Invalid year format:",n),t.status(400).json({error:"Invalid year format. Expected YYYY."});if(s&&"All"!==s&&n){let e=Array.isArray(s)?s[0]:s,r=parseInt(e),i=Array.isArray(n)?n[0]:n;if(isNaN(r)||!(r>=1)||!(r<=12))return console.warn("Invalid month value:",e),t.status(400).json({error:"Invalid month value"});o=new Date(`${i}-${r.toString().padStart(2,"0")}-01`),(a=new Date(Number(i),r,0)).setHours(23,59,59,999)}else{let e=new Date,t=n?parseInt(Array.isArray(n)?n[0]:n):e.getFullYear();o=new Date(t,e.getMonth(),1),(a=new Date(t,e.getMonth()+1,0)).setHours(23,59,59,999),console.log(`Defaulting to current month (${e.getMonth()+1}/${t}): ${o.toISOString()} to ${a.toISOString()}`)}console.log(`Date range: ${o.toISOString()} to ${a.toISOString()}`);let c={};if(d&&"All"!==d){let e=Array.isArray(d)?d[0]:d;c.itemName=e,console.log("Applied series filter (using itemName):",e)}if(u&&"All"!==u){let e=Array.isArray(u)?u[0]:u;c.status=e,console.log("Applied status filter:",e)}if(p){let e=Array.isArray(p)?p[0]:p;c.poNumber={contains:e},console.log("Applied PO number filter:",e)}let g={startTime:{gte:o,lte:a}};if(l&&"All"!==l){let e=Array.isArray(l)?l[0]:l;g.lineNo=e,console.log("Applied line filter:",e)}Object.keys(c).length>0&&(g.productionOrder=c),console.log("Operation filter conditions:",JSON.stringify(g,null,2)),console.time("started-operations-query");let m=await i._.operation.findMany({where:{...g,operation:"OP10"},include:{productionOrder:{select:{poNumber:!0,itemName:!0,status:!0}}},orderBy:{startTime:"asc"}});console.timeEnd("started-operations-query"),console.time("completed-operations-query");let y=await i._.operation.findMany({where:{...g,operation:"OP40",endTime:{gte:o,lte:a,not:null}},include:{productionOrder:{select:{poNumber:!0,itemName:!0,status:!0}}},orderBy:{endTime:"asc"}});console.timeEnd("completed-operations-query"),console.log(`Found ${m.length} operations started in date range`),console.log(`Found ${y.length} operations completed in date range`);let h=[],f=new Date(o);for(;f<=a;){let e=f.getDate().toString(),t=f.toISOString().split("T")[0],r=new Set;m.forEach(e=>{e.startTime&&e.startTime.toDateString()===f.toDateString()&&r.add(e.productionOrder.poNumber)});let o=new Set;y.forEach(e=>{e.endTime&&e.endTime.toDateString()===f.toDateString()&&o.add(e.productionOrder.poNumber)});let a=new Set;m.forEach(e=>{e.startTime&&e.startTime<=f&&a.add(e.productionOrder.poNumber)}),h.push({day:e,date:t,started:r.size,completed:o.size,total:a.size}),f.setDate(f.getDate()+1)}return console.log("P.O. progress data generated:",h.length,"days"),t.setHeader("Cache-Control","public, max-age=300"),t.status(200).json({progressData:h,appliedFilters:{year:n||null,month:"All"!==s?s:null,line:"All"!==l?l:null,series:"All"!==d?d:null,status:"All"!==u?u:null,poNumber:p?Array.isArray(p)?p[0]:p:null},dateRange:{start:o.toISOString(),end:a.toISOString()}})}catch(e){return console.error("Error fetching P.O. progress data:",e),t.status(500).json({error:"Failed to fetch P.O. progress data",progressData:[]})}}),d=(0,s.l)(o,"default"),u=(0,s.l)(o,"config"),p=new a.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/dashboard/po-progress",pathname:"/api/dashboard/po-progress",bundlePath:"",filename:""},userland:o})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[549],()=>r(31163));module.exports=o})();