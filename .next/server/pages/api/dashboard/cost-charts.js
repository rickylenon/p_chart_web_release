"use strict";(()=>{var e={};e.id=1769,e.ids=[1769],e.modules={53524:e=>{e.exports=require("@prisma/client")},98432:e=>{e.exports=require("bcryptjs")},60614:e=>{e.exports=require("next-auth/jwt")},62113:e=>{e.exports=require("next-auth/next")},47449:e=>{e.exports=require("next-auth/providers/credentials")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},90481:(e,t,r)=>{r.r(t),r.d(t,{config:()=>u,default:()=>c,routeModule:()=>d});var o={};r.r(o),r.d(o,{default:()=>s});var a=r(71802),i=r(47153),l=r(56249),n=r(44507);let s=(0,r(66826).QO)(async function(e,t,r){if("GET"!==e.method)return t.status(405).json({error:"Method not allowed"});try{console.log("Fetching dashboard cost chart data with query params:",e.query);let{year:r,month:o,line:a,series:i,status:l,poNumber:s}=e.query,c={},u={};if(r){let e=Array.isArray(r)?r[0]:r,t=new Date(`${e}-01-01`),o=new Date(`${Number(e)+1}-01-01`);o.setMilliseconds(o.getMilliseconds()-1),c.startTime={gte:t,lte:o},console.log(`Applied year filter for ${e}:`,{yearStart:t,yearEnd:o})}if(o&&"All"!==o){let e=Array.isArray(o)?o[0]:o,t=parseInt(e);if(!isNaN(t)&&t>=1&&t<=12&&r){let o=Array.isArray(r)?r[0]:r,a=new Date(`${o}-${t.toString().padStart(2,"0")}-01`),i=new Date(Number(o),t,0);i.setHours(23,59,59,999),c.startTime={gte:a,lte:i},console.log(`Applied month filter for ${e}:`,{monthStart:a,monthEnd:i})}}if(a&&"All"!==a){let e=Array.isArray(a)?a[0]:a;c.lineNo=e,console.log("Applied line filter:",e)}if(i&&"All"!==i){let e=Array.isArray(i)?i[0]:i;u.itemName=e,console.log("Applied series filter:",e)}if(l&&"All"!==l){let e=Array.isArray(l)?l[0]:l;u.status=e,console.log("Applied status filter:",e)}if(s){let e=Array.isArray(s)?s[0]:s;u.poNumber={contains:e},console.log("Applied PO number filter:",e)}Object.keys(u).length>0&&(c.productionOrder={is:u}),console.log("Using filter conditions:",JSON.stringify(c,null,2));let d=await n._.operation.findMany({where:{...c,endTime:{not:null},operationDefects:{some:{}}},select:{id:!0,operation:!0,startTime:!0,productionOrder:{select:{id:!0,poNumber:!0,itemName:!0,costPerUnit:!0}},operationDefects:{select:{quantity:!0,quantityRework:!0,defectReworkable:!0}}},orderBy:{startTime:"desc"}});if(console.log(`Found ${d.length} operations with defects`),d.length>0){let e=d[0];console.log("Sample operation data:",{operation:e.operation,costPerUnit:e.productionOrder.costPerUnit,itemName:e.productionOrder.itemName,defectsCount:e.operationDefects.length,sampleDefect:e.operationDefects[0]})}let p=d.reduce((e,t)=>{let r=t.operation||"Unknown",o=Number(t.productionOrder.costPerUnit||0),a=t.operationDefects.reduce((e,t)=>{let r=t.defectReworkable?Math.max(0,t.quantity-t.quantityRework):t.quantity;return e+r},0);return e[r]||(e[r]={operation:r,totalCost:0,count:0}),e[r].totalCost+=a*o,e[r].count+=1,e},{}),f=Object.values(p).filter(e=>e.totalCost>0).map(e=>({name:e.operation,cost:parseFloat(e.totalCost.toFixed(2))})),m=d.reduce((e,t)=>{if(!t.startTime)return e;let r=Number(t.productionOrder.costPerUnit||0),o=t.operationDefects.reduce((e,t)=>{let r=t.defectReworkable?Math.max(0,t.quantity-t.quantityRework):t.quantity;return e+r},0)*r;if(o>0){let r=t.startTime.toISOString().split("T")[0];e[r]||(e[r]={date:r,cost:0}),e[r].cost+=o}return e},{}),y=Object.values(m).map(e=>({date:e.date,cost:parseFloat(e.cost.toFixed(2))})),h=d.reduce((e,t)=>{let r=Number(t.productionOrder.costPerUnit||0),o=t.operationDefects.reduce((e,t)=>{let r=t.defectReworkable?Math.max(0,t.quantity-t.quantityRework):t.quantity;return e+r},0);return e+o*r},0);console.log(`Total defect cost: $${h.toFixed(2)}`),t.status(200).json({operationCostData:f,dailyCostData:y,totalDefectCost:parseFloat(h.toFixed(2)),appliedFilters:{year:r||null,month:"All"!==o?o:null,line:"All"!==a?a:null,series:"All"!==i?i:null,status:"All"!==l?l:null,poNumber:s||null}})}catch(e){console.error("Error fetching cost chart data:",e),t.status(500).json({error:"Failed to fetch cost chart data",details:e instanceof Error?e.message:"Unknown error"})}}),c=(0,l.l)(o,"default"),u=(0,l.l)(o,"config"),d=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/dashboard/cost-charts",pathname:"/api/dashboard/cost-charts",bundlePath:"",filename:""},userland:o})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[549],()=>r(90481));module.exports=o})();