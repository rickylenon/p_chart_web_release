"use strict";(()=>{var e={};e.id=9068,e.ids=[9068],e.modules={53524:e=>{e.exports=require("@prisma/client")},63844:e=>{e.exports=require("adm-zip")},98432:e=>{e.exports=require("bcryptjs")},60614:e=>{e.exports=require("next-auth/jwt")},62113:e=>{e.exports=require("next-auth/next")},47449:e=>{e.exports=require("next-auth/providers/credentials")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},36705:e=>{e.exports=import("formidable")},57147:e=>{e.exports=require("fs")},71017:e=>{e.exports=require("path")},8535:(e,r,t)=>{t.a(e,async(e,i)=>{try{t.r(r),t.d(r,{config:()=>u,default:()=>d,routeModule:()=>c});var s=t(71802),a=t(47153),n=t(56249),o=t(68614),l=e([o]);o=(l.then?(await l)():l)[0];let d=(0,n.l)(o,"default"),u=(0,n.l)(o,"config"),c=new s.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/admin/system-update/upload",pathname:"/api/admin/system-update/upload",bundlePath:"",filename:""},userland:o});i()}catch(e){i(e)}})},41099:(e,r,t)=>{t.d(r,{U:()=>s,n:()=>a});var i=t(44507);async function s(e){console.log(`Creating audit log for ${e.tableName}:${e.recordId}, action: ${e.action}`);try{let r=String(e.recordId),t=e.oldValues?JSON.stringify(e.oldValues):null,s=e.newValues?JSON.stringify(e.newValues):null,a=await i.Z.auditLog.create({data:{tableName:e.tableName,recordId:r,action:e.action,oldValues:t,newValues:s,userId:e.userId,ipAddress:e.ipAddress||null,userAgent:e.userAgent||null}});return console.log(`Audit log created with ID: ${a.id}`),a}catch(e){return console.error("Error creating audit log:",e),null}}function a(e){let r=e.headers["x-forwarded-for"]||e.socket.remoteAddress||null,t=e.headers["user-agent"]||null;return{ipAddress:"string"==typeof r?r.split(",")[0].trim():null,userAgent:t}}},68614:(e,r,t)=>{t.a(e,async(e,i)=>{try{t.r(r),t.d(r,{config:()=>h,default:()=>v});var s=t(66826),a=t(36705),n=t(57147),o=t.n(n),l=t(71017),d=t.n(l),u=t(63844),c=t.n(u),p=t(41099),g=e([a]);a=(g.then?(await g)():g)[0];let h={api:{bodyParser:!1}};async function m(e,r,t,i){try{let s=(0,p.n)(i),a=i.headers["x-user-name"]||"Unknown Admin",n={action:e,description:r,userName:a,version:t?.version||"unknown",fileCount:t?.files?.length||0,size:t?.size||0,isValid:t?.isValid||!1,errorCount:t?.errors?.length||0,errors:t?.errors?.slice(0,3)||[]};await (0,p.U)({tableName:"system_events",recordId:"system",action:"update",oldValues:null,newValues:n,userId:1,ipAddress:s.ipAddress,userAgent:s.userAgent})}catch(e){console.error("Failed to log system event:",e)}}async function f(e){let r={version:"unknown",files:[],size:0,isValid:!1,errors:[]};try{let t=new(c())(e).getEntries();r.size=o().statSync(e).size,r.files=t.map(e=>e.entryName);let i=r.files,s=[...new Set(i.map(e=>e.split("/")[0]))],a=1===s.length&&s[0]&&i.every(e=>e.includes("/")),n=i,l="";for(let e of(a&&(l=s[0],n=i.map(e=>e.replace(l+"/","")),console.log(`📁 Detected root directory in ZIP: "${l}"`),console.log(`🔍 Stripping root directory for validation...`)),["server.js","package.json"]))n.some(r=>r.endsWith(e)||r===e)||r.errors.push(`Missing required file: ${e} (checked in ${a?"root directory: "+l:"ZIP root"})`);n.some(e=>e.includes(".next/"))||r.errors.push(`Missing .next/ directory - this should contain the Next.js build (checked in ${a?"root directory: "+l:"ZIP root"})`),r.rootDirectory=l,console.log(`✅ Validation passed! Found ${r.files.length} files total${a?" (in root directory: "+l+")":""}.`);let d=t.find(e=>"package.json"===e.entryName);if(d)try{let e=d.getData().toString(),t=JSON.parse(e);r.version=t.version||"unknown"}catch(e){r.errors.push("Invalid package.json format")}console.log(`✅ Skipping security scan for ${r.files.length} files in development mode`),r.size>524288e3&&r.errors.push(`Package too large: ${(r.size/1024/1024).toFixed(2)}MB (max: 100MB)`),r.isValid=0===r.errors.length}catch(e){r.errors.push(`Failed to validate package: ${e instanceof Error?e.message:String(e)}`)}return r}async function y(e,r,t){if(console.log("System update upload API called"),"POST"!==e.method)return r.status(405).json({error:"Method not allowed"});try{let i=t?.user?.role||"";if(!("string"==typeof i&&"admin"===i.toLowerCase()))return console.log("Access denied - user role:",i),r.status(403).json({error:"Admin access required"});let s=t?.user?.name||t?.user?.username||"Unknown Admin",n=d().join(process.cwd(),"temp","system-updates");o().existsSync(n)||o().mkdirSync(n,{recursive:!0});let l=(0,a.default)({uploadDir:n,keepExtensions:!0,maxFileSize:209715200,filter:e=>!!("application/zip"===e.mimetype||"application/x-zip-compressed"===e.mimetype||e.originalFilename?.endsWith(".zip"))}),[u,c]=await l.parse(e),p=Array.isArray(c.file)?c.file[0]:c.file;if(!p)return r.status(400).json({error:"No file uploaded"});if(!p.originalFilename?.endsWith(".zip"))return o().unlinkSync(p.filepath),r.status(400).json({error:"Only ZIP files are allowed"});console.log(`Processing uploaded file: ${p.originalFilename}`);let g=await f(p.filepath);if(!g.isValid)return o().unlinkSync(p.filepath),await m("SYSTEM_UPDATE_UPLOAD_FAILED",`Invalid update package uploaded: ${p.originalFilename}`,{errors:g.errors,uploadedBy:s,filename:p.originalFilename},e),r.status(400).json({error:"Invalid update package",details:g.errors});let y=`update_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,h=d().join(n,`${y}.zip`);o().renameSync(p.filepath,h);let v={id:y,filename:p.originalFilename,version:g.version,size:g.size,files:g.files,uploadedBy:s,uploadedAt:new Date().toISOString(),path:h,applied:!1},S=d().join(n,`${y}.json`);return o().writeFileSync(S,JSON.stringify(v,null,2)),await m("SYSTEM_UPDATE_UPLOADED",`System update package uploaded: ${p.originalFilename} (v${g.version})`,{updateId:y,version:g.version,size:g.size,uploadedBy:s,filename:p.originalFilename},e),console.log(`Update package uploaded successfully: ${y}`),r.status(200).json({success:!0,updateId:y,packageInfo:{filename:p.originalFilename,version:g.version,size:g.size,files:g.files.length,uploadedBy:s,uploadedAt:v.uploadedAt}})}catch(s){console.error("System update upload error:",s);let t=s instanceof Error?s.message:String(s),i=s instanceof Error?s.stack:void 0;return await m("SYSTEM_UPDATE_UPLOAD_ERROR",`System update upload failed: ${t}`,{error:t,stack:i},e),r.status(500).json({error:"Internal server error",details:t})}}let v=(0,s.QO)(y);i()}catch(e){i(e)}})}};var r=require("../../../../webpack-api-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[549],()=>t(8535));module.exports=i})();