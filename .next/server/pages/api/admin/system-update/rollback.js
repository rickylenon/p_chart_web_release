"use strict";(()=>{var e={};e.id=9881,e.ids=[9881],e.modules={53524:e=>{e.exports=require("@prisma/client")},98432:e=>{e.exports=require("bcryptjs")},60614:e=>{e.exports=require("next-auth/jwt")},62113:e=>{e.exports=require("next-auth/next")},47449:e=>{e.exports=require("next-auth/providers/credentials")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},32081:e=>{e.exports=require("child_process")},57147:e=>{e.exports=require("fs")},71017:e=>{e.exports=require("path")},59575:(e,r,t)=>{t.r(r),t.d(r,{config:()=>x,default:()=>k,routeModule:()=>b});var s={};t.r(s),t.d(s,{default:()=>w});var o=t(71802),a=t(47153),n=t(56249),c=t(66826),i=t(41099),l=t(57147),u=t.n(l),d=t(71017),p=t.n(d),m=t(32081);async function y(e,r,t,s){try{let o=(0,i.n)(s),a=s.headers["x-user-name"]||"Unknown Admin";await (0,i.U)({tableName:"system_events",recordId:"system",action:"update",oldValues:null,newValues:{action:e,description:r,details:t,userName:a},userId:1,ipAddress:o.ipAddress,userAgent:o.userAgent})}catch(e){console.error("Failed to log system event:",e)}}async function f(e,r){for(let t of(u().existsSync(r)||u().mkdirSync(r,{recursive:!0}),u().readdirSync(e,{withFileTypes:!0}))){let s=p().join(e,t.name),o=p().join(r,t.name);t.isDirectory()?await f(s,o):u().copyFileSync(s,o)}}async function S(){return new Promise(e=>{let r=p().join(process.cwd(),"restart.bat");if(!u().existsSync(r)){console.log("restart.bat not found, attempting manual restart sequence");let r=p().join(process.cwd(),"stop.bat"),t=p().join(process.cwd(),"start.bat");if(u().existsSync(r)&&u().existsSync(t)){let s=(0,m.spawn)("cmd.exe",["/c",r],{cwd:process.cwd(),stdio:"inherit"});s.on("close",()=>{setTimeout(()=>{let r=(0,m.spawn)("cmd.exe",["/c",t],{cwd:process.cwd(),stdio:"inherit",detached:!0});r.on("close",()=>e(!0)),r.on("error",()=>e(!1)),setTimeout(()=>e(!0),1e4)},3e3)}),s.on("error",()=>e(!1))}else e(!1);return}let t=(0,m.spawn)("cmd.exe",["/c",r],{cwd:process.cwd(),stdio:"inherit",detached:!0});t.on("close",r=>{console.log(`Restart script exited with code: ${r}`),e(0===r)}),t.on("error",r=>{console.error("Error restarting application:",r),e(!1)}),setTimeout(()=>{e(!0)},3e4)})}async function g(e,r,t){if(console.log("System update rollback API called"),"POST"!==e.method)return r.status(405).json({error:"Method not allowed"});try{let s=t?.user?.role||"";if(!("string"==typeof s&&"admin"===s.toLowerCase()))return console.log("Access denied - user role:",s),r.status(403).json({error:"Admin access required"});let o=t?.user?.name||t?.user?.username||"Unknown Admin",{backupId:a}=e.body;if(!a)return r.status(400).json({error:"Backup ID is required"});let n=p().join(process.cwd(),"backup",a);if(!u().existsSync(n))return r.status(404).json({error:"Backup not found"});console.log(`Rolling back to backup: ${a}`),await y("SYSTEM_UPDATE_ROLLBACK_START",`Starting system rollback to backup: ${a}`,{backupId:a,rolledBackBy:o},e);let c=["server.js","package.json",".next","public"],i=p().join(process.cwd(),"backup",`pre_rollback_${Date.now()}`);for(let e of(u().mkdirSync(i,{recursive:!0}),c)){let r=p().join(process.cwd(),e),t=p().join(i,e);u().existsSync(r)&&(u().statSync(r).isDirectory()?await f(r,t):u().copyFileSync(r,t))}for(let e of c){let r=p().join(n,e),t=p().join(process.cwd(),e);u().existsSync(r)&&(u().existsSync(t)&&u().rmSync(t,{recursive:!0,force:!0}),u().statSync(r).isDirectory()?await f(r,t):u().copyFileSync(r,t),console.log(`Restored: ${e}`))}if(console.log("Attempting to restart application..."),await S())return await y("SYSTEM_UPDATE_ROLLBACK_SUCCESS",`System rollback completed successfully: ${a}`,{backupId:a,rolledBackBy:o,restartSuccessful:!0},e),r.status(200).json({success:!0,message:"Rollback completed successfully and application restarted",details:{backupId:a,restoredFiles:c,currentBackup:p().basename(i)}});return await y("SYSTEM_UPDATE_ROLLBACK_PARTIAL",`System rollback completed but restart failed: ${a}`,{backupId:a,rolledBackBy:o,restartSuccessful:!1},e),r.status(200).json({success:!0,message:"Rollback completed successfully. Please restart the application manually.",needsManualRestart:!0,details:{backupId:a,restoredFiles:c,currentBackup:p().basename(i)}})}catch(s){console.error("System update rollback error:",s);let t=s instanceof Error?s.message:String(s);return await y("SYSTEM_UPDATE_ROLLBACK_ERROR",`System rollback failed: ${t}`,{error:t,stack:s instanceof Error?s.stack:void 0},e),r.status(500).json({success:!1,message:"Rollback failed",details:t})}}let w=(0,c.QO)(g),k=(0,n.l)(s,"default"),x=(0,n.l)(s,"config"),b=new o.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/admin/system-update/rollback",pathname:"/api/admin/system-update/rollback",bundlePath:"",filename:""},userland:s})},41099:(e,r,t)=>{t.d(r,{U:()=>o,n:()=>a});var s=t(44507);async function o(e){console.log(`Creating audit log for ${e.tableName}:${e.recordId}, action: ${e.action}`);try{let r=String(e.recordId),t=e.oldValues?JSON.stringify(e.oldValues):null,o=e.newValues?JSON.stringify(e.newValues):null,a=await s.Z.auditLog.create({data:{tableName:e.tableName,recordId:r,action:e.action,oldValues:t,newValues:o,userId:e.userId,ipAddress:e.ipAddress||null,userAgent:e.userAgent||null}});return console.log(`Audit log created with ID: ${a.id}`),a}catch(e){return console.error("Error creating audit log:",e),null}}function a(e){let r=e.headers["x-forwarded-for"]||e.socket.remoteAddress||null,t=e.headers["user-agent"]||null;return{ipAddress:"string"==typeof r?r.split(",")[0].trim():null,userAgent:t}}}};var r=require("../../../../webpack-api-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[549],()=>t(59575));module.exports=s})();