(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[209],{69430:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/production-orders",function(){return r(52815)}])},17344:function(e,t,r){"use strict";r.d(t,{a:function(){return l}});var o=r(33299),s=r(11163),a=r(67294),n=r(98225),i=r(65050);function l(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{data:t,status:r}=(0,o.useSession)(),l=(0,s.useRouter)(),{toast:c}=(0,i.pm)(),[d,u]=(0,a.useState)(!1),[g,m]=(0,a.useState)(!0),[h,p]=(0,a.useState)(null),[f,x]=(0,a.useState)(!1),{redirectTo:y="/auth/login",requiredRoles:N=[]}=e;(0,a.useEffect)(()=>{if(console.log("Auth effect running, status:",r,"verified:",f),"loading"===r||f)return;if(null==t?void 0:t.user){if(console.log("Found NextAuth session, storing to localStorage"),n.UserSession.storeSession(t.user),N.length>0){var e;let r=((null==t?void 0:null===(e=t.user)||void 0===e?void 0:e.role)||"").toLowerCase();if(!N.some(e=>e.toLowerCase()===r)){console.log("Required role not found. User role: ".concat(r)),u(!1),m(!1),p("You do not have permission to access this page"),x(!0),l.push("/dashboard");return}}u(!0),m(!1),p(null),x(!0);return}let o=n.UserSession.getSession();if(o){if(console.log("Found valid localStorage session, using as fallback"),N.length>0){let e=(o.role||"").toLowerCase();if(!N.some(t=>t.toLowerCase()===e)){console.log("Required role not found. Local user role: ".concat(e)),u(!1),m(!1),p("You do not have permission to access this page"),x(!0),l.push("/dashboard");return}}u(!0),m(!1),p(null),x(!0);return}console.log("No valid session found, redirecting to login"),l.push("".concat(y,"?callbackUrl=").concat(encodeURIComponent(window.location.href)))},[r,t,l,y,N,f]);let b=(0,a.useCallback)(()=>n.UserSession.getAuthHeaders(),[]),j=(0,a.useCallback)(async()=>n.UserSession.getCurrentUser(),[]),v=(0,a.useCallback)(e=>n.UserSession.hasRole(e),[]),w=(0,a.useCallback)(()=>{console.log("Handling expired session"),n.UserSession.clearSession(),(0,o.signOut)({redirect:!1});let e=window.location.href;l.push("".concat(y,"?callbackUrl=").concat(encodeURIComponent(e),"&expired=true"))},[y,l]),S=(0,a.useCallback)(e=>{switch(e.status){case 401:return console.log("Detected 401 unauthorized response - session likely expired"),w(),!1;case 403:return console.log("Detected 403 forbidden response - permission denied"),c({title:"Permission Denied",description:"You don't have permission to access this resource",variant:"destructive"}),!1;case 429:return console.log("Detected 429 response - rate limited"),c({title:"Rate Limited",description:"Too many requests. Please try again later.",variant:"destructive"}),!1;case 500:case 502:case 503:case 504:return console.log("Detected server error (".concat(e.status,")")),c({title:"Server Error",description:"The server encountered an error. Please try again later.",variant:"destructive"}),!1}return!0},[w,c]);return{session:t,status:r,isAuthorized:d,isLoading:g,authError:h,getAuthHeaders:b,getCurrentUser:j,hasRole:v,handleExpiredSession:w,checkResponseAuth:S}}},52815:function(e,t,r){"use strict";r.r(t),r.d(t,{__N_SSP:function(){return L},default:function(){return _}});var o=r(85893),s=r(67294),a=r(87249),n=r(85263),i=r(11163),l=r(45847),c=r(9008),d=r.n(c),u=r(17344),g=r(65050),m=r(33566),h=r(25998),p=r(90470),f=r(45977),x=r(62916),y=r(13718),N=r(10133),b=r(44531);let j=N.zt,v=N.fC,w=N.xz,S=s.forwardRef((e,t)=>{let{className:r,sideOffset:s=4,...a}=e;return(0,o.jsx)(N.VY,{ref:t,sideOffset:s,className:(0,b.cn)("z-50 overflow-hidden rounded-md bg-primary px-3 py-1.5 text-xs text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r),...a})});S.displayName=N.VY.displayName;var U=r(80068);let k=s.forwardRef((e,t)=>{let{children:r,...s}=e;return(0,o.jsx)(U.fC,{...s,children:r})});k.displayName="AlertDialog",s.forwardRef((e,t)=>{let{children:r,...s}=e;return(0,o.jsx)(U.xz,{...s,ref:t,children:r})}).displayName="AlertDialogTrigger";let C=e=>{let{children:t,...r}=e;return(0,o.jsx)(U.h_,{...r,children:(0,o.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:t})})};C.displayName="AlertDialogPortal";let D=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,o.jsx)(U.aV,{className:(0,b.cn)("fixed inset-0 z-50 bg-background/80 backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",r),...s,ref:t})});D.displayName="AlertDialogOverlay";let P=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,o.jsxs)(C,{children:[(0,o.jsx)(D,{}),(0,o.jsx)(U.VY,{ref:t,className:(0,b.cn)("fixed z-50 grid w-full max-w-lg scale-100 gap-4 border bg-background p-6 opacity-100 shadow-lg animate-in fade-in-0 slide-in-from-bottom-10 sm:rounded-lg sm:zoom-in-90 sm:slide-in-from-bottom-0 md:w-full",r),...s})]})});P.displayName="AlertDialogContent";let R=e=>{let{className:t,...r}=e;return(0,o.jsx)("div",{className:(0,b.cn)("flex flex-col space-y-2 text-center sm:text-left",t),...r})};R.displayName="AlertDialogHeader";let I=e=>{let{className:t,...r}=e;return(0,o.jsx)("div",{className:(0,b.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...r})};I.displayName="AlertDialogFooter";let E=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,o.jsx)(U.Dx,{ref:t,className:(0,b.cn)("text-lg font-semibold",r),...s})});E.displayName="AlertDialogTitle";let z=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,o.jsx)(U.dk,{ref:t,className:(0,b.cn)("text-sm text-muted-foreground",r),...s})});z.displayName="AlertDialogDescription";let A=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,o.jsx)(U.aU,{ref:t,className:(0,b.cn)((0,a.d)(),r),...s})});A.displayName="AlertDialogAction";let O=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,o.jsx)(U.$j,{ref:t,className:(0,b.cn)((0,a.d)({variant:"outline"}),"mt-2 sm:mt-0",r),...s})});O.displayName="AlertDialogCancel";var L=!0;function _(e){let{userData:t}=e,{toast:r}=(0,g.pm)(),c=(0,i.useRouter)(),[N,b]=(0,s.useState)(""),U=function(e,t){let[r,o]=(0,s.useState)(e);return(0,s.useEffect)(()=>{let r=setTimeout(()=>{o(e)},t);return()=>{clearTimeout(r)}},[e,t]),r}(N,300),[C,D]=(0,s.useState)([]),[L,_]=(0,s.useState)(!0),[F,q]=(0,s.useState)(null),[T,M]=(0,s.useState)(1),[V,Y]=(0,s.useState)(10),[Z,H]=(0,s.useState)(0),[J,W]=(0,s.useState)(1),{getAuthHeaders:X}=(0,u.a)(),[B,Q]=(0,s.useState)(t?parseInt(t.id):null),[$,G]=(0,s.useState)(!1),[K,ee]=(0,s.useState)(void 0),[et,er]=(0,s.useState)("asc"),[eo,es]=(0,s.useState)(!1),[ea,en]=(0,s.useState)(null),[ei,el]=(0,s.useState)(!1),[ec,ed]=(0,s.useState)(!1),eu=e=>{try{localStorage.setItem("productionOrdersUrl",JSON.stringify(e)),console.log("Saved URL parameters to localStorage:",e)}catch(e){console.error("Error saving to localStorage:",e)}},eg=()=>{try{let e=localStorage.getItem("productionOrdersUrl");if(e){let t=JSON.parse(e);return console.log("Loaded URL parameters from localStorage:",t),t}}catch(e){console.error("Error loading from localStorage:",e)}return null};(0,s.useEffect)(()=>{if(c.isReady&&!ec){let{page:e,limit:t,search:r,sortField:o,sortDirection:s}=c.query;if(console.log("Initializing state from URL:",c.query),0===Object.keys(c.query).length){let e=eg();e&&Object.keys(e).length>0?(console.log("Using saved parameters from localStorage"),e.page&&M(Number(e.page)),e.limit&&Y(Number(e.limit)),e.search&&b(String(e.search)),e.sortField&&ee(String(e.sortField)),e.sortDirection&&er(e.sortDirection),c.replace({pathname:c.pathname,query:e},void 0,{shallow:!0})):console.log("No saved parameters found or localStorage empty - using defaults for new browser session")}else e&&M(Number(e)),t&&Y(Number(t)),r&&b(String(r)),o&&ee(String(o)),s&&er(s);ed(!0)}},[c.isReady,c.query,ec]),(0,s.useEffect)(()=>{if(c.isReady&&ec){let e={};T>1&&(e.page=String(T)),10!==V&&(e.limit=String(V)),N&&(e.search=N),K&&(e.sortField=K,e.sortDirection=et),console.log("Updating URL with query:",e),eu(e),Object.keys(e).length>0&&c.replace({pathname:c.pathname,query:e},void 0,{shallow:!0})}},[c.isReady,T,V,N,K,et,ec]),(0,s.useEffect)(()=>{if(t){let e=(t.role||"").toUpperCase();console.log("Setting admin status based on role:",e),G("ADMIN"===e)}},[t]),(0,s.useEffect)(()=>{console.log("User data:",t),console.log("User role:",null==t?void 0:t.role),console.log("isAdmin:",$),console.log("currentUserId:",B)},[t,$,B]),(0,s.useEffect)(()=>{(async()=>{if(!ec||!t){console.log("Skipping fetch - not initialized or no user data");return}try{_(!0),q(null);let e=X(),t="/api/production-orders?page=".concat(T,"&limit=").concat(V);U&&(t+="&search=".concat(encodeURIComponent(U))),K&&(t+="&sortField=".concat(encodeURIComponent(K),"&sortDirection=").concat(et)),console.log("Fetching orders with URL:",t);let r=await fetch(t,{headers:e});if(!r.ok)throw Error("Failed to fetch production orders");let o=await r.json();console.log("Fetched orders data:",o),D(o.orders),H(o.pagination.total),W(o.pagination.totalPages)}catch(t){let e=t instanceof Error?t.message:"An error occurred";q(e),r({title:"Error",description:e,variant:"destructive"})}finally{_(!1)}})()},[T,V,U,t,X,r,K,et,$,ec]);let em=(e,t)=>{let r="OP".concat(t),o=e.operations.find(e=>e.operation===r);return o?o.endTime?"bg-green-500":o.startTime?"bg-blue-500":"bg-gray-400":"bg-gray-300"},eh=async()=>{if(ea)try{if(el(!0),!(await fetch("/api/production-orders/".concat(ea.poNumber),{method:"DELETE",headers:X()})).ok)throw Error("Failed to delete production order");r({title:"Success",description:"Production order ".concat(ea.poNumber," has been deleted.")}),D(e=>e.filter(e=>e.poNumber!==ea.poNumber)),es(!1),en(null)}catch(e){r({title:"Error",description:e instanceof Error?e.message:"An error occurred",variant:"destructive"})}finally{el(!1)}},ep=[{key:"poNumber",header:"PO Number",sortable:!0},{key:"lotNumber",header:"Lot Number",sortable:!0},{key:"quantity",header:"Quantity",sortable:!0},{key:"itemName",header:"Item Name",sortable:!0},{key:"status",header:"Status",sortable:!0,render:e=>(0,o.jsx)("span",{className:"capitalize ".concat("completed"===e.status?"text-green-600":"inProgress"===e.status?"text-blue-600":"text-gray-600"),children:e.status})},{key:"currentOperation",header:"Current Operation",render:e=>(0,o.jsx)("div",{className:"flex items-center gap-1",children:[10,15,20,30,40].map(t=>(0,o.jsx)("div",{className:"w-6 h-6 rounded-full ".concat(em(e,t)," \n                flex items-center justify-center text-white text-xs"),children:t},t))})},{key:"modifiedDate",header:"Modified Date",sortable:!0,render:e=>(0,n.WU)(new Date(e.modifiedDate||e.createdDate),"MMM dd, yyyy - hh:mm:ss a")},{key:"actions",header:"Actions",sortable:!0,render:e=>{let t=e.editingUserId&&e.isUserDeleted;return console.log("Rendering actions for order ".concat(e.poNumber,":"),{editingUserId:e.editingUserId,currentUserId:B,isAdmin:$,isUserDeleted:e.isUserDeleted,isOrphanedLock:t}),(0,o.jsxs)("div",{className:"flex gap-2",children:[!e.editingUserId&&(0,o.jsx)(a.z,{variant:"ghost",size:"icon",onClick:t=>{t.stopPropagation(),c.push("/production-orders/".concat(e.poNumber))},children:(0,o.jsx)(p.Z,{className:"h-4 w-4"})}),e.editingUserId&&(0,o.jsx)(j,{children:(0,o.jsxs)(v,{children:[(0,o.jsx)(w,{asChild:!0,children:(0,o.jsxs)(a.z,{variant:"ghost",size:"icon",onClick:t=>{t.stopPropagation(),c.push("/production-orders/".concat(e.poNumber))},children:[e.editingUserId!==B&&(0,o.jsx)(f.Z,{className:"h-4 w-4 ".concat(t?"text-orange-500":"text-gray-600")}),e.editingUserId===B&&(0,o.jsx)(x.Z,{className:"h-4 w-4 ".concat(t?"text-orange-500":"text-green-600")})]})}),(0,o.jsx)(S,{children:t?(0,o.jsxs)("p",{children:["Locked by deleted user: ",e.editingUserName," (User ID: ",e.editingUserId,"). Click to view details."]}):e.editingUserId===B?(0,o.jsxs)("p",{children:["Locked by you: ",e.editingUserName," (User ID:"," ",e.editingUserId,"). Click to view details."]}):(0,o.jsxs)("p",{children:["Locked by ",e.editingUserName,". Click to view details."]})})]})}),$&&(0,o.jsx)(a.z,{variant:"ghost",size:"icon",onClick:t=>{t.stopPropagation(),en(e),es(!0)},children:(0,o.jsx)(y.Z,{className:"h-4 w-4 text-red-500"})})]})}}];return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(d(),{children:(0,o.jsx)("title",{children:"Production Orders - P-Chart System"})}),(0,o.jsx)(l.Z,{children:(0,o.jsxs)("div",{className:"py-6",children:[(0,o.jsx)(m.Z,{title:"Production Orders",description:"Manage your production orders here.",searchPlaceholder:"Search PO number, lot number, or item...",searchValue:N,onSearchChange:e=>{console.log("Search query changed to: ".concat(e.target.value)),b(e.target.value),M(1)},actions:(0,o.jsx)(a.z,{className:"bg-purple-600 hover:bg-purple-700 text-white",onClick:()=>c.push("/production-orders/create"),children:"Create New"})}),(0,o.jsx)(h.w,{data:C,columns:ep,keyField:"poNumber",isLoading:L,error:F||void 0,pagination:{currentPage:T,totalPages:J,totalItems:Z,itemsPerPage:V,onPageChange:e=>{console.log("Changing page to ".concat(e)),M(e)},onItemsPerPageChange:e=>{console.log("Changing items per page to ".concat(e)),Y(e),M(1)}},sortField:K,sortDirection:et,onSortChange:(e,t)=>{console.log("Sorting by ".concat(e," in ").concat(t," direction")),"actions"===e&&console.log("Actions column sorting requested: ".concat("asc"===t?"Unlocked first":"Locked first")),ee(e),er(t)},emptyMessage:"No production orders found."}),(0,o.jsx)(k,{open:eo,onOpenChange:es,children:(0,o.jsxs)(P,{children:[(0,o.jsxs)(R,{children:[(0,o.jsx)(E,{children:"Delete Production Order"}),(0,o.jsx)(z,{children:"Are you sure you want to delete this production order? This action cannot be undone."})]}),ea&&(0,o.jsxs)("div",{className:"py-4",children:[(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"PO Number:"})," ",ea.poNumber]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"Lot Number:"})," ",ea.lotNumber]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"Item Name:"})," ",ea.itemName]})]}),(0,o.jsxs)(I,{children:[(0,o.jsx)(O,{children:"Cancel"}),(0,o.jsx)(A,{onClick:eh,disabled:ei,className:"bg-red-600 hover:bg-red-700 text-white",children:ei?(0,o.jsxs)("div",{className:"flex items-center",children:[(0,o.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,o.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,o.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Deleting..."]}):"Delete"})]})]})})]})})]})}}},function(e){e.O(0,[192,664,847,859,68,164,87,888,774,179],function(){return e(e.s=69430)}),_N_E=e.O()}]);