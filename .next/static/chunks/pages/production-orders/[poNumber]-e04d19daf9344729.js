(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[410],{29327:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/production-orders/[poNumber]",function(){return r(71902)}])},45847:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});var a=r(85893),o=r(89630),s=r(5716);function n(e){let{children:t}=e;return(0,a.jsxs)("div",{className:"flex min-h-screen flex-col",children:[(0,a.jsx)(o.Z,{}),(0,a.jsx)("main",{className:"flex-1",children:(0,a.jsx)("div",{className:"container",children:t})}),(0,a.jsx)(s.Z,{})]})}},33566:function(e,t,r){"use strict";var a=r(85893);r(67294);var o=r(87764),s=r(35037);t.Z=e=>{let{title:t,description:r,searchPlaceholder:n="Search...",searchValue:i="",onSearchChange:l,actions:d}=e;return console.log("PageHeader: Rendering for ".concat(t)),(0,a.jsx)("div",{className:"w-full",children:(0,a.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl font-semibold text-purple-700",children:t}),r&&(0,a.jsx)("p",{className:"text-gray-600 mt-1",children:r})]}),(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[l&&(0,a.jsxs)("div",{className:"relative w-96",children:[(0,a.jsx)(o.Z,{className:"absolute left-2 top-2.5 h-4 w-4 text-gray-500"}),(0,a.jsx)(s.I,{type:"search",placeholder:n,className:"pl-8",value:i,onChange:l})]}),d]})]})})}},21989:function(e,t,r){"use strict";r.d(t,{RM:function(){return i},SC:function(){return l},iA:function(){return s},pj:function(){return c},ss:function(){return d},xD:function(){return n}});var a=r(85893);r(67294);var o=r(44531);function s(e){let{className:t,...r}=e;return(0,a.jsx)("div",{"data-slot":"table-container",className:"relative w-full overflow-x-auto",children:(0,a.jsx)("table",{"data-slot":"table",className:(0,o.cn)("w-full caption-bottom text-sm",t),...r})})}function n(e){let{className:t,...r}=e;return(0,a.jsx)("thead",{"data-slot":"table-header",className:(0,o.cn)("[&_tr]:border-b",t),...r})}function i(e){let{className:t,...r}=e;return(0,a.jsx)("tbody",{"data-slot":"table-body",className:(0,o.cn)("[&_tr:last-child]:border-0",t),...r})}function l(e){let{className:t,...r}=e;return(0,a.jsx)("tr",{"data-slot":"table-row",className:(0,o.cn)("hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",t),...r})}function d(e){let{className:t,...r}=e;return(0,a.jsx)("th",{"data-slot":"table-head",className:(0,o.cn)("text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",t),...r})}function c(e){let{className:t,...r}=e;return(0,a.jsx)("td",{"data-slot":"table-cell",className:(0,o.cn)("p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",t),...r})}},53355:function(e,t,r){"use strict";r.d(t,{SP:function(){return d},dr:function(){return l},mQ:function(){return i},nU:function(){return c}});var a=r(85893),o=r(67294),s=r(60434),n=r(44531);let i=s.fC,l=o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)(s.aV,{ref:t,className:(0,n.cn)("inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",r),...o})});l.displayName=s.aV.displayName;let d=o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)(s.xz,{ref:t,className:(0,n.cn)("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-blue-500 data-[state=active]:text-white data-[state=active]:shadow",r),...o})});d.displayName=s.xz.displayName;let c=o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)(s.VY,{ref:t,className:(0,n.cn)("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",r),...o})});c.displayName=s.VY.displayName},65765:function(e,t,r){"use strict";r.d(t,{g:function(){return n}});var a=r(85893),o=r(67294),s=r(44531);let n=o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)("textarea",{className:(0,s.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),ref:t,...o})});n.displayName="Textarea"},17344:function(e,t,r){"use strict";r.d(t,{a:function(){return l}});var a=r(33299),o=r(11163),s=r(67294),n=r(98225),i=r(65050);function l(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{data:t,status:r}=(0,a.useSession)(),l=(0,o.useRouter)(),{toast:d}=(0,i.pm)(),[c,u]=(0,s.useState)(!1),[p,m]=(0,s.useState)(!0),[g,h]=(0,s.useState)(null),[x,f]=(0,s.useState)(!1),{redirectTo:y="/auth/login",requiredRoles:v=[]}=e;(0,s.useEffect)(()=>{if(console.log("Auth effect running, status:",r,"verified:",x),"loading"===r||x)return;if(null==t?void 0:t.user){if(console.log("Found NextAuth session, storing to localStorage"),n.UserSession.storeSession(t.user),v.length>0){var e;let r=((null==t?void 0:null===(e=t.user)||void 0===e?void 0:e.role)||"").toLowerCase();if(!v.some(e=>e.toLowerCase()===r)){console.log("Required role not found. User role: ".concat(r)),u(!1),m(!1),h("You do not have permission to access this page"),f(!0),l.push("/dashboard");return}}u(!0),m(!1),h(null),f(!0);return}let a=n.UserSession.getSession();if(a){if(console.log("Found valid localStorage session, using as fallback"),v.length>0){let e=(a.role||"").toLowerCase();if(!v.some(t=>t.toLowerCase()===e)){console.log("Required role not found. Local user role: ".concat(e)),u(!1),m(!1),h("You do not have permission to access this page"),f(!0),l.push("/dashboard");return}}u(!0),m(!1),h(null),f(!0);return}console.log("No valid session found, redirecting to login"),l.push("".concat(y,"?callbackUrl=").concat(encodeURIComponent(window.location.href)))},[r,t,l,y,v,x]);let b=(0,s.useCallback)(()=>n.UserSession.getAuthHeaders(),[]),N=(0,s.useCallback)(async()=>n.UserSession.getCurrentUser(),[]),w=(0,s.useCallback)(e=>n.UserSession.hasRole(e),[]),j=(0,s.useCallback)(()=>{console.log("Handling expired session"),n.UserSession.clearSession(),(0,a.signOut)({redirect:!1});let e=window.location.href;l.push("".concat(y,"?callbackUrl=").concat(encodeURIComponent(e),"&expired=true"))},[y,l]),k=(0,s.useCallback)(e=>{switch(e.status){case 401:return console.log("Detected 401 unauthorized response - session likely expired"),j(),!1;case 403:return console.log("Detected 403 forbidden response - permission denied"),d({title:"Permission Denied",description:"You don't have permission to access this resource",variant:"destructive"}),!1;case 429:return console.log("Detected 429 response - rate limited"),d({title:"Rate Limited",description:"Too many requests. Please try again later.",variant:"destructive"}),!1;case 500:case 502:case 503:case 504:return console.log("Detected server error (".concat(e.status,")")),d({title:"Server Error",description:"The server encountered an error. Please try again later.",variant:"destructive"}),!1}return!0},[j,d]);return{session:t,status:r,isAuthorized:c,isLoading:p,authError:g,getAuthHeaders:b,getCurrentUser:N,hasRole:w,handleExpiredSession:j,checkResponseAuth:k}}},71902:function(e,t,r){"use strict";r.r(t),r.d(t,{__N_SSP:function(){return es},default:function(){return en}});var a=r(85893),o=r(67294),s=r(87249),n=r(11163),i=r(45847),l=r(9008),d=r.n(l),c=r(53355),u=r(17344),p=r(65050),m=r(23279),g=r.n(m),h=r(33299),x=r(33566),f=r(37622),y=r(21989),v=r(98814),b=r(64998),N=r(36467),w=r(44531);let j=e=>{let{className:t,...r}=e;return(0,a.jsx)("nav",{role:"navigation","aria-label":"pagination",className:(0,w.cn)("mx-auto flex w-full justify-center",t),...r})};j.displayName="Pagination";let k=o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)("ul",{ref:t,className:(0,w.cn)("flex flex-row items-center gap-1",r),...o})});k.displayName="PaginationContent";let q=o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)("li",{ref:t,className:(0,w.cn)("",r),...o})});q.displayName="PaginationItem";let C=e=>{let{className:t,isActive:r,size:o="icon",...n}=e;return(0,a.jsx)("a",{"aria-current":r?"page":void 0,className:(0,w.cn)((0,s.d)({variant:r?"outline":"ghost",size:o}),r&&"pointer-events-none",t),...n})};C.displayName="PaginationLink";let R=e=>{let{className:t,...r}=e;return(0,a.jsxs)(C,{"aria-label":"Go to previous page",size:"default",className:(0,w.cn)("gap-1 pl-2.5",t),...r,children:[(0,a.jsx)(v.Z,{className:"h-4 w-4"}),(0,a.jsx)("span",{children:"Previous"})]})};R.displayName="PaginationPrevious";let S=e=>{let{className:t,...r}=e;return(0,a.jsxs)(C,{"aria-label":"Go to next page",size:"default",className:(0,w.cn)("gap-1 pr-2.5",t),...r,children:[(0,a.jsx)("span",{children:"Next"}),(0,a.jsx)(b.Z,{className:"h-4 w-4"})]})};S.displayName="PaginationNext";let I=e=>{let{className:t,...r}=e;return(0,a.jsxs)("span",{"aria-hidden":!0,className:(0,w.cn)("flex h-9 w-9 items-center justify-center",t),...r,children:[(0,a.jsx)(N.Z,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"sr-only",children:"More pages"})]})};I.displayName="PaginationEllipsis";var E=r(23217),T=r(47653);function D(e){let{open:t,onClose:r,poNumber:n,operationId:i,defectId:l,type:d,title:c}=e,{getAuthHeaders:m}=(0,u.a)(),{toast:g}=(0,p.pm)(),[h,x]=(0,o.useState)(!1),[v,b]=(0,o.useState)(null),[N,w]=(0,o.useState)([]),[D,O]=(0,o.useState)({total:0,page:1,limit:10,pages:0}),L=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;x(!0),b(null),console.log("AuditLogModal: Loading audit logs - open: ".concat(t,", poNumber: ").concat(n,", operationId: ").concat(i,", defectId: ").concat(l,", type: ").concat(d));try{let t="/api/audit-logs/operations?";"defect"===d&&l?t+="defectId=".concat(l,"&"):i?t+="operationId=".concat(i,"&"):n&&(t+="poNumber=".concat(n,"&")),t+="type=".concat(d,"&limit=10&page=").concat(e),console.log("Fetching audit logs with URL:",t);let r=await fetch(t,{headers:m()});if(!r.ok){let e=await r.json();throw Error(e.error||"Failed to fetch ".concat(d," audit logs"))}let a=await r.json();console.log("Fetched ".concat(a.data.length," ").concat(d," audit logs:"),a),w(a.data),O(a.pagination)}catch(e){console.error("Error fetching ".concat(d," audit logs:"),e),b(e instanceof Error?e.message:"An unknown error occurred"),g({variant:"destructive",title:"Error",description:e instanceof Error?e.message:"Failed to load audit logs"})}finally{x(!1)}};(0,o.useEffect)(()=>{t?(console.log("AuditLogModal: Loading audit logs - open: ".concat(t,", poNumber: ").concat(n,", operationId: ").concat(i,", defectId: ").concat(l,", type: ").concat(d)),L(1)):console.log("AuditLogModal: Not open, skipping log fetch")},[t]);let A=e=>{L(e)},F=e=>new Date(e).toLocaleString(),P=e=>{if(!e||0===Object.keys(e).length)return(0,a.jsx)("span",{className:"text-gray-400 dark:text-gray-500",children:"No changes"});let t=Object.keys(e),r=[];for(let e=0;e<t.length;e+=2)e+1<t.length?r.push([t[e],t[e+1]]):r.push([t[e]]);return(0,a.jsx)("table",{className:"min-w-full text-xs border-collapse",children:(0,a.jsx)("tbody",{children:r.map((t,r)=>(0,a.jsxs)("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-900",children:[t.map(t=>(0,a.jsxs)(o.Fragment,{children:[(0,a.jsx)("td",{className:"py-1 px-2 border border-gray-200 dark:border-gray-700 font-medium bg-gray-50 dark:bg-gray-900 w-1/6",children:t}),(0,a.jsx)("td",{className:"py-1 px-2 border border-gray-200 dark:border-gray-700 w-1/3 break-words dark:text-gray-300",children:null===e[t]?(0,a.jsx)("span",{className:"text-gray-400 dark:text-gray-500",children:"null"}):String(e[t])})]},t)),1===t.length&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("td",{className:"py-1 px-2 border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 w-1/6"}),(0,a.jsx)("td",{className:"py-1 px-2 border border-gray-200 dark:border-gray-700 w-1/3"})]})]},r))})})},U=e=>{switch(e.toLowerCase()){case"create":return"text-green-600 dark:text-green-400";case"update":return"text-blue-600 dark:text-blue-400";case"delete":return"text-red-600 dark:text-red-400";default:return"text-gray-600 dark:text-gray-400"}},M=(e,t)=>{if(!e)return{};let r=["quantity","quantityRework","quantityNogood","defectName","startTime","endTime","inputQuantity","outputQuantity","rf","lineNo"];return"create"===t.toLowerCase()?e:Object.keys(e).filter(e=>r.includes(e)).reduce((t,r)=>(t[r]=e[r],t),{})};return(0,a.jsx)(f.Vq,{open:t,onOpenChange:e=>!e&&r(),children:(0,a.jsxs)(f.cZ,{className:"sm:max-w-[700px] max-h-[90vh] overflow-y-auto",children:[(0,a.jsxs)(f.fK,{children:[(0,a.jsx)(f.$N,{className:"text-xl font-semibold",children:c}),(0,a.jsxs)(f.Be,{children:["Audit logs show a history of all changes made to this ","operation"===d?"operation":"defect","."]})]}),h?(0,a.jsxs)("div",{className:"flex justify-center py-8",children:[(0,a.jsx)(E.Z,{className:"h-8 w-8 animate-spin text-gray-500 dark:text-gray-400"}),(0,a.jsx)("span",{className:"ml-2 text-gray-500 dark:text-gray-400",children:"Loading audit logs..."})]}):v?(0,a.jsxs)("div",{className:"bg-red-50 dark:bg-red-950/30 p-4 rounded-md flex items-center",children:[(0,a.jsx)(T.Z,{className:"h-5 w-5 text-red-500 dark:text-red-400 mr-2"}),(0,a.jsx)("p",{className:"text-red-600 dark:text-red-400",children:v})]}):0===N.length?(0,a.jsx)("div",{className:"bg-gray-50 dark:bg-black p-6 rounded-md text-center",children:(0,a.jsxs)("p",{className:"text-gray-500 dark:text-gray-400",children:["No audit logs found for this ","operation"===d?"operation":"defect","."]})}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(y.iA,{children:[(0,a.jsx)(y.xD,{children:(0,a.jsxs)(y.SC,{children:[(0,a.jsx)(y.ss,{className:"w-[120px]",children:"Timestamp"}),(0,a.jsx)(y.ss,{className:"w-[80px]",children:"Action"}),(0,a.jsx)(y.ss,{className:"w-[100px]",children:"User"})]})}),(0,a.jsx)(y.RM,{children:N.map(e=>(0,a.jsxs)(o.Fragment,{children:[(0,a.jsxs)(y.SC,{className:"border-t-2 border-t-gray-300 dark:border-t-gray-700",children:[(0,a.jsx)(y.pj,{className:"font-mono text-xs dark:text-gray-300",children:F(e.timestamp)}),(0,a.jsx)(y.pj,{className:U(e.action),children:e.action}),(0,a.jsx)(y.pj,{className:"dark:text-gray-300",children:e.user})]}),(0,a.jsx)(y.SC,{children:(0,a.jsxs)(y.pj,{colSpan:3,className:"p-2 bg-gray-50 dark:bg-gray-900",children:[(0,a.jsx)("div",{className:"flex items-center mb-1",children:(0,a.jsx)("div",{className:"text-xs font-medium text-gray-500 dark:text-gray-400",children:"update"===e.action.toLowerCase()?"From:":"Data:"})}),(0,a.jsx)("div",{className:"rounded border border-gray-200 dark:border-gray-700 overflow-x-auto",children:P(M("update"===e.action.toLowerCase()?e.oldValues:e.newValues||e.oldValues,e.action))})]})}),"update"===e.action.toLowerCase()&&(0,a.jsx)(y.SC,{className:"border-b-2 border-b-gray-200 dark:border-b-gray-700",children:(0,a.jsxs)(y.pj,{colSpan:3,className:"p-2 bg-gray-50 dark:bg-gray-900",children:[(0,a.jsx)("div",{className:"flex items-center mb-1",children:(0,a.jsx)("div",{className:"text-xs font-medium text-gray-500 dark:text-gray-400",children:"To:"})}),(0,a.jsx)("div",{className:"rounded border border-gray-200 dark:border-gray-700 overflow-x-auto",children:P(M(e.newValues,e.action))})]})}),"update"!==e.action.toLowerCase()&&(0,a.jsx)(y.SC,{className:"border-b-2 border-b-gray-200 dark:border-b-gray-700",children:(0,a.jsx)(y.pj,{colSpan:3,className:"p-0 h-2"})})]},e.id))})]}),D.pages>1&&(0,a.jsx)(j,{className:"mt-4",children:(0,a.jsxs)(k,{children:[(0,a.jsx)(q,{children:(0,a.jsx)(R,{onClick:()=>D.page>1&&A(D.page-1),className:D.page<=1?"pointer-events-none opacity-50":"cursor-pointer"})}),Array.from({length:Math.min(D.pages,5)},(e,t)=>{let r=D.page,s=D.pages,n=[1];return r>2&&n.push(r-1),r>1&&r<s&&n.push(r),r<s-1&&n.push(r+1),s>1&&n.push(s),(n=[...new Set(n)].sort((e,t)=>e-t)).map((e,t)=>t>0&&e>n[t-1]+1?(0,a.jsxs)(o.Fragment,{children:[(0,a.jsx)(q,{children:(0,a.jsx)(I,{})}),(0,a.jsx)(q,{children:(0,a.jsx)(C,{onClick:()=>A(e),isActive:e===r,children:e})},e)]},"ellipsis-".concat(t)):(0,a.jsx)(q,{children:(0,a.jsx)(C,{onClick:()=>A(e),isActive:e===r,children:e})},e))}),(0,a.jsx)(q,{children:(0,a.jsx)(S,{onClick:()=>D.page<D.pages&&A(D.page+1),className:D.page>=D.pages?"pointer-events-none opacity-50":"cursor-pointer"})})]})})]}),(0,a.jsx)(f.cN,{children:(0,a.jsx)(s.z,{onClick:r,children:"Close"})})]})})}function O(e){let{children:t}=e,[r,s]=(0,o.useState)(!1);return(0,o.useEffect)(()=>{s(!0)},[]),(0,a.jsx)(a.Fragment,{children:t})}var L=r(35037);function A(e){var t,r,o,n,i,l,d,c,u,p,m,g,x,f,y,v,b,N,w,j,k,q;let{activeTab:C,operationStatus:R,operationStatuses:S,rfValue:I,setRfValue:E,defects:T,isAdmin:D,orderData:O,isSubmitting:A,isCompletingOperation:F,isUpdatingDefects:P,showOperationAuditLog:U,showDefectAuditLog:M,setShowOperationAuditLog:z,setShowDefectAuditLog:Q,handleStartOperation:V,handleCompleteOperation:G}=e;console.log("Rendering OperationInfo for tab: ".concat(C,", status: ").concat(R));let{data:Z}=(0,h.useSession)();return console.log("User role in OperationInfo:",null==Z?void 0:null===(t=Z.user)||void 0===t?void 0:t.role),(0,a.jsxs)("div",{className:"bg-gray-50 dark:bg-black p-4 md:p-6 rounded-md",children:[(0,a.jsxs)("h2",{className:"text-lg font-medium mb-4 flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsxs)("span",{className:"dark:text-white",children:["[",null===(r=S[C])||void 0===r?void 0:r.operationId,"] Operation Information"]}),(null===(o=S[C])||void 0===o?void 0:o.isCompleted)&&!D&&(0,a.jsxs)("div",{className:"ml-2 bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-300 text-xs px-2 py-1 rounded-md flex items-center",children:[(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-1",children:[(0,a.jsx)("rect",{x:"3",y:"11",width:"18",height:"11",rx:"2",ry:"2"}),(0,a.jsx)("path",{d:"M7 11V7a5 5 0 0 1 10 0v4"})]}),"View Only"]})]}),(0,a.jsx)("span",{className:"text-sm font-normal text-gray-500 dark:text-gray-400",children:R})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6",children:[(0,a.jsxs)("div",{className:"border border-gray-200 dark:border-gray-800 rounded-md p-3 bg-white dark:bg-gray-950",children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1",children:"Start Time"}),(0,a.jsx)("div",{className:"text-sm font-medium dark:text-white",children:C&&(null===(n=S[C])||void 0===n?void 0:n.startTime)?new Date(S[C].startTime).toLocaleString():"Not started"})]}),(0,a.jsxs)("div",{className:"border border-gray-200 dark:border-gray-800 rounded-md p-3 bg-white dark:bg-gray-950",children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1",children:(null===(i=S[C])||void 0===i?void 0:i.endTime)?"End Time":"Status"}),(0,a.jsx)("div",{className:"text-sm font-medium dark:text-white",children:C&&(null===(l=S[C])||void 0===l?void 0:l.endTime)?new Date(S[C].endTime).toLocaleString():(null===(d=S[C])||void 0===d?void 0:d.isStarted)?"In progress":"Not started"})]}),(0,a.jsxs)("div",{className:"border border-gray-200 dark:border-gray-800 rounded-md p-3 bg-white dark:bg-gray-950",children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1",children:"Input Quantity"}),(0,a.jsx)("div",{className:"text-sm font-medium dark:text-white",children:C&&(null===(c=S[C])||void 0===c?void 0:c.inputQuantity)||0})]}),(0,a.jsxs)("div",{className:"border border-gray-200 dark:border-gray-800 rounded-md p-3 bg-white dark:bg-gray-950",children:[(0,a.jsxs)("label",{className:"block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1",children:["Output Quantity",P&&(0,a.jsx)("span",{className:"ml-2 inline-block animate-pulse text-amber-500 dark:text-amber-400",children:"Updating..."})]}),(0,a.jsx)("div",{className:"text-sm font-medium text-purple-700 dark:text-purple-400",children:C&&(null===(u=S[C])||void 0===u?void 0:u.isStarted)?(null===(p=S[C])||void 0===p?void 0:p.outputQuantity)!==null?null===(m=S[C])||void 0===m?void 0:m.outputQuantity:"Calculating...":"-"}),T.filter(e=>e.quantity>0).length>0&&(0,a.jsxs)("div",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{children:"Input:"}),(0,a.jsx)("span",{children:(null===(g=S[C])||void 0===g?void 0:g.inputQuantity)||0})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{children:"Total Defects:"}),(0,a.jsx)("span",{children:T.reduce((e,t)=>e+t.quantity,0)})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{children:"Reworkable:"}),(0,a.jsx)("span",{children:T.reduce((e,t)=>e+(t.reworkable?t.quantityRework:0),0)})]}),(0,a.jsxs)("div",{className:"flex justify-between font-medium dark:text-gray-300",children:[(0,a.jsx)("span",{children:"Effective Loss:"}),(0,a.jsx)("span",{children:T.reduce((e,t)=>e+(t.reworkable?t.quantity-t.quantityRework:t.quantity),0)})]}),(0,a.jsxs)("div",{className:"flex justify-between font-medium text-blue-600 dark:text-blue-400 mt-1",children:[(0,a.jsx)("span",{children:"Replacements:"}),(0,a.jsx)("span",{children:T.reduce((e,t)=>e+(t.quantityReplacement||0),0)})]})]})]})]}),(null===(x=S[C])||void 0===x?void 0:x.isStarted)&&!(null===(f=S[C])||void 0===f?void 0:f.isCompleted)&&(0,a.jsxs)("div",{className:"border border-gray-200 dark:border-gray-800 rounded-md p-3 bg-white dark:bg-gray-950 col-span-1 sm:col-span-2",children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1",children:"Resource Factor (RF)"}),(0,a.jsx)(L.I,{type:"number",min:"1",className:"mb-1 dark:bg-black",value:I,onChange:e=>E(e.target.value),placeholder:"Enter RF value"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[!(null===(y=S[C])||void 0===y?void 0:y.startTime)&&(null==Z?void 0:null===(b=Z.user)||void 0===b?void 0:null===(v=b.role)||void 0===v?void 0:v.toLowerCase())!=="viewer"&&(0,a.jsx)(s.z,{onClick:V,className:"bg-purple-600 hover:bg-purple-700 dark:bg-purple-700 dark:hover:bg-purple-800 text-white w-full",disabled:A||!D&&(null==O?void 0:O.status)==="completed",children:A?(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("span",{className:"animate-spin mr-2",children:"⟳"})," Starting..."]}):"Start Operation"}),(null===(N=S[C])||void 0===N?void 0:N.isStarted)&&!(null===(w=S[C])||void 0===w?void 0:w.isCompleted)&&(null==Z?void 0:null===(k=Z.user)||void 0===k?void 0:null===(j=k.role)||void 0===j?void 0:j.toLowerCase())!=="viewer"&&(0,a.jsx)(s.z,{onClick:G,className:"bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 text-white w-full",disabled:F||!D&&(null==O?void 0:O.status)==="completed",children:"End Operation"}),!D&&(null===(q=S[C])||void 0===q?void 0:q.isCompleted)&&(0,a.jsx)("div",{className:"mt-2 text-sm text-amber-600 dark:text-amber-400",children:"Admin access required to edit completed operations"})]}),D&&(0,a.jsxs)("div",{className:"flex items-center justify-between mt-5 pt-4 border-t border-gray-200 dark:border-gray-800",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Audit Logs:"}),(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsxs)("button",{onClick:()=>z(!0),className:"text-xs text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 flex items-center",title:"View Operation Audit Logs",children:[(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-1",children:[(0,a.jsx)("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),(0,a.jsx)("polyline",{points:"14 2 14 8 20 8"}),(0,a.jsx)("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),(0,a.jsx)("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),(0,a.jsx)("polyline",{points:"10 9 9 9 8 9"})]}),"Operation"]}),(0,a.jsxs)("button",{onClick:()=>Q(!0),className:"text-xs text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 flex items-center",title:"View Defect Audit Logs",children:[(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-1",children:[(0,a.jsx)("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),(0,a.jsx)("polyline",{points:"14 2 14 8 20 8"}),(0,a.jsx)("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),(0,a.jsx)("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),(0,a.jsx)("polyline",{points:"10 9 9 9 8 9"})]}),"Defects"]})]})]})]})}var F=r(51853),P=r(87764),U=r(13718),M=r(65765),z=r(88055);let Q=z.fC,V=z.xz,G=o.forwardRef((e,t)=>{let{className:r,align:o="center",sideOffset:s=4,...n}=e;return(0,a.jsx)(z.h_,{children:(0,a.jsx)(z.VY,{ref:t,align:o,sideOffset:s,className:(0,w.cn)("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r),...n})})});G.displayName=z.VY.displayName;var Z=r(90470),B=r(98225),W=r(3332);function J(e){let{defect:t,operationCode:r,poNumber:n,disabled:i=!1,onClose:l}=e,{toast:d}=(0,p.pm)(),{socket:c,isConnected:u,emit:m}=(0,W.lm)(),g=o.useMemo(()=>t.defectName||t.name,[t.defectName,t.name]),h=o.useMemo(()=>t.defectCategory||t.category,[t.defectCategory,t.category]),x=o.useMemo(()=>t.defectMachine||t.machine,[t.defectMachine,t.machine]),f=o.useMemo(()=>void 0!==t.defectReworkable?t.defectReworkable:t.reworkable,[t.defectReworkable,t.reworkable]),[y,v]=(0,o.useState)(()=>({quantity:t.quantity,quantityRework:t.quantityRework,quantityNogood:t.quantityNogood,quantityReplacement:void 0!==t.quantityReplacement?t.quantityReplacement:t.quantity})),b=o.useMemo(()=>0===y.quantity,[y.quantity]),N=o.useMemo(()=>y.quantity!==t.quantity||y.quantityRework!==t.quantityRework||y.quantityNogood!==t.quantityNogood||"op10"===r.toLowerCase()&&y.quantityReplacement!==(void 0!==t.quantityReplacement?t.quantityReplacement:t.quantity),[y,t.quantity,t.quantityRework,t.quantityNogood,t.quantityReplacement,r]);(0,o.useEffect)(()=>(console.log("DefectEditRequestPopover mounted for defect:",{id:t.id,name:t.name||t.defectName,category:t.category||t.defectCategory,operationDefectId:t.operationDefectId}),v({quantity:t.quantity,quantityRework:t.quantityRework,quantityNogood:t.quantityNogood,quantityReplacement:void 0!==t.quantityReplacement?t.quantityReplacement:t.quantity}),console.log("Operation code:",r),console.log("PO number:",n),()=>{console.log("DefectEditRequestPopover unmounted")}),[t.category,t.defectCategory,t.defectName,t.id,t.name,t.operationId,t.quantity,t.quantityRework,t.quantityNogood,t.quantityReplacement,r,n]);let[w,j]=(0,o.useState)(!1),[k,q]=(0,o.useState)(""),[C,R]=(0,o.useState)(!1),[S,I]=(0,o.useState)(null),[E,T]=(0,o.useState)(!1),D=(0,o.useCallback)(()=>{I(null),v({quantity:t.quantity,quantityRework:t.quantityRework,quantityNogood:t.quantityNogood,quantityReplacement:void 0!==t.quantityReplacement?t.quantityReplacement:t.quantity}),q("")},[t.quantity,t.quantityRework,t.quantityNogood,t.quantityReplacement]),O=(0,o.useCallback)(async()=>{try{if(T(!0),console.log("[fetchExistingRequest] Fetching existing requests for defect:",t),!t.operationDefectId){console.log("[fetchExistingRequest] No operationDefectId available, skipping fetch"),D(),T(!1);return}let r=Number(t.operationDefectId);if(isNaN(r)){console.log("[fetchExistingRequest] Invalid operationDefectId, skipping fetch"),D(),T(!1);return}let a="operationDefectId=".concat(r);console.log("[fetchExistingRequest] Using query param for fetch:",a);let o=await fetch("/api/operation-defect-edit-requests?".concat(a),{method:"GET",headers:{...B.UserSession.getAuthHeaders()}});if(!o.ok)throw Error("[fetchExistingRequest] Failed to fetch existing requests");let s=await o.json();if(console.log("[fetchExistingRequest] Existing requests response:",s),s.editRequests&&s.editRequests.length>0){console.log("[fetchExistingRequest] All edit requests with statuses:",s.editRequests.map(e=>({id:e.id,operationDefectId:e.operationDefectId,status:e.status})));let r=s.editRequests.filter(e=>e.operationDefectId===(t.operationDefectId?Number(t.operationDefectId):Number(t.id)));if(0===r.length){console.log("[fetchExistingRequest] No requests with matching operationDefectId ".concat(t.operationDefectId," found. All requests have different IDs.")),D();return}console.log("[fetchExistingRequest] Matching requests by operationDefectId:",r.length);let a=r.filter(e=>"pending"===e.status);if(console.log("[fetchExistingRequest] Pending requests found:",a.length),a.length>0){var e;let t=a[0];console.log("[fetchExistingRequest] Using pending request:",t),console.log("[fetchExistingRequest] Pending request requestedBy type:",typeof t.requestedBy),console.log("[fetchExistingRequest] Pending request requestedBy value:",t.requestedBy);let r={id:(null===(e=t.id)||void 0===e?void 0:e.toString())||"",requestedQty:Number(t.requestedQty)||0,requestedRw:Number(t.requestedRw)||0,requestedNg:Number(t.requestedNg)||0,requestedReplacement:Number(t.requestedReplacement)||0,reason:t.reason||"",requestedBy:t.requestedBy||"Unknown",status:t.status||"pending"};console.log("[fetchExistingRequest] Processed request:",r),I(r),v({quantity:r.requestedQty,quantityRework:r.requestedRw,quantityNogood:r.requestedNg,quantityReplacement:r.requestedReplacement||r.requestedQty}),q(r.reason||""),t.requestType&&console.log("[fetchExistingRequest] Existing request type:",t.requestType)}else console.log("[fetchExistingRequest] No pending requests found"),D()}else console.log("[fetchExistingRequest] No edit requests found in response"),D()}catch(e){console.error("[fetchExistingRequest] Error fetching existing requests:",e),d({title:"Error",description:"Failed to check for existing edit requests",variant:"destructive"}),D()}finally{T(!1)}},[t.id,t.operationDefectId,t.quantity,t.quantityRework,t.quantityNogood,t.quantityReplacement,D,d]);(0,o.useEffect)(()=>{w&&O()},[w,O]);let A=(e,t)=>{console.log("Updating ".concat(e," to ").concat(t)),v(a=>{let o={...a};if("quantity"===e&&(o.quantity=t,0===t?(o.quantityRework=0,o.quantityNogood=0,o.quantityReplacement=0):(o.quantityRework=0,o.quantityNogood=t,"op10"===r.toLowerCase()&&(o.quantityReplacement=t,console.log("OP10 detected: Setting replacement to match quantity: ".concat(t))))),"quantityRework"===e){let e=Math.min(t,a.quantity);o.quantityRework=e,o.quantityNogood=a.quantity-e}if("quantityNogood"===e){let e=Math.min(t,a.quantity);o.quantityNogood=e,o.quantityRework=a.quantity-e}return"quantityReplacement"===e&&(o.quantityReplacement=t),o})},F=async()=>{if(N&&k.trim()&&!C){R(!0);try{if(console.log("Submitting edit request for defect:",t.id,t.defectName||t.name),console.log("Is delete request:",b),S){let e=0===S.requestedQty;e!==b&&console.log("Request type changed: from ".concat(e?"delete":"edit"," to ").concat(b?"delete":"edit"))}let a=t.operationDefectId||t.id;console.log("Using operation defect ID for submission:",a),console.log("".concat(S?"Updating":"Creating"," edit request"));let o={operationDefectId:a,defectName:t.defectName||t.name,poNumber:n,currentQty:t.quantity,currentRw:t.quantityRework,currentNg:t.quantityNogood,currentReplacement:void 0!==t.quantityReplacement?t.quantityReplacement:t.quantity,requestedQty:y.quantity,requestedRw:y.quantityRework,requestedNg:y.quantityNogood,requestedReplacement:y.quantityReplacement,reason:k,requestType:b?"delete":"edit",operationCode:r,...S&&{requestId:S.id}};console.log("Request payload:",o),console.log("Request type being sent:",b?"delete":"edit"),S&&console.log("Updating existing request ID:",S.id);let s=await fetch("/api/operation-defect-edit-requests",{method:"POST",headers:{"Content-Type":"application/json",...B.UserSession.getAuthHeaders()},body:JSON.stringify(o)});if(console.log("Response status:",s.status),!s.ok){let e=await s.json();throw console.error("Error response:",e),Error(e.error||"Failed to submit edit request (".concat(s.status,")"))}let i=await s.json();if(console.log("Success response:",i),u&&c){var e;console.log("Emitting defect-edit-requested event via WebSocket for real-time updates");let r=await B.UserSession.getCurrentUser();m("defect-edit-requested",{id:null===(e=i.editRequest)||void 0===e?void 0:e.id,operationDefectId:a,defectName:t.defectName||t.name,poNumber:n,requestedQty:y.quantity,requestedById:null==r?void 0:r.id,userName:null==r?void 0:r.name,userRole:null==r?void 0:r.role,createdAt:new Date().toISOString()})}else console.warn("Socket not connected, only server-side notification will be created");d({title:S?"Edit request updated":b?"Delete request submitted":"Edit request submitted",description:i.message||(S?"Your request has been updated":b?"Your request to delete this defect has been sent to admin for approval":"Your request has been sent to admin for approval")}),P(),l&&l(),q(""),v({quantity:t.quantity,quantityRework:t.quantityRework,quantityNogood:t.quantityNogood,quantityReplacement:void 0!==t.quantityReplacement?t.quantityReplacement:t.quantity})}catch(e){console.error("Error submitting edit request:",e),d({title:"Error",description:e instanceof Error?e.message:"Failed to submit request",variant:"destructive"})}finally{R(!1)}}},P=()=>{j(!1),l&&l()},z=o.useCallback(e=>{j(e),!e&&l&&l()},[l]);return(0,a.jsxs)(Q,{open:w,onOpenChange:z,children:[(0,a.jsx)(V,{asChild:!0,children:(0,a.jsxs)(s.z,{variant:"ghost",size:"icon",className:"text-white hover:text-white-800 bg-primary/80 hover:bg-primary/100 h-5 w-5 p-1 -mt-1 -mr-1 rounded-full border border-primay",disabled:i,children:[(0,a.jsx)(Z.Z,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"sr-only",children:"Request edit permission"})]})}),w&&(0,a.jsx)(G,{className:"w-80",children:E?(0,a.jsx)("div",{className:"flex justify-center py-4",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"})}):(0,a.jsxs)("div",{className:"space-y-4 max-h-[40vh] overflow-y-auto pr-1",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"font-medium text-lg",children:b?"Request Delete Permission":"Request Edit Permission"}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:g}),(0,a.jsxs)("p",{className:"text-xs text-gray-400",children:[h,x&&" | Machine: ".concat(x)]})]}),S&&(0,a.jsxs)("div",{className:"bg-amber-50 border border-amber-200 rounded-md p-3",children:[(0,a.jsx)("div",{className:"font-medium text-amber-700",children:"Pending Request Exists"}),(0,a.jsxs)("p",{className:"text-sm text-amber-600",children:["There is already a pending request submitted by"," ","object"==typeof S.requestedBy?S.requestedBy.name:S.requestedBy,". You can update it below."]})]}),b&&(0,a.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-md p-3",children:[(0,a.jsx)("div",{className:"font-medium text-red-700",children:"Delete Request"}),(0,a.jsx)("p",{className:"text-sm text-red-600",children:"Setting quantity to zero will request deletion of this defect. Admin approval is required."})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)("div",{className:"text-sm font-medium mb-1",children:"Requested Value *"}),!b&&(0,a.jsxs)(s.z,{variant:"ghost",size:"sm",className:"text-red-600 hover:text-red-800 hover:bg-red-50 h-7 px-2 py-1",onClick:()=>{v({quantity:0,quantityRework:0,quantityNogood:0,quantityReplacement:0})},children:[(0,a.jsx)(U.Z,{className:"h-3.5 w-3.5 mr-1"}),(0,a.jsx)("span",{className:"text-xs",children:"Delete"})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 mb-1",children:"QTY"}),(0,a.jsx)(L.I,{type:"number",min:"0",className:"h-9 ".concat(b?"border-red-300 focus:ring-red-500":""),value:y.quantity,onChange:e=>A("quantity",parseInt(e.target.value)||0)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 mb-1",children:"RW"}),(0,a.jsx)(L.I,{type:"number",min:"0",className:"h-9 ".concat(f?"":"bg-gray-100"," ").concat(b?"bg-gray-100":""),value:y.quantityRework,onChange:e=>A("quantityRework",parseInt(e.target.value)||0),disabled:!f||b})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 mb-1",children:"NG"}),(0,a.jsx)(L.I,{type:"number",min:"0",className:"h-9 ".concat(b?"bg-gray-100":""),value:y.quantityNogood,onChange:e=>A("quantityNogood",parseInt(e.target.value)||0),disabled:b})]})]}),"op10"===r.toLowerCase()&&(0,a.jsx)("div",{className:"grid grid-cols-3 gap-2 mt-2",children:(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 mb-1",children:"RP"}),(0,a.jsx)(L.I,{type:"number",min:"0",max:y.quantity,className:"h-9 border-blue-300 focus:ring-blue-500 ".concat(b?"bg-gray-100":""),value:y.quantityReplacement,onChange:e=>A("quantityReplacement",parseInt(e.target.value)||0),disabled:b})]})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm font-medium mb-1",children:"Reason for Change *"}),(0,a.jsx)(M.g,{placeholder:b?"Provide a detailed reason for this deletion request":"Provide a detailed reason for this change request",className:"resize-none",value:k,onChange:e=>q(e.target.value)})]}),(0,a.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,a.jsx)(s.z,{variant:"outline",size:"sm",onClick:P,children:"Cancel"}),(0,a.jsx)(s.z,{size:"sm",onClick:F,disabled:!N||!k.trim()||C,className:b?"bg-red-600 hover:bg-red-700":"",children:C?"Submitting...":S?"Update Request":b?"Request Delete":"Submit Request"})]})]})})]})}var Y=r(45657),_=r(77705);function H(e){let{open:t,onClose:r,operationId:n,operationCode:i,poNumber:l,onRefresh:d,isAdmin:c}=e,[u,m]=(0,o.useState)([]),[g,h]=(0,o.useState)(!1),{toast:x}=(0,p.pm)();(0,o.useEffect)(()=>{t&&n&&y()},[t,n]);let y=async()=>{if(n){h(!0);try{console.log("Fetching pending requests for operation ".concat(n));let e=await fetch("/api/operation-defect-edit-requests?operationId=".concat(n,"&status=pending"),{method:"GET",headers:{...B.UserSession.getAuthHeaders()}});if(!e.ok)throw Error("Failed to fetch pending requests (".concat(e.status,")"));let t=await e.json();console.log("Pending requests response:",t),t.editRequests&&Array.isArray(t.editRequests)&&m(t.editRequests)}catch(e){console.error("Error fetching pending requests:",e),x({title:"Error",description:"Failed to load pending defect requests",variant:"destructive"})}finally{h(!1)}}},v=async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(c)try{console.log("".concat(t," request ").concat(e," with comment: ").concat(r));let a=await fetch("/api/operation-defect-edit-requests/".concat(e,"/resolve"),{method:"PUT",headers:{"Content-Type":"application/json",...B.UserSession.getAuthHeaders()},body:JSON.stringify({status:t,comments:r})});if(!a.ok){let e=await a.json();throw Error(e.error||"Failed to ".concat(t," request"))}x({title:"Success",description:"Request ".concat(t," successfully")}),y(),d()}catch(e){console.error("Error ".concat(t," request:"),e),x({title:"Error",description:e instanceof Error?e.message:"Failed to ".concat(t," request"),variant:"destructive"})}},b=e=>{switch(e){case"add":return(0,a.jsx)(Y.Z,{className:"w-4 h-4 text-green-500"});case"edit":return(0,a.jsx)(_.Z,{className:"w-4 h-4 text-blue-500"});case"delete":return(0,a.jsx)(U.Z,{className:"w-4 h-4 text-red-500"});default:return(0,a.jsx)(_.Z,{className:"w-4 h-4 text-gray-500"})}},N=e=>{switch(e){case"add":return"Add";case"edit":return"Edit";case"delete":return"Delete";default:return"Update"}},w=e=>{switch(e){case"add":return"border-l-green-400 bg-green-50 dark:bg-green-950/30 dark:border-l-green-600";case"edit":return"border-l-blue-400 bg-blue-50 dark:bg-blue-950/30 dark:border-l-blue-600";case"delete":return"border-l-red-400 bg-red-50 dark:bg-red-950/30 dark:border-l-red-600";default:return"border-l-purple-400 bg-purple-50 dark:bg-purple-950/30 dark:border-l-purple-600"}};return(0,a.jsx)(f.Vq,{open:t,onOpenChange:e=>!e&&r(),children:(0,a.jsxs)(f.cZ,{className:"sm:max-w-lg max-h-[85vh] overflow-hidden flex flex-col",children:[(0,a.jsx)(f.fK,{children:(0,a.jsx)(f.$N,{className:"flex items-center gap-2",children:(0,a.jsx)("span",{children:"Pending Defect Requests"})})}),(0,a.jsx)("div",{className:"py-4 overflow-y-auto pr-1",children:g?(0,a.jsx)("div",{className:"flex justify-center py-8",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-white"})}):0===u.length?(0,a.jsx)("div",{className:"text-center py-6 bg-gray-50 dark:bg-black rounded-md border border-gray-200 dark:border-gray-800",children:(0,a.jsx)("p",{className:"text-gray-500 dark:text-gray-400",children:"No pending defect requests for this operation."})}):(0,a.jsx)("div",{className:"space-y-4",children:u.map(e=>{var t,r,o,n,i,l,d;return(0,a.jsx)("div",{className:"border border-l-4 rounded-md p-4 bg-white dark:bg-black shadow-sm ".concat(w(e.requestType)),children:(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[b(e.requestType),(0,a.jsxs)("span",{className:"font-medium text-sm uppercase dark:text-gray-300",children:[N(e.requestType)," Request"]})]}),(0,a.jsx)("h3",{className:"font-medium text-md dark:text-white",children:"add"===e.requestType?e.defectName:(null===(t=e.operationDefect)||void 0===t?void 0:t.defectName)||e.defectName||"Unknown Defect"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"add"===e.requestType?e.defectCategory:(null===(r=e.operationDefect)||void 0===r?void 0:r.defectCategory)||e.defectCategory||"Unknown Category"}),("add"===e.requestType?e.defectMachine:null===(o=e.operationDefect)||void 0===o?void 0:o.defectMachine)&&(0,a.jsxs)("p",{className:"text-xs text-gray-400 dark:text-gray-500",children:["Machine:"," ","add"===e.requestType?e.defectMachine:null===(n=e.operationDefect)||void 0===n?void 0:n.defectMachine]}),("add"===e.requestType?e.defectReworkable:null===(i=e.operationDefect)||void 0===i?void 0:i.defectReworkable)===!0&&(0,a.jsx)("p",{className:"text-xs text-green-500 dark:text-green-400 mt-1",children:"Reworkable"}),(0,a.jsxs)("div",{className:"mt-2 text-sm dark:text-gray-300",children:[(0,a.jsxs)("p",{children:["Requested by: ",(null===(l=e.requestedBy)||void 0===l?void 0:l.name)||"Unknown"]}),(0,a.jsxs)("p",{children:["Reason: ",e.reason]}),(0,a.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:new Date(e.createdAt).toLocaleString()})]})]}),(0,a.jsxs)("div",{className:"sm:text-right",children:["delete"!==e.requestType&&(0,a.jsxs)("div",{className:"grid grid-cols-4 gap-2 mb-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"QTY"}),(0,a.jsxs)("div",{className:"flex flex-col",children:["edit"===e.requestType&&(0,a.jsx)("div",{className:"text-xs text-gray-400 dark:text-gray-500 line-through",children:e.currentQty}),(0,a.jsx)("div",{className:"font-medium dark:text-white",children:e.requestedQty})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"RW"}),(0,a.jsxs)("div",{className:"flex flex-col",children:["edit"===e.requestType&&(0,a.jsx)("div",{className:"text-xs text-gray-400 dark:text-gray-500 line-through",children:e.currentRw}),(0,a.jsx)("div",{className:"font-medium dark:text-white",children:e.requestedRw})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"NG"}),(0,a.jsxs)("div",{className:"flex flex-col",children:["edit"===e.requestType&&(0,a.jsx)("div",{className:"text-xs text-gray-400 dark:text-gray-500 line-through",children:e.currentNg}),(0,a.jsx)("div",{className:"font-medium dark:text-white",children:e.requestedNg})]})]}),(null===(d=e.operationCode)||void 0===d?void 0:d.toLowerCase())==="op10"&&(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-blue-500 dark:text-blue-400",children:"RP"}),(0,a.jsxs)("div",{className:"flex flex-col",children:["edit"===e.requestType&&(0,a.jsx)("div",{className:"text-xs text-gray-400 dark:text-gray-500 line-through",children:void 0!==e.currentReplacement?e.currentReplacement:e.currentQty}),(0,a.jsx)("div",{className:"font-medium text-blue-600 dark:text-blue-400",children:void 0!==e.requestedReplacement?e.requestedReplacement:e.requestedQty})]})]})]}),"delete"===e.requestType&&(0,a.jsx)("div",{className:"text-sm font-medium text-red-500 dark:text-red-400 mb-2",children:"Request to delete this defect"}),c&&(0,a.jsxs)("div",{className:"flex flex-row gap-2 justify-end mt-3",children:[(0,a.jsx)(s.z,{size:"sm",variant:"outline",className:"text-red-600 hover:text-red-800 hover:bg-red-50 dark:text-red-400 dark:hover:text-red-300 dark:hover:bg-red-950/30 border-red-200 dark:border-red-800",onClick:()=>v(e.id,"rejected","Request rejected"),children:"Reject"}),(0,a.jsx)(s.z,{size:"sm",variant:"outline",className:"text-green-600 hover:text-green-800 hover:bg-green-50 dark:text-green-400 dark:hover:text-green-300 dark:hover:bg-green-950/30 border-green-200 dark:border-green-800",onClick:()=>v(e.id,"approved"),children:"Approve"})]})]})]})},e.id)})})})]})})}function K(e){var t,r;let{activeTab:n,defects:i,isAdmin:l,operationStatuses:d,isUpdatingDefects:c,isLoadingDefects:u,poNumber:p,handleDefectQuantityChange:m,refreshDefectsForOperationCallback:g,selectedDefectId:x,selectedDefectName:y,setSelectedDefectId:v,setSelectedDefectName:b,setShowDefectItemAuditLog:N,deleteDefect:w,masterDefects:j,isLoadingMasterDefects:k,handleAddDefect:q,existingDefects:C}=e,[R,S]=(0,o.useState)(null),[I,E]=(0,o.useState)(""),[T,D]=(0,o.useState)(!1),[O,A]=(0,o.useState)(0),{data:M}=(0,h.useSession)();console.log("User role in OperationDefectsList:",null==M?void 0:null===(t=M.user)||void 0===t?void 0:t.role);let z=i.filter(e=>null!==e.operationDefectId),Q=""===I.trim()?z:z.filter(e=>e.name.toLowerCase().includes(I.toLowerCase())||e.category.toLowerCase().includes(I.toLowerCase())||e.machine&&e.machine.toLowerCase().includes(I.toLowerCase()));console.log("Rendering OperationDefectsList for tab: ".concat(n,", defects count: ").concat(z.length,", filtered count: ").concat(Q.length)),(0,o.useEffect)(()=>{var e;(null===(e=d[n])||void 0===e?void 0:e.operationId)&&V()},[n,d]);let V=async()=>{try{var e;let t=null===(e=d[n])||void 0===e?void 0:e.operationId;if(!t)return;let r=await fetch("/api/operation-defect-edit-requests?operationId=".concat(t,"&status=pending&count=true"),{method:"GET",headers:{...B.UserSession.getAuthHeaders()}});if(!r.ok)throw Error("Failed to fetch pending requests count (".concat(r.status,")"));let a=await r.json();console.log("Pending requests count:",a.count),void 0!==a.count&&A(a.count)}catch(e){console.error("Error fetching pending requests count:",e)}},G=e=>{let t=i.find(t=>t.id===e);t&&S({id:t.id,name:t.name})};return(0,a.jsxs)("div",{children:[(0,a.jsx)(f.Vq,{open:!!R,onOpenChange:e=>!e&&S(null),children:(0,a.jsxs)(f.cZ,{className:"sm:max-w-md",children:[(0,a.jsxs)(f.fK,{children:[(0,a.jsxs)(f.$N,{className:"flex items-center gap-2",children:[(0,a.jsx)(F.Z,{className:"h-5 w-5 text-red-500"}),"Confirm Delete"]}),(0,a.jsxs)(f.Be,{children:['Are you sure you want to delete the defect "',null==R?void 0:R.name,'"? This action cannot be undone.']})]}),(0,a.jsxs)(f.cN,{className:"flex flex-row justify-end gap-2 sm:justify-end",children:[(0,a.jsx)(s.z,{type:"button",variant:"outline",onClick:()=>{S(null)},children:"Cancel"}),(0,a.jsx)(s.z,{type:"button",variant:"destructive",onClick:()=>{R&&w&&(w(R.id),S(null))},children:"Delete"})]})]})}),(0,a.jsx)(H,{open:T,onClose:()=>D(!1),operationId:null===(r=d[n])||void 0===r?void 0:r.operationId,operationCode:n,poNumber:"string"==typeof p?p:Array.isArray(p)?p[0]:"",onRefresh:()=>{V(),g()},isAdmin:l}),(0,a.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)("div",{className:"relative w-40",children:[(0,a.jsx)("div",{className:"absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none",children:(0,a.jsx)(P.Z,{className:"h-3.5 w-3.5 text-gray-500 dark:text-gray-400"})}),(0,a.jsx)(L.I,{type:"search",placeholder:"Search recorded...",className:"h-7 pl-8 text-xs w-full",value:I,onChange:e=>E(e.target.value)})]}),(0,a.jsx)("h3",{className:"text-sm font-medium dark:text-white",children:"Recorded Defects"}),O>0&&(0,a.jsxs)(s.z,{variant:"ghost",size:"sm",className:"h-7 text-xs px-2 flex items-center gap-1 text-purple-600 dark:text-purple-400",onClick:()=>D(!0),children:[(0,a.jsx)("span",{children:"Pending Requests"}),(0,a.jsx)("span",{className:"bg-purple-100 text-purple-600 dark:bg-purple-900 dark:text-purple-300 text-xs font-medium px-2 py-0.5 rounded-full",children:O})]})]}),(0,a.jsxs)("div",{className:"flex items-center",children:[c&&(0,a.jsx)("span",{className:"mr-2 text-amber-500 animate-pulse",children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,a.jsx)("path",{d:"M21 12a9 9 0 1 1-6.219-8.56"})})}),(0,a.jsxs)("span",{className:"text-sm font-medium dark:text-white",children:["Total:"," ",Q.reduce((e,t)=>e+t.quantity,0)]})]})]}),u?(0,a.jsx)("div",{className:"flex justify-center py-8",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-white"})}):(0,a.jsxs)("div",{className:"space-y-2",children:[Q.map(e=>{var t,r,o,i,c,u,h,x,f,y,j,k,q,C,R;return(0,a.jsxs)("div",{className:"border-l-4 border-l-purple-400 bg-purple-50 dark:bg-black dark:border-l-purple-600 p-3 rounded-md shadow-sm transition-all hover:shadow relative",children:[!l&&(null==M?void 0:null===(r=M.user)||void 0===r?void 0:null===(t=r.role)||void 0===t?void 0:t.toLowerCase())!=="viewer"&&(null===(o=d[n])||void 0===o?void 0:o.isCompleted)&&(console.log("Rendering DefectEditRequestPopover for defect:",{id:e.id,name:e.name,category:e.category,machine:e.machine,operationId:null===(C=d[n])||void 0===C?void 0:C.operationId,operationDefectId:e.operationDefectId}),(0,a.jsxs)("div",{className:"absolute top-0 right-2 flex items-center",children:[w&&l&&(0,a.jsx)(s.z,{variant:"ghost",size:"icon",className:"h-8 w-8 mr-1 text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950/30 dark:text-red-400 dark:hover:text-red-300",onClick:()=>G(e.id),title:"Delete defect",children:(0,a.jsx)(U.Z,{className:"h-4 w-4"})}),(0,a.jsx)(J,{defect:{id:e.id,name:e.name,operationId:(null===(R=d[n])||void 0===R?void 0:R.operationId)||0,operationDefectId:e.operationDefectId,defectName:e.name,defectCategory:e.category,defectMachine:e.machine,defectReworkable:e.reworkable,quantity:e.quantity,quantityRework:e.quantityRework,quantityNogood:e.quantityNogood},operationCode:n,poNumber:p,onClose:g})]})),w&&(l||!(null===(i=d[n])||void 0===i?void 0:i.isCompleted))&&!(!l&&(null===(c=d[n])||void 0===c?void 0:c.isCompleted))&&(0,a.jsx)("div",{className:"absolute top-0 right-2",children:(0,a.jsx)(s.z,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950/30 dark:text-red-400 dark:hover:text-red-300",onClick:()=>G(e.id),title:"Delete defect",children:(0,a.jsx)(U.Z,{className:"h-4 w-4"})})}),(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row",children:[(0,a.jsxs)("div",{className:"w-full sm:w-1/2 pr-0 sm:pr-3 mb-3 sm:mb-0",children:[(0,a.jsxs)("div",{className:"font-medium flex items-center",children:[(0,a.jsx)("span",{className:"w-2 h-2 bg-purple-500 dark:bg-purple-400 rounded-full mr-2 flex-shrink-0"}),(0,a.jsxs)("div",{className:"truncate dark:text-white",children:[e.operationDefectId?"#".concat(e.operationDefectId," - "):"","[",e.id,"] ",e.name]}),l&&e.operationDefectId&&(0,a.jsx)("button",{onClick:()=>{v(String(e.operationDefectId)),b(e.name),N(!0)},className:"text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 ml-2 flex-shrink-0 flex items-center",title:"View defect audit log",children:(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-1",children:[(0,a.jsx)("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),(0,a.jsx)("polyline",{points:"14 2 14 8 20 8"}),(0,a.jsx)("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),(0,a.jsx)("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),(0,a.jsx)("polyline",{points:"10 9 9 9 8 9"})]})})]}),(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:e.category}),e.machine&&(0,a.jsxs)("div",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:["Machine: ",e.machine]}),!0===e.reworkable&&(0,a.jsx)("div",{className:"text-xs text-green-500 dark:text-green-400 mt-1 font-medium",children:"Reworkable"})]}),(0,a.jsxs)("div",{className:"w-full sm:w-1/2 grid ".concat("op10"===n.toLowerCase()?"grid-cols-4":"grid-cols-3"," gap-2"),children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"QTY"}),(0,a.jsx)("div",{className:"flex",children:(0,a.jsx)(L.I,{type:"number",min:"0",className:"h-8 border-purple-300 dark:border-purple-700 bg-white dark:bg-black ".concat(!l&&(null===(u=d[n])||void 0===u?void 0:u.isCompleted)?"bg-gray-50 dark:bg-black/70":""),value:e.quantity,onChange:t=>m(e.id,"quantity",parseInt(t.target.value)||0),disabled:!l&&(null===(h=d[n])||void 0===h?void 0:h.isCompleted)})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"RW"}),(0,a.jsx)(L.I,{type:"number",min:"0",className:"h-8 ".concat(e.reworkable?e.quantityRework>0?"border-green-300 dark:border-green-700 bg-white dark:bg-black":"":"bg-gray-100 dark:bg-black/70"," ").concat(!l&&(null===(x=d[n])||void 0===x?void 0:x.isCompleted)?"bg-gray-50 dark:bg-black/70":""),value:e.quantityRework,onChange:t=>m(e.id,"quantityRework",parseInt(t.target.value)||0),disabled:!e.reworkable||!l&&(null===(f=d[n])||void 0===f?void 0:f.isCompleted)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"NG"}),(0,a.jsx)(L.I,{type:"number",min:"0",className:"h-8 ".concat(e.quantityNogood>0?"border-red-300 dark:border-red-700 bg-white dark:bg-black":""," ").concat(e.reworkable?"":"bg-gray-100 dark:bg-black/70"," ").concat(!l&&(null===(y=d[n])||void 0===y?void 0:y.isCompleted)?"bg-gray-50 dark:bg-black/70":""),value:e.quantityNogood,onChange:t=>m(e.id,"quantityNogood",parseInt(t.target.value)||0),disabled:!e.reworkable||!l&&(null===(j=d[n])||void 0===j?void 0:j.isCompleted)})]}),"op10"===n.toLowerCase()&&(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"RP"}),(0,a.jsx)(L.I,{type:"number",min:"0",max:e.quantity,className:"h-8 border-blue-300 dark:border-blue-700 bg-white dark:bg-black ".concat(!l&&(null===(k=d[n])||void 0===k?void 0:k.isCompleted)?"bg-gray-50 dark:bg-black/70":""),value:void 0!==e.quantityReplacement?e.quantityReplacement>e.quantity?e.quantity:e.quantityReplacement:"op10"===n.toLowerCase()?e.quantity:0,onChange:t=>{let r=parseInt(t.target.value)||0,a=Math.min(r,e.quantity);console.log("RP input: ".concat(r,", Max allowed: ").concat(e.quantity,", Using: ").concat(a)),m(e.id,"quantityReplacement",a)},disabled:!l&&(null===(q=d[n])||void 0===q?void 0:q.isCompleted)})]})]})]})]},e.id)}),0===Q.length&&(0,a.jsx)("div",{className:"text-center py-6 bg-gray-50 dark:bg-black rounded-md border border-gray-200 dark:border-gray-800",children:(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-gray-500 dark:text-gray-400 mb-2",children:""!==I.trim()?"No defects match your search.":"No defects recorded for this operation."}),(0,a.jsx)("p",{className:"text-sm text-gray-400 dark:text-gray-500",children:""!==I.trim()?"Try a different search term.":"Search for defects to add."})]})})]})]})}function $(e){let{open:t,onClose:r,defect:n,operationId:i,operationCode:l,poNumber:d}=e;console.log("Rendering DefectAddRequestDialog with defect:",n);let{toast:c}=(0,p.pm)(),{socket:u,isConnected:m,emit:g}=(0,W.lm)(),[h,x]=(0,o.useState)(!1),[y,v]=(0,o.useState)(""),[b,N]=(0,o.useState)({quantity:1,quantityRework:(n.reworkable,0),quantityNogood:(n.reworkable,1),quantityReplacement:"op10"===l.toLowerCase()?1:0});(0,o.useEffect)(()=>{N({quantity:1,quantityRework:(n.reworkable,0),quantityNogood:(n.reworkable,1),quantityReplacement:"op10"===l.toLowerCase()?1:0}),v("")},[n,l]);let w=(e,t)=>{console.log("Updating ".concat(e," to ").concat(t)),N(r=>{let a={...r};if("quantity"===e&&(a.quantity=t,n.reworkable?(a.quantityRework=Math.min(r.quantityRework,t),a.quantityNogood=t-a.quantityRework):(a.quantityRework=0,a.quantityNogood=t),"op10"===l.toLowerCase()&&(a.quantityReplacement=t)),"quantityRework"===e){let e=Math.min(t,r.quantity);a.quantityRework=e,a.quantityNogood=r.quantity-e}if("quantityNogood"===e){let e=Math.min(t,r.quantity);a.quantityNogood=e,a.quantityRework=r.quantity-e}return"quantityReplacement"===e&&(a.quantityReplacement=Math.min(t,r.quantity)),a})},j=async()=>{if(!(b.quantity<=0)&&y.trim()&&!h){if(console.log("Submit request with poNumber:",d),!i){c({title:"Error",description:"Operation ID is missing",variant:"destructive"});return}if(!d){c({title:"Error",description:"Production Order Number is missing",variant:"destructive"});return}x(!0);try{console.log("Submitting defect add request:",{defect:n,operationId:i,values:b,poNumber:d});let t=[];if(i||t.push("operationId"),d||t.push("poNumber"),y.trim()||t.push("reason"),n.id||t.push("defectId"),n.name||t.push("defectName"),b.quantity<=0&&t.push("quantity (must be > 0)"),t.length>0)throw console.error("Missing required fields for add request:",{operationId:i,poNumber:d,hasReason:!!y.trim(),defectId:n.id,defectName:n.name,qty:b.quantity,rw:b.quantityRework,ng:b.quantityNogood,rp:b.quantityReplacement}),Error("Missing required fields: ".concat(t.join(", ")));let a={requestType:"add",operationId:Number(i),defectId:Number(n.id),defectName:n.name,defectCategory:n.category||"",defectReworkable:!!n.reworkable,defectMachine:n.machine||"",poNumber:d,currentQty:0,currentRw:0,currentNg:0,currentReplacement:0,requestedQty:b.quantity,requestedRw:b.quantityRework,requestedNg:b.quantityNogood,requestedReplacement:b.quantityReplacement,reason:y.trim(),operationCode:l};console.log("Request payload:",JSON.stringify(a,null,2));let o=await fetch("/api/operation-defect-edit-requests",{method:"POST",headers:{"Content-Type":"application/json",...B.UserSession.getAuthHeaders()},body:JSON.stringify(a)});if(console.log("Response status:",o.status),!o.ok){let e=await o.json();throw console.error("Error response:",e),Error(e.error||"Failed to submit add request (".concat(o.status,")"))}let s=await o.json();if(console.log("Success response:",s),m&&u){var e;console.log("Emitting defect-add-requested event via WebSocket for real-time updates");let t=await B.UserSession.getCurrentUser();g("defect-edit-requested",{id:null===(e=s.editRequest)||void 0===e?void 0:e.id,requestType:"add",defectId:n.id,defectName:n.name,poNumber:d,requestedQty:b.quantity,requestedById:null==t?void 0:t.id,userName:null==t?void 0:t.name,userRole:null==t?void 0:t.role,createdAt:new Date().toISOString()})}else console.warn("Socket not connected, only server-side notification will be created");c({title:"Add request submitted",description:s.message||"Your request to add this defect has been sent for approval"}),r(),v(""),N({quantity:1,quantityRework:(n.reworkable,0),quantityNogood:(n.reworkable,1),quantityReplacement:"op10"===l.toLowerCase()?1:0})}catch(e){console.error("Error submitting add request:",e),c({title:"Error",description:e instanceof Error?e.message:"Failed to submit request",variant:"destructive"})}finally{x(!1)}}};return(0,a.jsx)(f.Vq,{open:t,onOpenChange:e=>!e&&r(),children:(0,a.jsxs)(f.cZ,{className:"sm:max-w-md",children:[(0,a.jsx)(f.fK,{children:(0,a.jsx)(f.$N,{className:"text-xl font-semibold",children:"Request to Add Defect"})}),(0,a.jsxs)("div",{className:"space-y-4 py-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"font-medium text-lg dark:text-white",children:n.name}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:n.category}),n.machine&&(0,a.jsxs)("p",{className:"text-xs text-gray-400 dark:text-gray-500",children:["Machine: ",n.machine]}),n.reworkable&&(0,a.jsx)("p",{className:"text-xs text-green-500 dark:text-green-400 mt-1 font-medium",children:"Reworkable"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("div",{className:"text-sm font-medium mb-1 dark:text-gray-300",children:"Requested Quantity *"}),(0,a.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"QTY"}),(0,a.jsx)(L.I,{type:"number",min:"1",className:"h-9 dark:bg-black",value:b.quantity,onChange:e=>w("quantity",parseInt(e.target.value)||0)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"RW"}),(0,a.jsx)(L.I,{type:"number",min:"0",className:"h-9 ".concat(n.reworkable?"dark:bg-black":"bg-gray-100 dark:bg-black/70"),value:b.quantityRework,onChange:e=>w("quantityRework",parseInt(e.target.value)||0),disabled:!n.reworkable})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"NG"}),(0,a.jsx)(L.I,{type:"number",min:"0",className:"h-9 dark:bg-black",value:b.quantityNogood,onChange:e=>w("quantityNogood",parseInt(e.target.value)||0)})]})]}),"op10"===l.toLowerCase()&&(0,a.jsx)("div",{className:"grid grid-cols-3 gap-2 mt-2",children:(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"RP"}),(0,a.jsx)(L.I,{type:"number",min:"0",max:b.quantity,className:"h-9 border-blue-300 dark:border-blue-700 dark:bg-black",value:b.quantityReplacement,onChange:e=>w("quantityReplacement",parseInt(e.target.value)||0)})]})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm font-medium mb-1 dark:text-gray-300",children:"Reason for Adding *"}),(0,a.jsx)(M.g,{placeholder:"Provide a detailed reason for adding this defect",className:"resize-none dark:bg-black",value:y,onChange:e=>v(e.target.value)})]})]}),(0,a.jsxs)(f.cN,{className:"sm:justify-end",children:[(0,a.jsx)(s.z,{variant:"outline",onClick:r,children:"Cancel"}),(0,a.jsx)(s.z,{onClick:j,disabled:b.quantity<=0||!y.trim()||h,children:h?"Submitting...":"Submit Request"})]})]})})}function X(e){var t,r,s,n,i,l;let{activeTab:d,masterDefects:c,isAdmin:u,operationStatuses:p,isLoading:m,handleAddDefect:g,existingDefects:x=[],poNumber:f,refreshDefectsForOperationCallback:y}=e,[v,b]=(0,o.useState)(""),[N,w]=(0,o.useState)(null),[j,k]=(0,o.useState)(!1),{data:q}=(0,h.useSession)();console.log("Rendering SearchMasterDefectsList for tab: ".concat(d,", defects count: ").concat(c.length,", existing defects: ").concat(x.length)),console.log("User role:",null==q?void 0:null===(t=q.user)||void 0===t?void 0:t.role);let C=null===(r=p[d])||void 0===r?void 0:r.operationId,R=null===(s=p[d])||void 0===s?void 0:s.isCompleted,S=null===(n=p[d])||void 0===n?void 0:n.isStarted,I=x.filter(e=>e.operationId===C).map(e=>String(e.defectId));console.log("Operation ID: ".concat(C,", Existing defect IDs: ").concat(I.join(", "))),console.log("Operation completed: ".concat(R,", Operation started: ").concat(S,", Is admin: ").concat(u));let E=e=>{console.log("Selected defect from search: ".concat(e.name)),!u&&R?(w(e),k(!0)):g(e.id),b("")};return(0,a.jsxs)("div",{className:"mb-1",children:[N&&(0,a.jsx)($,{open:j,onClose:()=>{k(!1),w(null),y&&y()},defect:N,operationId:C,operationCode:d,poNumber:"string"==typeof f?f:Array.isArray(f)?f[0]:""}),(0,a.jsxs)("div",{className:"relative w-full",children:[(0,a.jsx)(P.Z,{className:"absolute left-2 top-2.5 h-4 w-4 text-gray-500 dark:text-gray-400"}),(0,a.jsx)(L.I,{type:"search",placeholder:S?"Search master defects...":"Start operation to search master defects",className:"pl-8",value:v,onChange:e=>b(e.target.value),disabled:!S||(null==q?void 0:null===(l=q.user)||void 0===l?void 0:null===(i=l.role)||void 0===i?void 0:i.toLowerCase())==="viewer"}),v&&(0,a.jsx)("div",{className:"absolute z-10 w-full bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-md shadow-lg mt-1 max-h-80 overflow-y-auto",children:m?(0,a.jsx)("div",{className:"flex justify-center py-4",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900 dark:border-white"})}):(0,a.jsxs)(a.Fragment,{children:[c.filter(e=>(e.name.toLowerCase().includes(v.toLowerCase())||e.category.toLowerCase().includes(v.toLowerCase()))&&!I.includes(String(e.id))).map(e=>(0,a.jsxs)("div",{className:"p-3 border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-900 cursor-pointer",onClick:()=>E(e),children:[(0,a.jsxs)("div",{className:"font-medium dark:text-white",children:["[",e.id,"] ",e.name]}),(0,a.jsxs)("div",{className:"flex justify-between text-xs text-gray-500 dark:text-gray-400",children:[(0,a.jsx)("span",{children:e.category}),e.machine&&(0,a.jsxs)("span",{children:["Machine: ",e.machine]})]}),e.reworkable&&(0,a.jsx)("div",{className:"text-xs text-green-500 dark:text-green-400 mt-1",children:"Reworkable"}),!u&&R&&(0,a.jsx)("div",{className:"text-xs text-blue-500 dark:text-blue-400 mt-1",children:"+ Request to add"})]},e.id)),0===c.filter(e=>(e.name.toLowerCase().includes(v.toLowerCase())||e.category.toLowerCase().includes(v.toLowerCase()))&&!I.includes(String(e.id))).length&&(0,a.jsxs)("div",{className:"p-3 text-center text-gray-500 dark:text-gray-400",children:['No defects found matching "',v,'"']})]})})]})]})}function ee(e){let{showEndOperationModal:t,activeTab:r,lineNo:n,rfValue:i,isCompletingOperation:l,setLineNo:d,setShowEndOperationModal:c,submitCompleteOperation:u}=e,[p,m]=(0,o.useState)([]),[g,h]=(0,o.useState)(!1),[x,f]=(0,o.useState)(!1),[y,v]=(0,o.useState)(null);(0,o.useEffect)(()=>{t&&b()},[t,r]);let b=async()=>{try{h(!0),v(null),console.log("Fetching line number options for operation: ".concat(r));let e=await fetch("/api/operation-lines?operation=".concat(r));if(!e.ok)throw Error("Failed to fetch line options");let t=await e.json();console.log("Operation-specific line options fetched:",t.lines),t.lines&&t.lines.length>0?m(t.lines):(console.log("No operation-specific lines found, falling back to generic options"),await N())}catch(e){console.error("Error fetching operation-specific line options:",e),v("Failed to load line options. Using generic options instead."),await N()}finally{h(!1)}},N=async()=>{try{console.log("Falling back to generic line options");let e=await fetch("/api/dashboard/filter-options");if(!e.ok)throw Error("Failed to fetch fallback line options");let t=await e.json();console.log("Fallback line options fetched:",t.lines),m(t.lines||[])}catch(e){console.error("Error fetching fallback line options:",e),m([])}},w=e=>{console.log("Selected line:",e),d(e),f(!1)};if(!t)return null;let j=p.filter(e=>null==e?void 0:e.toLowerCase().includes(n.toLowerCase()));return(0,a.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-gray-900 p-6 rounded-lg shadow-lg w-full max-w-md",children:[(0,a.jsxs)("h2",{className:"text-xl font-semibold mb-4 dark:text-white",children:["End Operation: ",r.toUpperCase()]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1 dark:text-gray-200",children:"Line Number *"}),y&&(0,a.jsx)("p",{className:"text-xs text-amber-600 mb-1",children:y}),(0,a.jsx)(L.I,{type:"text",value:n,onChange:e=>{let t=e.target.value;d(t),f(t.length>0)},onFocus:()=>f(!0),onBlur:()=>setTimeout(()=>f(!1),200),placeholder:"Enter line number",required:!0,className:"dark:bg-gray-800 dark:text-white"}),x&&(0,a.jsx)("div",{className:"absolute z-10 w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto",children:g?(0,a.jsx)("div",{className:"flex justify-center py-4",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900 dark:border-white"})}):(0,a.jsx)(a.Fragment,{children:j.length>0?j.map((e,t)=>(0,a.jsx)("div",{className:"p-2 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer text-sm dark:text-white",onClick:()=>w(e),children:e},t)):(0,a.jsx)("div",{className:"p-2 text-center text-gray-500 dark:text-gray-400 text-sm",children:"No matching lines found"})})})]}),(0,a.jsx)("div",{children:(0,a.jsxs)("label",{className:"block text-sm font-medium mb-1 dark:text-gray-200",children:["Current Resource Factor (RF): ",i]})})]}),(0,a.jsxs)("div",{className:"flex justify-end space-x-2 mt-6",children:[(0,a.jsx)(s.z,{variant:"outline",onClick:()=>c(!1),disabled:l,className:"dark:text-white",children:"Cancel"}),(0,a.jsx)(s.z,{className:"bg-red-600 hover:bg-red-700 text-white",onClick:u,disabled:l||!n.trim(),children:l?(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("span",{className:"animate-spin mr-2",children:"⟳"})," Processing..."]}):"End Operation"})]})]})})}function et(e){let{poNumber:t,formData:r,handleChange:o,handleUpdate:n,isSubmitting:i,isAdmin:l,session:d,orderData:c}=e;return console.log("Rendering OrderDetailsForm for PO: ".concat(t)),(0,a.jsx)("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow p-4 mb-6",children:(0,a.jsxs)("div",{className:"flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4",children:[(0,a.jsxs)("div",{className:"w-full md:w-1/6",children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-600",children:"PO Number"}),(0,a.jsx)(L.I,{value:t,disabled:!0,className:"bg-gray-50 dark:bg-gray-900 dark:text-white h-8 text-sm"})]}),(0,a.jsxs)("div",{className:"w-full md:w-1/6",children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-600",children:"Lot Number"}),(0,a.jsx)(L.I,{name:"lotNumber",value:r.lotNumber,onChange:o,disabled:!l,className:"h-8 text-sm ".concat(l?"":"bg-gray-50")})]}),(0,a.jsxs)("div",{className:"w-full md:w-1/6",children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-600",children:"Status"}),(0,a.jsx)(L.I,{value:(null==c?void 0:c.status)||"CREATED",disabled:!0,className:"bg-gray-50 h-8 text-sm"})]}),(0,a.jsxs)("div",{className:"w-full md:w-1/6",children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-600",children:"Quantity"}),(0,a.jsx)(L.I,{name:"quantity",type:"number",min:"1",value:r.quantity,onChange:o,disabled:!l,className:"h-8 text-sm ".concat(l?"":"bg-gray-50")})]}),(0,a.jsxs)("div",{className:"w-full md:w-1/6",children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-600",children:"Item Name"}),(0,a.jsx)(L.I,{name:"itemName",value:r.itemName,onChange:o,disabled:!l,className:"h-8 text-sm ".concat(l?"":"bg-gray-50")})]}),(0,a.jsxs)("div",{className:"w-full md:w-1/6",children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-600 invisible",children:"Action"}),(0,a.jsx)(s.z,{className:"bg-purple-600 hover:bg-purple-700 text-white h-8 w-full",onClick:n,disabled:i||!d||!d.user||!l,children:i?"Saving...":l?"Save":"View Only"})]})]})})}function er(e){let{operationSteps:t,activeTab:r,operationStatuses:o,isAdmin:s,handleTabChange:n}=e;return console.log("Rendering OperationTabs with ".concat(t.length," steps, activeTab: ").concat(r)),(0,a.jsx)("div",{className:"w-full bg-gray-100 dark:bg-gray-800 rounded-lg p-1",children:(0,a.jsx)("div",{className:"grid w-full gap-1",style:{gridTemplateColumns:"repeat(".concat(t.length||5,", 1fr)")},children:t.length>0?t.map((e,i)=>{var l;let d=e.code.toLowerCase(),c=o[d],u=i>0&&!(null==c?void 0:c.isStarted)&&!(null==c?void 0:c.isCompleted)&&t[i-1]&&!(null===(l=o[t[i-1].code.toLowerCase()])||void 0===l?void 0:l.isCompleted),p=r===d;return(0,a.jsxs)("button",{onClick:()=>!u&&n(e.code.toLowerCase()),disabled:u,className:"relative h-10 flex items-center justify-center rounded-md transition-all ".concat((null==c?void 0:c.isCompleted)?"bg-green-500 dark:bg-green-600 text-white":(null==c?void 0:c.isStarted)?"bg-blue-500 dark:bg-blue-600 text-white":p?"bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm":"bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-500"," ").concat(p?"ring-2 ring-purple-500 dark:ring-purple-400 ring-offset-1 dark:ring-offset-gray-800":""," ").concat(u?"opacity-50 cursor-not-allowed":""),children:[(0,a.jsxs)("div",{className:"hidden md:flex items-center gap-1",children:[(null==c?void 0:c.isCompleted)&&(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-white",children:(0,a.jsx)("path",{d:"M20 6L9 17l-5-5"})}),(null==c?void 0:c.isStarted)&&!(null==c?void 0:c.isCompleted)&&(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-white animate-pulse",children:[(0,a.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,a.jsx)("path",{d:"M12 6v6l4 2"})]}),(0,a.jsx)("span",{children:e.name}),(null==c?void 0:c.isCompleted)&&!s&&(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-yellow-300 dark:text-yellow-200 ml-1",children:[(0,a.jsx)("rect",{x:"3",y:"11",width:"18",height:"11",rx:"2",ry:"2"}),(0,a.jsx)("path",{d:"M7 11V7a5 5 0 0 1 10 0v4"})]})]}),(0,a.jsxs)("div",{className:"md:hidden flex flex-col items-center text-xs",children:[(0,a.jsx)("span",{children:e.code}),(null==c?void 0:c.isCompleted)&&!s&&(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-yellow-300 dark:text-yellow-200 mt-1",children:[(0,a.jsx)("rect",{x:"3",y:"11",width:"18",height:"11",rx:"2",ry:"2"}),(0,a.jsx)("path",{d:"M7 11V7a5 5 0 0 1 10 0v4"})]})]}),i<t.length-1&&(0,a.jsx)("div",{className:"absolute -right-2 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 md:block hidden z-10",children:"→"})]},e.code)}):(0,a.jsx)("div",{className:"col-span-5 bg-gray-50 dark:bg-gray-800 py-2 flex items-center justify-center dark:text-gray-300",children:"Loading..."})})})}var ea=r(45977);let eo=0;var es=!0;function en(e){var t,r,l,c,u,p;let{initialOrderData:m,initialError:g,initialErrorStatus:f,poNumberFromServer:y}=e;console.log("RENDER: ProductionOrderDetails component rendering with initialData:",!!m),console.log("RENDER COUNT: #"+ ++eo);let{data:v}=(0,h.useSession)(),b=(null==v?void 0:null===(t=v.user)||void 0===t?void 0:t.role)||"unknown",N="admin"===b.toLowerCase();console.log("RENDER: User role:",b,"isAdmin:",N);let w=(0,n.useRouter)(),j=y||w.query.poNumber,[k,q]=(0,o.useState)(!0),[C,R]=(0,o.useState)(!1),[S,I]=(0,o.useState)(!1),[E,T]=(0,o.useState)(null),[D,L]=(0,o.useState)(!1),A=(0,o.useCallback)(async()=>{var e,t,r;if(!j||!(null==v?void 0:null===(e=v.user)||void 0===e?void 0:e.id))return!1;if((null==v?void 0:null===(r=v.user)||void 0===r?void 0:null===(t=r.role)||void 0===t?void 0:t.toLowerCase())==="viewer")return console.log("Viewer role detected, bypassing lock acquisition"),q(!1),!0;try{q(!0),console.log("Attempting to acquire lock for: ".concat(j));let e=await fetch("/api/locks/acquire",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({resourceType:"productionOrder",resourceId:j})}),t=await e.json();if(console.log("Lock acquisition response:",t),e.ok&&t.success)return R(!0),I(!0),T(t.lockInfo),!0;if(423===e.status)return R(!0),I(!1),T(t.lockInfo),!1;return console.error("Lock acquisition failed:",t.error),!1}catch(e){return console.error("Error acquiring lock:",e),!1}finally{q(!1)}},[j,null==v?void 0:null===(r=v.user)||void 0===r?void 0:r.id,null==v?void 0:null===(l=v.user)||void 0===l?void 0:l.role]),F=(0,o.useCallback)(async()=>{if(j)try{L(!0);let e=await fetch("/api/locks/release",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({resourceType:"productionOrder",resourceId:j})}),t=await e.json();e.ok&&t.success?w.push("/production-orders"):console.error("Failed to release lock:",t.error)}catch(e){console.error("Error releasing lock:",e)}finally{L(!1)}},[j,w]),P=(0,o.useCallback)(async()=>{if(j&&N)try{L(!0);let e=await fetch("/api/locks/force-release",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({resourceType:"productionOrder",resourceId:j})}),t=await e.json();e.ok&&t.success?await A()?window.location.reload():w.push("/production-orders"):console.error("Failed to force release lock:",t.error)}catch(e){console.error("Error force releasing lock:",e)}finally{L(!1)}},[j,N,A,w]);return((0,o.useEffect)(()=>{var e;j&&(null==v?void 0:null===(e=v.user)||void 0===e?void 0:e.id)&&A()},[j,null==v?void 0:null===(c=v.user)||void 0===c?void 0:c.id,A]),!C||S||k||(null==v?void 0:null===(p=v.user)||void 0===p?void 0:null===(u=p.role)||void 0===u?void 0:u.toLowerCase())==="viewer")?k?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(d(),{children:(0,a.jsx)("title",{children:"P-Chart System - Production Order ".concat(j)})}),(0,a.jsx)(i.Z,{children:(0,a.jsxs)("div",{className:"py-6",children:[(0,a.jsx)(x.Z,{title:"Production Order - ".concat(j),description:"Loading..."}),(0,a.jsx)("div",{className:"flex justify-center items-center h-64",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"})})]})})]}):(console.log("RENDER: Rendering full order details"),(0,a.jsx)(O,{children:(0,a.jsx)(ei,{initialOrderData:m,initialError:g,initialErrorStatus:f,poNumberFromServer:y,onReleaseLock:F,isReleasingLock:D})})):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(d(),{children:(0,a.jsx)("title",{children:"P-Chart System - Production Order ".concat(j," (Locked)")})}),(0,a.jsx)(i.Z,{children:(0,a.jsxs)("div",{className:"py-6",children:[(0,a.jsx)(x.Z,{title:"Production Order ".concat(j," (Locked)"),description:"This production order is currently locked by another user."}),(0,a.jsx)("div",{className:"bg-white dark:bg-black p-6 rounded-lg shadow mb-4",children:(0,a.jsx)("div",{className:"border-l-4 border-amber-500 p-4 bg-amber-50 dark:bg-gray-900 mb-4",children:(0,a.jsxs)("div",{className:"flex items-start",children:[(0,a.jsx)("div",{className:"mr-2 text-amber-500",children:(0,a.jsx)(ea.Z,{className:"h-6 w-6"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-amber-800 font-semibold",children:"This production order is currently locked"}),(0,a.jsx)("p",{className:"text-amber-700 mt-1",children:E?"This production order is being edited by ".concat(E.userName," since ").concat(new Date(E.lockedAt).toLocaleString()):"This production order is currently locked by another user."}),(0,a.jsxs)("div",{className:"mt-3 flex space-x-2",children:[(0,a.jsx)(s.z,{variant:"outline",onClick:()=>w.push("/production-orders"),children:"Return to List"}),N&&(0,a.jsx)(s.z,{variant:"destructive",onClick:P,disabled:D,children:D?"Releasing...":"Force Release Lock"})]})]})]})})})]})})]})}function ei(e){var t,r,l,m,f,y,v,b,N,w;let{initialOrderData:j,initialError:k,initialErrorStatus:q,poNumberFromServer:C,onReleaseLock:R,isReleasingLock:S}=e,I=(0,o.useRef)(!1),{isAuthorized:E,authError:T,getAuthHeaders:O,checkResponseAuth:L}=(0,u.a)(),{data:F}=(0,h.useSession)(),P=(null==F?void 0:null===(r=F.user)||void 0===r?void 0:null===(t=r.role)||void 0===t?void 0:t.toLowerCase())==="admin";console.log("AUTH: User role:",null==F?void 0:null===(l=F.user)||void 0===l?void 0:l.role,"Is admin?",P);let{toast:U}=(0,p.pm)(),M=(0,n.useRouter)(),{newOrder:z}=M.query,Q=C||M.query.poNumber,[V,G]=(0,o.useState)(""),[Z,B]=(0,o.useState)(""),[W,J]=(0,o.useState)("Not Started"),[Y,_]=(0,o.useState)(k||null),[H,$]=(0,o.useState)(j||null),[ea,eo]=(0,o.useState)(!1),[es,en]=(0,o.useState)([]),[ei,el]=(0,o.useState)([]),[ed,ec]=(0,o.useState)({lotNumber:"",quantity:"",itemName:""}),[eu,ep]=(0,o.useState)({}),[em,eg]=(0,o.useState)(!1),[eh,ex]=(0,o.useState)("1"),[ef,ey]=(0,o.useState)(!1),[ev,eb]=(0,o.useState)(!1),[eN,ew]=(0,o.useState)(!1),[ej,ek]=(0,o.useState)(""),[eq,eC]=(0,o.useState)(""),[eR,eS]=(0,o.useState)(!1),[eI,eE]=(0,o.useState)(!1),[eT,eD]=(0,o.useState)(!1),[eO,eL]=(0,o.useState)(!!j),[eA,eF]=(0,o.useState)("string"==typeof Q?Q:""),[eP,eU]=(0,o.useState)(null),[eM,ez]=(0,o.useState)(!1),[eQ,eV]=(0,o.useState)(null),[eG,eZ]=(0,o.useState)(null),[eB,eW]=(0,o.useState)([]),[eJ,eY]=(0,o.useState)(!1),e_=(0,o.useCallback)(async()=>{if(I.current){console.log("Already performed initial data load, skipping redundant fetch");return}if(j){console.log("Initial order data provided, skipping API fetch"),$(j),eL(!0),"string"==typeof Q&&eF(Q),I.current=!0;return}if(!Q||"string"!=typeof Q){console.log("No valid poNumber available, skipping fetch");return}_(null),console.log("Fetching production order:",Q);try{I.current=!0;let e=await fetch("/api/production-orders/".concat(Q),{headers:O()});if(!L(e)){console.log("Response checking failed, aborting fetch"),I.current=!1;return}if(!e.ok){I.current=!1;try{let t=await e.clone().json();throw console.error("DIAGNOSTIC: Production order API error response data:",t),Error(t.error||"Failed to fetch production order")}catch(t){console.error("DIAGNOSTIC: Could not parse JSON error response");try{let t=await e.text();throw console.error("DIAGNOSTIC: Raw error response:",t.substring(0,500)),Error("Failed to fetch production order: Response is not JSON. Status: ".concat(e.status))}catch(t){throw console.error("DIAGNOSTIC: Error parsing response as text:",t),Error("Failed to fetch production order: ".concat(e.status))}}}let t=await e.json();console.log("Production order fetched:",t),$(t),eL(!0),"string"==typeof Q&&eF(Q)}catch(e){if(console.error("DIAGNOSTIC ERROR in fetchProductionOrder:",e),console.error("DIAGNOSTIC ERROR details:",e),I.current=!1,e instanceof TypeError&&e.message.includes("fetch")){console.error("Network error detected - unable to reach server"),U({title:"Network Error",description:"Unable to connect to the server. Please check your connection.",variant:"destructive"});return}_(e instanceof Error?e.message:"An unknown error occurred"),U({title:"Error",description:e instanceof Error?e.message:"Failed to fetch production order",variant:"destructive"})}},[O,Q,U,L,j]),eH=(0,o.useCallback)(async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e||"string"!=typeof e){console.log("Invalid operation code, skipping defects fetch");return}if(eP===e&&!t){console.log("Already fetched defects for ".concat(e,", skipping redundant fetch"));return}if(!Q||"string"!=typeof Q){console.log("No valid poNumber available yet, will try again when it is available");return}t||eU(e);try{var r,a;if(await new Promise(e=>setTimeout(e,0)),eP===e&&!t){console.log("After timeout check: already fetched defects for ".concat(e,", skipping redundant fetch"));return}console.log("Fetching defects for operation: ".concat(e,", PO: ").concat(Q)),eY(!0);let o=await fetch("/api/defects?operation=".concat(e,"&poNumber=").concat(Q,"&active=true"),{headers:O()});if(!L(o)){console.log("Response checking failed, aborting defects fetch"),eY(!1),t||eU(null);return}if(!o.ok){let e=await o.json();throw eY(!1),t||eU(null),Error(e.error||"Failed to fetch defects")}let s=await o.json();console.log("Fetched ".concat(s.data.length," master defects for operation ").concat(e)),eW(s.data||[]),eY(!1);let n=null===(r=eu[e])||void 0===r?void 0:r.operationId;if(n){let t;console.log("Fetching recorded defects for operation ID: ".concat(n));let r=await fetch("/api/operation-defects/list",{method:"POST",headers:{...O(),"Content-Type":"application/json"},body:JSON.stringify({operationId:n})});if(!L(r)){console.log("Response checking failed, aborting operation defects fetch");return}if(!r.ok){let e=await r.json();throw Error(e.error||"Failed to fetch operation defects")}try{t=await r.json(),console.log("Fetched ".concat((null===(a=t.data)||void 0===a?void 0:a.length)||0," recorded defects for operation ").concat(e)),t.data&&t.data.length>0&&console.log("First operation defect structure:",JSON.stringify(t.data[0],null,2));let o=s.data.map(e=>{var r;let a=null===(r=t.data)||void 0===r?void 0:r.find(t=>parseInt(t.defectId)===parseInt(e.id));return a?(console.log("Found recorded defect: ".concat(e.name," with quantity ").concat(a.quantity)),{...e,quantity:a.quantity||0,quantityRework:a.quantityRework||0,quantityNogood:a.quantityNogood||0,quantityReplacement:a.quantityReplacement||0,operationDefectId:a.id||null}):{...e,quantity:0,quantityRework:0,quantityNogood:0,quantityReplacement:0,operationDefectId:null}}),n=o.filter(e=>e.quantity>0);console.log("Defects with quantity > 0:",n.map(e=>({id:e.id,name:e.name,quantity:e.quantity}))),el(o),eU(e)}catch(t){console.error("Failed to parse operation defects response:",t),el(s.data.map(e=>({...e,quantity:0,quantityRework:0,quantityNogood:0,quantityReplacement:0,operationDefectId:null}))),eU(e)}}else console.log("No operation ID available, using master defects list only"),el(s.data.map(e=>({...e,quantity:0,quantityRework:0,quantityNogood:0,quantityReplacement:0,operationDefectId:null}))),eU(e)}catch(t){console.error("Error fetching defects:",t);let e=t instanceof Error?t.message:"An unknown error occurred";U({title:"Error",description:"Failed to load defects: ".concat(e),variant:"destructive"}),el([]),eW([]),eY(!1)}},[O,eP,eu,Q,U,L]),eK=(0,o.useCallback)(async e=>{console.log("Tab changing from ".concat(Z," to ").concat(e));try{if(Z===e){console.log("Tab already active, skipping change");return}if(B(e),console.log("Operation status for ".concat(e,":"),eu[e]),eP===e){console.log("Tab ".concat(e," already has defects loaded, skipping fetch"));return}if(!Q||"string"!=typeof Q){console.log("PO number not available yet, will fetch defects when it becomes available");return}console.log("Loading defects for newly selected tab ".concat(e)),await eH(e,!0)}catch(e){console.error("Error in handleTabChange:",e),U({title:"Error",description:"Tab change error: ".concat(e instanceof Error?e.message:"Unknown error"),variant:"destructive"})}},[Z,eH,eP,eu,Q,U]),e$=(0,o.useCallback)(async()=>{var e;if(Q&&Z&&(null===(e=eu[Z])||void 0===e||!e.isStarted))try{console.log("Starting operation ".concat(Z," for PO: ").concat(Q)),eo(!0);let e=await fetch("/api/operations/start",{method:"POST",headers:{...O(),"Content-Type":"application/json"},body:JSON.stringify({poNumber:Q,operationCode:Z})});if(!L(e)){console.log("Response checking failed, aborting operation start"),eo(!1);return}if(!e.ok){let t=await e.json();throw Error(t.error||"Failed to start operation")}let t=await e.json();$(t),J("In Progress"),U({title:"Success",description:"".concat(Z.toUpperCase()," operation started successfully!")})}catch(e){console.error("Error starting operation:",e),U({title:"Error",description:e instanceof Error?e.message:"An unknown error occurred",variant:"destructive"})}finally{eo(!1)}},[Z,O,eu,Q,U]),eX=(0,o.useCallback)(async()=>{var e,t,r;if(!P&&(null===(e=eu[Z])||void 0===e?void 0:e.isCompleted)){console.log("Non-admin user tried to edit a completed operation"),U({title:"Permission Denied",description:"Only admin users can edit completed operations",variant:"destructive"});return}Q&&Z&&(null===(t=eu[Z])||void 0===t?void 0:t.isStarted)&&(null===(r=eu[Z])||void 0===r||!r.isCompleted)&&eS(!0)},[Z,P,eu,Q,U]),e0=(0,o.useCallback)(async()=>{if(I.current){console.log("Already fetched operation steps, skipping");return}try{console.log("DIAGNOSTIC: Starting fetchOperationStepsApi call");try{let e=await fetch("/api/operation-steps",{headers:O()});if(!L(e)){console.log("Response checking failed, aborting fetch");return}if(!e.ok){console.error("DIAGNOSTIC: API call to fetch operation steps failed",{status:e.status,statusText:e.statusText});try{let t=await e.json();throw console.error("DIAGNOSTIC: Operation steps API error response data:",t),Error(t.error||"Failed to fetch operation steps")}catch(t){console.error("DIAGNOSTIC: Could not parse JSON error response");try{let t=await e.text();throw console.error("DIAGNOSTIC: Raw error response:",t.substring(0,500)),Error("Failed to fetch operation steps: Response is not JSON. Status: ".concat(e.status))}catch(t){throw console.error("DIAGNOSTIC: Error parsing response as text:",t),Error("Failed to fetch operation steps: ".concat(e.status," ").concat(e.statusText))}}}let t=await e.json();console.log("DIAGNOSTIC: fetchOperationStepsApi succeeded"),console.log("Operation steps fetched:",t),en(t),I.current=!0}catch(e){if(console.error("DIAGNOSTIC ERROR in fetchOperationStepsApi:",e),console.error("DIAGNOSTIC ERROR details:",{message:e.message,stack:e.stack,name:e.name}),e.message&&e.message.includes("JSON")&&(console.error("DIAGNOSTIC: JSON parsing error detected in fetchOperationStepsApi"),e.response))try{let t=await e.response.text();console.error("DIAGNOSTIC: Raw response body:",t.substring(0,500))}catch(e){console.error("DIAGNOSTIC: Could not read raw response:",e)}throw e}}catch(e){console.error("Error fetching operation steps:",e),_("Failed to fetch operation steps")}},[O,U,L]),e1=(0,o.useCallback)(g()(async e=>{if(Q&&Z){console.log("Sending defect update to server: ".concat(e.name,", quantity: ").concat(e.quantity)),ey(!0);try{let t=await fetch("/api/operation-defects",{method:"POST",headers:{...O(),"Content-Type":"application/json"},body:JSON.stringify({poNumber:Q,operationCode:Z,defect:e})});if(!L(t)){console.log("Response checking failed, aborting defect update"),ey(!1);return}if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to update defect")}let r=await t.json();console.log("Defect update successful, updated order:",r),$(r);let a={};es.forEach(e=>{a[e.code.toLowerCase()]={isStarted:!1,isCompleted:!1,inputQuantity:0,outputQuantity:null,startTime:null,endTime:null}}),r.operations.forEach(e=>{a[e.operation.toLowerCase()]={isStarted:!!e.startTime,isCompleted:!!e.endTime,inputQuantity:e.inputQuantity,outputQuantity:e.outputQuantity,startTime:e.startTime?new Date(e.startTime):null,endTime:e.endTime?new Date(e.endTime):null,operationId:e.id}}),ep(a),eU(Z)}catch(e){console.error("Error updating defect:",e),U({title:"Error",description:e instanceof Error?e.message:"An unknown error occurred",variant:"destructive"})}finally{ey(!1)}}},500),[Z,O,es,Q,U,L]),e2=(0,o.useCallback)((e,t,r)=>{var a;if(!P&&(null===(a=eu[Z])||void 0===a?void 0:a.isCompleted)){console.log("Non-admin user tried to edit a completed operation defect"),U({title:"Permission Denied",description:"Only admin users can edit completed operations",variant:"destructive"});return}let o=Math.max(0,r);el(r=>r.map(r=>{if(r.id===e){var a;let e={...r};if("quantity"===t&&(e.quantity=o,e.quantityNogood=o,e.quantityRework=0,"op10"===Z.toLowerCase()&&(e.quantityReplacement=o),console.log("QTY updated: QTY=".concat(o,", NG=").concat(o,", RW=0").concat("op10"===Z.toLowerCase()?", RP=".concat(o):""))),"quantityNogood"===t){let t=Math.min(o,r.quantity);e.quantityNogood=t,e.quantityRework=r.quantity-t,console.log("NG updated: QTY=".concat(r.quantity,", NG=").concat(t,", RW=").concat(e.quantityRework))}if("quantityRework"===t){let t=Math.min(o,r.quantity);e.quantityRework=t,e.quantityNogood=r.quantity-t,console.log("RW updated: QTY=".concat(r.quantity,", NG=").concat(e.quantityNogood,", RW=").concat(t))}return"quantityReplacement"===t&&("op10"===Z.toLowerCase()?(e.quantityReplacement=o,console.log("RP updated: RP=".concat(o))):(e.quantityReplacement=0,console.log("RP update ignored for non-OP10 operation"))),Z&&(null===(a=eu[Z])||void 0===a?void 0:a.isStarted)&&e1(e),e}return r}))},[Z,P,eu,e1,U]),e4=(0,o.useCallback)(e=>{let{name:t,value:r}=e.target;ec({...ed,[t]:r})},[ed]),e5=(0,o.useCallback)(async()=>{if(!P){console.log("Non-admin user tried to edit a production order"),U({title:"Permission Denied",description:"Only admin users can edit production orders",variant:"destructive"});return}if(Q&&H){eo(!0),_(null);try{let e=await fetch("/api/production-orders/".concat(Q),{method:"PUT",headers:{...O(),"Content-Type":"application/json"},body:JSON.stringify({lotNumber:ed.lotNumber,quantity:ed.quantity,itemName:ed.itemName})});if(!L(e)){console.log("Response checking failed, aborting order update"),eo(!1);return}if(!e.ok){let t=await e.json();throw Error(t.error||"Failed to update production order")}let t=await e.json();$(t),U({title:"Success",description:"Production order updated successfully!"})}catch(t){console.error("Error updating production order:",t);let e=t instanceof Error?t.message:"An unknown error occurred";_(e),U({title:"Error",description:e,variant:"destructive"})}finally{eo(!1)}}},[ed,O,P,H,Q,U]),e3=(0,o.useCallback)(async e=>{var t,r;if(!P&&(null===(t=eu[Z])||void 0===t?void 0:t.isCompleted)){console.log("Non-admin user tried to add a defect to a completed operation"),U({title:"Permission Denied",description:"Only admin users can edit completed operations",variant:"destructive"});return}if(!Q||!Z||!(null===(r=eu[Z])||void 0===r?void 0:r.isStarted)){U({title:"Operation Not Started",description:"Please start the operation before adding defects",variant:"destructive"});return}try{console.log("Adding defect ".concat(e," to operation ").concat(Z)),ey(!0);let t=eB.find(t=>t.id===e);if(!t)throw Error("Defect not found in master list");let r={...t,quantity:1,quantityRework:0,quantityNogood:1},a=await fetch("/api/operation-defects",{method:"POST",headers:{...O(),"Content-Type":"application/json"},body:JSON.stringify({poNumber:Q,operationCode:Z,defect:r})});if(!L(a)){console.log("Response checking failed, aborting defect add"),ey(!1);return}if(!a.ok){let e=await a.json();throw Error(e.error||"Failed to add defect")}let o=await a.json();console.log("Defect added successfully, updated order:",o),$(o),await eH(Z,!0),U({title:"Success",description:"Added ".concat(t.name," to operation")})}catch(e){console.error("Error adding defect:",e),U({title:"Error",description:e instanceof Error?e.message:"An unknown error occurred",variant:"destructive"})}finally{ey(!1)}},[Z,eH,O,P,eB,eu,Q,U,L]),e6=(0,o.useCallback)(()=>{console.log("refreshDefectsForOperationCallback called")},[]);(0,o.useEffect)(()=>(console.log("EFFECT: fetchOperationSteps effect running"),e0(),()=>console.log("EFFECT: fetchOperationSteps cleanup")),[e0]),(0,o.useEffect)(()=>(console.log("EFFECT: Initial tab setting effect",{operationStepsLength:es.length,activeTab:Z}),es.length>0&&!Z&&(console.log("EFFECT: Initial tab setting to:",es[0].code.toLowerCase()),B(es[0].code.toLowerCase())),()=>console.log("EFFECT: Initial tab setting cleanup")),[es,Z]),(0,o.useEffect)(()=>(console.log("EFFECT: Defect loading check effect",{activeTab:Z,lastFetchedTab:eP,poNumber:Q}),Z&&eP!==Z&&Q?(console.log("EFFECT: Initial defect load triggered for active tab:",Z),Q&&"string"==typeof Q&&(console.log("EFFECT: Triggering initial defect load for tab:",Z),eH(Z,!0))):console.log("EFFECT: Skipping defect load:",{activeTab:Z,lastFetchedTab:eP,havePoNumber:!!Q&&"string"==typeof Q}),()=>console.log("EFFECT: Defect loading check cleanup")),[Z,eH,eP,Q]),(0,o.useEffect)(()=>{if(H&&(console.log("OrderData updated",H),ec({lotNumber:H.lotNumber||"",quantity:H.poQuantity.toString(),itemName:H.itemName||""}),H.operations&&H.currentOperation)){let e=localStorage.getItem("lastUpdateType");if((!Z||!e||"pageLoad"===e)&&!eP){let e=H.currentOperation.toLowerCase();console.log("Setting active tab to current operation:",e),B(e),console.log("INIT PAGE LOAD - Will trigger defect load for",e)}}},[H,Z,eP]),(0,o.useEffect)(()=>{if(!H||!H.operations||0===es.length)return;console.log("Updating operation statuses based on order data:",H);let e={};if(es.forEach(t=>{let r=t.code.toLowerCase();console.log("Initialized status for ".concat(r,":"),{isStarted:!1,isCompleted:!1,inputQuantity:0,outputQuantity:null,startTime:null,endTime:null}),e[r]={isStarted:!1,isCompleted:!1,inputQuantity:0,outputQuantity:null,startTime:null,endTime:null}}),H.operations.forEach(t=>{let r=t.operation.toLowerCase(),a={isStarted:!!t.startTime,isCompleted:!!t.endTime,inputQuantity:t.inputQuantity,outputQuantity:t.outputQuantity,startTime:t.startTime?new Date(t.startTime):null,endTime:t.endTime?new Date(t.endTime):null,operationId:t.id};console.log("Updated status for ".concat(r,":"),a),e[r]=a}),console.log("Final operation statuses:",e),ep(e),H.currentOperation){var t,r,a;let o=H.currentOperation.toLowerCase();console.log("Current operation:",o,"Status:",e[o]),(null===(t=e[o])||void 0===t?void 0:t.isStarted)&&!(null===(r=e[o])||void 0===r?void 0:r.isCompleted)?J("In Progress"):(null===(a=e[o])||void 0===a?void 0:a.isCompleted)?J("Completed"):J("Not Started")}else J("Not Started")},[H,es]),(0,o.useEffect)(()=>{T&&U({title:"Authentication Error",description:T,variant:"destructive"})},[T,U]),(0,o.useEffect)(()=>{if(console.log("EFFECT: Main production order fetch effect triggered",{poNumber:Q,hasInitialData:!!j,alreadyLoaded:I.current,orderLoaded:eO,loadedOrderNumber:eA}),I.current){console.log("Already fetched data, skipping");return}if(j){console.log("Using provided initial data, skipping fetch"),$(j),eL(!0),"string"==typeof Q&&eF(Q),I.current=!0;return}if(!Q||"string"!=typeof Q){console.log("No valid poNumber available, waiting...");return}if(eO&&eA===Q){console.log("Order already loaded for this poNumber, skipping");return}console.log("Triggering production order fetch for:",Q),e_()},[Q,j,eO,eA,e_]),(0,o.useEffect)(()=>(console.log("EFFECT: localStorage effect running"),localStorage.setItem("lastUpdateType","pageLoad"),()=>{console.log("EFFECT: localStorage effect cleanup"),localStorage.removeItem("lastUpdateType")}),[]),(0,o.useEffect)(()=>{if(j||I.current){console.log("Router ready effect: already have data, skipping fetch");return}let e=()=>{console.log("Router is ready, checking for poNumber:",M.query.poNumber);let e=M.query.poNumber;if(I.current){console.log("Skipping router ready effect: already fetched data");return}e&&"string"==typeof e&&!I.current&&(console.log("Router is ready with poNumber:",e),e_())};return M.isReady&&e(),M.events.on("routeChangeComplete",e),()=>{M.events.off("routeChangeComplete",e)}},[M,e_,j,I]);let e8=(0,o.useCallback)(async e=>{var t,r;if(!P&&(null===(t=eu[Z])||void 0===t?void 0:t.isCompleted)){console.log("Non-admin user tried to delete a defect in a completed operation"),U({title:"Permission Denied",description:"Only admin users can edit completed operations",variant:"destructive"});return}if(Q&&Z&&(null===(r=eu[Z])||void 0===r?void 0:r.isStarted))try{console.log("Deleting defect ".concat(e," from operation ").concat(Z)),eb(!0);let t=ei.find(t=>t.id===e);if(!t)throw Error("Defect not found");if(!t.operationDefectId){el(t=>t.filter(t=>t.id!==e)),console.log("Defect was not saved to server, removed from UI only");return}let r=await fetch("/api/operation-defects/".concat(t.operationDefectId),{method:"DELETE",headers:O()});if(!L(r)){console.log("Response checking failed, aborting defect deletion"),eb(!1);return}if(!r.ok){let e=await r.json();throw Error(e.error||"Failed to delete defect")}console.log("Defect deleted successfully"),await eH(Z,!0),U({title:"Success",description:"Defect deleted successfully"})}catch(e){console.error("Error deleting defect:",e),U({title:"Error",description:e instanceof Error?e.message:"An unknown error occurred",variant:"destructive"})}finally{eb(!1)}},[Z,ei,eH,O,P,eu,Q,U,L]),e9=(0,o.useCallback)(async()=>{if(!ej){U({title:"Error",description:"Line Number is required",variant:"destructive"});return}try{console.log("Completing operation ".concat(Z," for PO: ").concat(Q," with Line No: ").concat(ej)),eg(!0),ew(!0),localStorage.setItem("lastUpdateType","operationComplete");let e={poNumber:Q,operationCode:Z,rf:eh,defects:ei,lineNo:ej};eq&&(e.timestamp=eq,console.log("Including custom timestamp: ".concat(eq)));let t=await fetch("/api/operations/complete",{method:"POST",headers:{...O(),"Content-Type":"application/json"},body:JSON.stringify(e)});if(!L(t)){console.log("Response checking failed, aborting operation completion"),eg(!1);return}if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to complete operation")}let r=await t.json();if($(r),J("Completed"),r.currentOperation){let e=r.currentOperation.toLowerCase();console.log("Moving to next operation: ".concat(e)),eU(null),B(e),console.log("Force fetching defects for next operation: ".concat(e)),eH(e),console.log("Auto-starting next operation: ".concat(e));try{let t=await fetch("/api/operations/start",{method:"POST",headers:{...O(),"Content-Type":"application/json"},body:JSON.stringify({poNumber:Q,operationCode:e})});if(!L(t)){console.log("Response checking failed, aborting auto-start"),J("Not Started");return}if(!t.ok){let r=await t.json();console.error("Failed to auto-start next operation:",r.error),J("Not Started"),U({title:"Warning",description:"Moved to ".concat(e.toUpperCase()," but failed to auto-start: ").concat(r.error),variant:"destructive"});return}let r=await t.json();$(r),J("In Progress"),U({title:"Success",description:"".concat(e.toUpperCase()," operation started automatically!")})}catch(t){console.error("Error auto-starting next operation:",t),J("Not Started"),U({title:"Warning",description:"Moved to ".concat(e.toUpperCase()," but failed to auto-start. Please start manually."),variant:"destructive"})}}U({title:"Success",description:"".concat(Z.toUpperCase()," operation completed successfully!")}),ex("1"),ek(""),eC(""),eS(!1)}catch(e){console.error("Error completing operation:",e),U({title:"Error",description:e instanceof Error?e.message:"An unknown error occurred",variant:"destructive"})}finally{eg(!1)}},[Z,ei,eH,O,ej,Q,eh,eq,U,L]);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(d(),{children:(0,a.jsx)("title",{children:"P-Chart System - Production Order ".concat("string"==typeof Q?Q:"")})}),(0,a.jsxs)(i.Z,{children:[(0,a.jsxs)("div",{className:"py-6",children:[(0,a.jsx)(x.Z,{title:"Production Order - ".concat(Q),actions:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[P&&(0,a.jsx)("div",{className:"text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded-md",children:"Admin Mode"}),(null==F?void 0:null===(f=F.user)||void 0===f?void 0:null===(m=f.role)||void 0===m?void 0:m.toLowerCase())==="viewer"&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded-md",children:"Viewer Mode"}),(0,a.jsx)(s.z,{variant:"outline",onClick:()=>M.push("/production-orders"),className:"mr-2",children:"Back to List"})]}),(null==F?void 0:null===(v=F.user)||void 0===v?void 0:null===(y=v.role)||void 0===y?void 0:y.toLowerCase())!=="viewer"&&(0,a.jsx)(s.z,{variant:"outline",onClick:R,disabled:S,className:"mr-2",children:S?"Releasing...":"Release Lock"})]})}),(0,a.jsx)(et,{poNumber:Q,formData:ed,handleChange:e4,handleUpdate:e5,isSubmitting:ea,isAdmin:P,session:F,orderData:H}),(0,a.jsx)("div",{className:"mt-4 bg-white dark:bg-gray-800 rounded-lg shadow",children:(0,a.jsx)("div",{className:"p-4 border-b",children:(0,a.jsxs)(c.mQ,{defaultValue:Z,value:Z,onValueChange:eK,children:[(0,a.jsx)("div",{className:"overflow-x-auto pb-1",children:(0,a.jsx)(er,{operationSteps:es,activeTab:Z,operationStatuses:eu,isAdmin:P,handleTabChange:eK})}),es.length>0?es.map(e=>{var t,r,o;return(0,a.jsx)(c.nU,{value:e.code.toLowerCase(),className:"py-4",children:(null===(t=eu[e.code.toLowerCase()])||void 0===t?void 0:t.isStarted)||"op10"===e.code.toLowerCase()||es.findIndex(t=>t.code.toLowerCase()===e.code.toLowerCase())>0&&(null===(r=eu[es[es.findIndex(t=>t.code.toLowerCase()===e.code.toLowerCase())-1].code.toLowerCase()])||void 0===r?void 0:r.isCompleted)?(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8",children:[(0,a.jsx)(A,{activeTab:Z,operationStatus:W,operationStatuses:eu,rfValue:eh,setRfValue:ex,defects:ei,isAdmin:P,orderData:H,isSubmitting:ea,isCompletingOperation:em,isUpdatingDefects:ef,showOperationAuditLog:eI,showDefectAuditLog:eT,setShowOperationAuditLog:eE,setShowDefectAuditLog:eD,handleStartOperation:e$,handleCompleteOperation:eX}),(0,a.jsxs)("div",{className:"flex flex-col space-y-6",children:[(0,a.jsx)(X,{activeTab:Z,masterDefects:eB,isAdmin:P,operationStatuses:eu,isLoading:eJ,handleAddDefect:e3,existingDefects:ei.filter(e=>e.quantity>0||e.operationDefectId).map(e=>{var t;return{id:e.id,defectId:e.id,operationId:(null===(t=eu[Z])||void 0===t?void 0:t.operationId)||0}}),poNumber:Q,refreshDefectsForOperationCallback:e6}),(0,a.jsx)(K,{activeTab:Z,defects:ei,isAdmin:P,operationStatuses:eu,isUpdatingDefects:ef,isLoadingDefects:!1,poNumber:Q,handleDefectQuantityChange:e2,refreshDefectsForOperationCallback:e6,selectedDefectId:eQ,selectedDefectName:eG,setSelectedDefectId:eV,setSelectedDefectName:eZ,setShowDefectItemAuditLog:ez,deleteDefect:e8})]})]}):(0,a.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[null===(o=es.find(e=>e.code.toLowerCase()===Z))||void 0===o?void 0:o.name," ","details will be available after previous operations are completed."]})},e.code)}):(0,a.jsx)(c.nU,{value:"loading",className:"p-4",children:(0,a.jsx)("div",{className:"text-center py-8 text-gray-500",children:"Loading operation details..."})})]})})})]}),(0,a.jsx)(ee,{showEndOperationModal:eR,activeTab:Z,lineNo:ej,rfValue:eh,isCompletingOperation:em,setLineNo:ek,setShowEndOperationModal:eS,submitCompleteOperation:e9}),P&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(D,{open:eI,onClose:()=>eE(!1),poNumber:Q,operationId:null===(b=eu[Z])||void 0===b?void 0:b.operationId,type:"operation",title:"Operation Audit Logs - ".concat(null==Z?void 0:Z.toUpperCase())}),(0,a.jsx)(D,{open:eT,onClose:()=>eD(!1),poNumber:Q,operationId:null===(N=eu[Z])||void 0===N?void 0:N.operationId,type:"defect",title:"Defect Audit Logs - ".concat(null==Z?void 0:Z.toUpperCase())})]}),P&&(0,a.jsx)(D,{open:eM,onClose:()=>ez(!1),poNumber:Q,defectId:eQ?parseInt(eQ):void 0,operationId:null===(w=eu[Z])||void 0===w?void 0:w.operationId,type:"defect",title:"Defect Audit Log - ".concat(eG)})]})]})}}},function(e){e.O(0,[192,664,847,143,164,888,774,179],function(){return e(e.s=29327)}),_N_E=e.O()}]);