(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7209],{69430:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/production-orders",function(){return r(96104)}])},17344:function(e,t,r){"use strict";r.d(t,{a:function(){return l}});var o=r(33299),s=r(11163),a=r(67294),n=r(98225),i=r(65050);function l(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{data:t,status:r}=(0,o.useSession)(),l=(0,s.useRouter)(),{toast:c}=(0,i.pm)(),[d,u]=(0,a.useState)(!1),[g,m]=(0,a.useState)(!0),[h,p]=(0,a.useState)(null),[f,x]=(0,a.useState)(!1),{redirectTo:y="/auth/login",requiredRoles:N=[]}=e;(0,a.useEffect)(()=>{if(console.log("Auth effect running, status:",r,"verified:",f),"loading"===r||f)return;if(null==t?void 0:t.user){if(console.log("Found NextAuth session, storing to localStorage"),n.UserSession.storeSession(t.user),N.length>0){var e;let r=((null==t?void 0:null===(e=t.user)||void 0===e?void 0:e.role)||"").toLowerCase();if(!N.some(e=>e.toLowerCase()===r)){console.log("Required role not found. User role: ".concat(r)),u(!1),m(!1),p("You do not have permission to access this page"),x(!0),l.push("/dashboard");return}}u(!0),m(!1),p(null),x(!0);return}let o=n.UserSession.getSession();if(o){if(console.log("Found valid localStorage session, using as fallback"),N.length>0){let e=(o.role||"").toLowerCase();if(!N.some(t=>t.toLowerCase()===e)){console.log("Required role not found. Local user role: ".concat(e)),u(!1),m(!1),p("You do not have permission to access this page"),x(!0),l.push("/dashboard");return}}u(!0),m(!1),p(null),x(!0);return}console.log("No valid session found, redirecting to login"),l.push("".concat(y,"?callbackUrl=").concat(encodeURIComponent(window.location.href)))},[r,t,l,y,N,f]);let b=(0,a.useCallback)(()=>n.UserSession.getAuthHeaders(),[]),j=(0,a.useCallback)(async()=>n.UserSession.getCurrentUser(),[]),v=(0,a.useCallback)(e=>n.UserSession.hasRole(e),[]),w=(0,a.useCallback)(()=>{console.log("Handling expired session"),n.UserSession.clearSession(),(0,o.signOut)({redirect:!1});let e=window.location.href;l.push("".concat(y,"?callbackUrl=").concat(encodeURIComponent(e),"&expired=true"))},[y,l]),S=(0,a.useCallback)(e=>{switch(e.status){case 401:return console.log("Detected 401 unauthorized response - session likely expired"),w(),!1;case 403:return console.log("Detected 403 forbidden response - permission denied"),c({title:"Permission Denied",description:"You don't have permission to access this resource",variant:"destructive"}),!1;case 429:return console.log("Detected 429 response - rate limited"),c({title:"Rate Limited",description:"Too many requests. Please try again later.",variant:"destructive"}),!1;case 500:case 502:case 503:case 504:return console.log("Detected server error (".concat(e.status,")")),c({title:"Server Error",description:"The server encountered an error. Please try again later.",variant:"destructive"}),!1}return!0},[w,c]);return{session:t,status:r,isAuthorized:d,isLoading:g,authError:h,getAuthHeaders:b,getCurrentUser:j,hasRole:v,handleExpiredSession:w,checkResponseAuth:S}}},19094:function(e,t,r){"use strict";r.d(t,{N:function(){return s}});var o=r(67294);function s(e,t){let[r,s]=(0,o.useState)(e);return(0,o.useEffect)(()=>{let r=setTimeout(()=>{s(e)},t);return()=>{clearTimeout(r)}},[e,t]),r}},96104:function(e,t,r){"use strict";r.r(t),r.d(t,{__N_SSP:function(){return _},default:function(){return F}});var o=r(85893),s=r(67294),a=r(87249),n=r(85263),i=r(11163),l=r(45847),c=r(9008),d=r.n(c),u=r(19094),g=r(17344),m=r(65050),h=r(33566),p=r(25998),f=r(90470),x=r(45977),y=r(62916),N=r(13718),b=r(10133),j=r(44531);let v=b.zt,w=b.fC,S=b.xz,U=s.forwardRef((e,t)=>{let{className:r,sideOffset:s=4,...a}=e;return(0,o.jsx)(b.VY,{ref:t,sideOffset:s,className:(0,j.cn)("z-50 overflow-hidden rounded-md bg-primary px-3 py-1.5 text-xs text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r),...a})});U.displayName=b.VY.displayName;var k=r(80068);let C=s.forwardRef((e,t)=>{let{children:r,...s}=e;return(0,o.jsx)(k.fC,{...s,children:r})});C.displayName="AlertDialog",s.forwardRef((e,t)=>{let{children:r,...s}=e;return(0,o.jsx)(k.xz,{...s,ref:t,children:r})}).displayName="AlertDialogTrigger";let D=e=>{let{children:t,...r}=e;return(0,o.jsx)(k.h_,{...r,children:(0,o.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:t})})};D.displayName="AlertDialogPortal";let P=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,o.jsx)(k.aV,{className:(0,j.cn)("fixed inset-0 z-50 bg-background/80 backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",r),...s,ref:t})});P.displayName="AlertDialogOverlay";let R=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,o.jsxs)(D,{children:[(0,o.jsx)(P,{}),(0,o.jsx)(k.VY,{ref:t,className:(0,j.cn)("fixed z-50 grid w-full max-w-lg scale-100 gap-4 border bg-background p-6 opacity-100 shadow-lg animate-in fade-in-0 slide-in-from-bottom-10 sm:rounded-lg sm:zoom-in-90 sm:slide-in-from-bottom-0 md:w-full",r),...s})]})});R.displayName="AlertDialogContent";let I=e=>{let{className:t,...r}=e;return(0,o.jsx)("div",{className:(0,j.cn)("flex flex-col space-y-2 text-center sm:text-left",t),...r})};I.displayName="AlertDialogHeader";let E=e=>{let{className:t,...r}=e;return(0,o.jsx)("div",{className:(0,j.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...r})};E.displayName="AlertDialogFooter";let z=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,o.jsx)(k.Dx,{ref:t,className:(0,j.cn)("text-lg font-semibold",r),...s})});z.displayName="AlertDialogTitle";let A=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,o.jsx)(k.dk,{ref:t,className:(0,j.cn)("text-sm text-muted-foreground",r),...s})});A.displayName="AlertDialogDescription";let O=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,o.jsx)(k.aU,{ref:t,className:(0,j.cn)((0,a.d)(),r),...s})});O.displayName="AlertDialogAction";let L=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,o.jsx)(k.$j,{ref:t,className:(0,j.cn)((0,a.d)({variant:"outline"}),"mt-2 sm:mt-0",r),...s})});L.displayName="AlertDialogCancel";var _=!0;function F(e){let{userData:t}=e,{toast:r}=(0,m.pm)(),c=(0,i.useRouter)(),[b,j]=(0,s.useState)(""),k=(0,u.N)(b,300),[D,P]=(0,s.useState)([]),[_,F]=(0,s.useState)(!0),[q,T]=(0,s.useState)(null),[M,V]=(0,s.useState)(1),[Y,Z]=(0,s.useState)(10),[H,J]=(0,s.useState)(0),[W,X]=(0,s.useState)(1),{getAuthHeaders:B}=(0,g.a)(),[Q,$]=(0,s.useState)(t?parseInt(t.id):null),[G,K]=(0,s.useState)(!1),[ee,et]=(0,s.useState)(void 0),[er,eo]=(0,s.useState)("asc"),[es,ea]=(0,s.useState)(!1),[en,ei]=(0,s.useState)(null),[el,ec]=(0,s.useState)(!1),[ed,eu]=(0,s.useState)(!1),eg=e=>{try{localStorage.setItem("productionOrdersUrl",JSON.stringify(e)),console.log("Saved URL parameters to localStorage:",e)}catch(e){console.error("Error saving to localStorage:",e)}},em=()=>{try{let e=localStorage.getItem("productionOrdersUrl");if(e){let t=JSON.parse(e);return console.log("Loaded URL parameters from localStorage:",t),t}}catch(e){console.error("Error loading from localStorage:",e)}return null};(0,s.useEffect)(()=>{if(c.isReady&&!ed){let{page:e,limit:t,search:r,sortField:o,sortDirection:s}=c.query;if(console.log("Initializing state from URL:",c.query),0===Object.keys(c.query).length){let e=em();e&&Object.keys(e).length>0?(console.log("Using saved parameters from localStorage"),e.page&&V(Number(e.page)),e.limit&&Z(Number(e.limit)),e.search&&j(String(e.search)),e.sortField&&et(String(e.sortField)),e.sortDirection&&eo(e.sortDirection),c.replace({pathname:c.pathname,query:e},void 0,{shallow:!0})):console.log("No saved parameters found or localStorage empty - using defaults for new browser session")}else e&&V(Number(e)),t&&Z(Number(t)),r&&j(String(r)),o&&et(String(o)),s&&eo(s);eu(!0)}},[c.isReady,c.query,ed]),(0,s.useEffect)(()=>{if(c.isReady&&ed){let e={};M>1&&(e.page=String(M)),10!==Y&&(e.limit=String(Y)),b&&(e.search=b),ee&&(e.sortField=ee,e.sortDirection=er),console.log("Updating URL with query:",e),eg(e),Object.keys(e).length>0&&c.replace({pathname:c.pathname,query:e},void 0,{shallow:!0})}},[c.isReady,M,Y,b,ee,er,ed]),(0,s.useEffect)(()=>{if(t){let e=(t.role||"").toUpperCase();console.log("Setting admin status based on role:",e),K("ADMIN"===e)}},[t]),(0,s.useEffect)(()=>{console.log("User data:",t),console.log("User role:",null==t?void 0:t.role),console.log("isAdmin:",G),console.log("currentUserId:",Q)},[t,G,Q]),(0,s.useEffect)(()=>{(async()=>{if(!ed||!t){console.log("Skipping fetch - not initialized or no user data");return}try{F(!0),T(null);let e=B(),t="/api/production-orders?page=".concat(M,"&limit=").concat(Y);k&&(t+="&search=".concat(encodeURIComponent(k))),ee&&(t+="&sortField=".concat(encodeURIComponent(ee),"&sortDirection=").concat(er)),console.log("Fetching orders with URL:",t);let r=await fetch(t,{headers:e});if(!r.ok)throw Error("Failed to fetch production orders");let o=await r.json();console.log("Fetched orders data:",o),P(o.orders),J(o.pagination.total),X(o.pagination.totalPages)}catch(t){let e=t instanceof Error?t.message:"An error occurred";T(e),r({title:"Error",description:e,variant:"destructive"})}finally{F(!1)}})()},[M,Y,k,t,B,r,ee,er,G,ed]);let eh=(e,t)=>{let r="OP".concat(t),o=e.operations.find(e=>e.operation===r);return o?o.endTime?"bg-green-500":o.startTime?"bg-blue-500":"bg-gray-400":"bg-gray-300"},ep=async()=>{if(en)try{if(ec(!0),!(await fetch("/api/production-orders/".concat(en.poNumber),{method:"DELETE",headers:B()})).ok)throw Error("Failed to delete production order");r({title:"Success",description:"Production order ".concat(en.poNumber," has been deleted.")}),P(e=>e.filter(e=>e.poNumber!==en.poNumber)),ea(!1),ei(null)}catch(e){r({title:"Error",description:e instanceof Error?e.message:"An error occurred",variant:"destructive"})}finally{ec(!1)}},ef=[{key:"poNumber",header:"PO Number",sortable:!0},{key:"lotNumber",header:"Lot Number",sortable:!0},{key:"quantity",header:"Quantity",sortable:!0},{key:"itemName",header:"Item Name",sortable:!0},{key:"status",header:"Status",sortable:!0,render:e=>(0,o.jsx)("span",{className:"capitalize ".concat("completed"===e.status?"text-green-600":"inProgress"===e.status?"text-blue-600":"text-gray-600"),children:e.status})},{key:"currentOperation",header:"Current Operation",render:e=>(0,o.jsx)("div",{className:"flex items-center gap-1",children:[10,15,20,30,40].map(t=>(0,o.jsx)("div",{className:"w-6 h-6 rounded-full ".concat(eh(e,t)," \n                flex items-center justify-center text-white text-xs"),children:t},t))})},{key:"modifiedDate",header:"Modified Date",sortable:!0,render:e=>(0,n.WU)(new Date(e.modifiedDate||e.createdDate),"MMM dd, yyyy - hh:mm:ss a")},{key:"actions",header:"Actions",sortable:!0,render:e=>{let t=e.editingUserId&&e.isUserDeleted;return console.log("Rendering actions for order ".concat(e.poNumber,":"),{editingUserId:e.editingUserId,currentUserId:Q,isAdmin:G,isUserDeleted:e.isUserDeleted,isOrphanedLock:t}),(0,o.jsxs)("div",{className:"flex gap-2",children:[!e.editingUserId&&(0,o.jsx)(a.z,{variant:"ghost",size:"icon",onClick:t=>{t.stopPropagation(),c.push("/production-orders/".concat(e.poNumber))},children:(0,o.jsx)(f.Z,{className:"h-4 w-4"})}),e.editingUserId&&(0,o.jsx)(v,{children:(0,o.jsxs)(w,{children:[(0,o.jsx)(S,{asChild:!0,children:(0,o.jsxs)(a.z,{variant:"ghost",size:"icon",onClick:t=>{t.stopPropagation(),c.push("/production-orders/".concat(e.poNumber))},children:[e.editingUserId!==Q&&(0,o.jsx)(x.Z,{className:"h-4 w-4 ".concat(t?"text-orange-500":"text-gray-600")}),e.editingUserId===Q&&(0,o.jsx)(y.Z,{className:"h-4 w-4 ".concat(t?"text-orange-500":"text-green-600")})]})}),(0,o.jsx)(U,{children:t?(0,o.jsxs)("p",{children:["Locked by deleted user: ",e.editingUserName," (User ID: ",e.editingUserId,"). Click to view details."]}):e.editingUserId===Q?(0,o.jsxs)("p",{children:["Locked by you: ",e.editingUserName," (User ID:"," ",e.editingUserId,"). Click to view details."]}):(0,o.jsxs)("p",{children:["Locked by ",e.editingUserName,". Click to view details."]})})]})}),G&&(0,o.jsx)(a.z,{variant:"ghost",size:"icon",onClick:t=>{t.stopPropagation(),ei(e),ea(!0)},children:(0,o.jsx)(N.Z,{className:"h-4 w-4 text-red-500"})})]})}}];return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(d(),{children:(0,o.jsx)("title",{children:"Production Orders - P-Chart System"})}),(0,o.jsx)(l.Z,{children:(0,o.jsxs)("div",{className:"py-6",children:[(0,o.jsx)(h.Z,{title:"Production Orders",description:"Manage your production orders here.",searchPlaceholder:"Search PO number, lot number, or item...",searchValue:b,onSearchChange:e=>{console.log("Search query changed to: ".concat(e.target.value)),j(e.target.value),V(1)},actions:(0,o.jsx)(a.z,{className:"bg-purple-600 hover:bg-purple-700 text-white",onClick:()=>c.push("/production-orders/create"),children:"Create New"})}),(0,o.jsx)(p.w,{data:D,columns:ef,keyField:"poNumber",isLoading:_,error:q||void 0,pagination:{currentPage:M,totalPages:W,totalItems:H,itemsPerPage:Y,onPageChange:e=>{console.log("Changing page to ".concat(e)),V(e)},onItemsPerPageChange:e=>{console.log("Changing items per page to ".concat(e)),Z(e),V(1)}},sortField:ee,sortDirection:er,onSortChange:(e,t)=>{console.log("Sorting by ".concat(e," in ").concat(t," direction")),"actions"===e&&console.log("Actions column sorting requested: ".concat("asc"===t?"Unlocked first":"Locked first")),et(e),eo(t)},emptyMessage:"No production orders found."}),(0,o.jsx)(C,{open:es,onOpenChange:ea,children:(0,o.jsxs)(R,{children:[(0,o.jsxs)(I,{children:[(0,o.jsx)(z,{children:"Delete Production Order"}),(0,o.jsx)(A,{children:"Are you sure you want to delete this production order? This action cannot be undone."})]}),en&&(0,o.jsxs)("div",{className:"py-4",children:[(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"PO Number:"})," ",en.poNumber]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"Lot Number:"})," ",en.lotNumber]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"Item Name:"})," ",en.itemName]})]}),(0,o.jsxs)(E,{children:[(0,o.jsx)(L,{children:"Cancel"}),(0,o.jsx)(O,{onClick:ep,disabled:el,className:"bg-red-600 hover:bg-red-700 text-white",children:el?(0,o.jsxs)("div",{className:"flex items-center",children:[(0,o.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,o.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,o.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Deleting..."]}):"Delete"})]})]})})]})})]})}}},function(e){e.O(0,[4192,1664,4430,1859,5068,7164,8087,2888,9774,179],function(){return e(e.s=69430)}),_N_E=e.O()}]);