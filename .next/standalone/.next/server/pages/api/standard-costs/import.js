"use strict";(()=>{var e={};e.id=9867,e.ids=[9867],e.modules={53524:e=>{e.exports=require("@prisma/client")},98432:e=>{e.exports=require("bcryptjs")},57641:e=>{e.exports=require("exceljs")},1738:e=>{e.exports=require("multer")},60614:e=>{e.exports=require("next-auth/jwt")},62113:e=>{e.exports=require("next-auth/next")},47449:e=>{e.exports=require("next-auth/providers/credentials")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},71017:e=>{e.exports=require("path")},12781:e=>{e.exports=require("stream")},94248:(e,r,t)=>{t.r(r),t.d(r,{config:()=>N,default:()=>v,routeModule:()=>E});var o={};t.r(o),t.d(o,{config:()=>w,default:()=>U});var s=t(71802),n=t(47153),i=t(56249),a=t(44507),l=t(66826),c=t(57641),d=t.n(c),u=t(1738),p=t.n(u),m=t(12781),g=t(71017),f=t.n(g);let h=p()({storage:p().memoryStorage(),limits:{fileSize:10485760},fileFilter:(e,r,t)=>{let o=f().extname(r.originalname).toLowerCase();if(".xlsx"!==o&&".xls"!==o&&".csv"!==o)return t(Error("Only Excel (.xlsx, .xls) and CSV (.csv) files are allowed"));t(null,!0)}}),$=(e,r,t)=>new Promise((o,s)=>{t(e,r,e=>e instanceof Error?s(e):o(e))}),w={api:{bodyParser:!1}};async function x(e){let r=new m.Readable;r.push(e),r.push(null);let t=new(d()).Workbook;await t.xlsx.read(r);let o=t.worksheets[0];if(!o)throw Error("Excel file contains no worksheets");let s={};o.getRow(1).eachCell((e,r)=>{s[e.value?.toString().trim()||""]=r});let n=["Item Name","Cost Per Unit"].filter(e=>!(e in s));if(n.length>0)throw Error(`Excel file is missing required columns: ${n.join(", ")}`);let i=[],a=0;return o.eachRow({includeEmpty:!1},(e,r)=>{if(1===r)return;a++;let t=e.getCell(s["Item Name"]).value?.toString().trim(),o=s.Description?e.getCell(s.Description).value?.toString().trim():"",n=e.getCell(s["Cost Per Unit"]).value?.toString().trim(),l=s.Currency?e.getCell(s.Currency).value?.toString().trim():"USD";if(!t||!n)throw Error(`Row ${r}: Missing required fields (Item Name or Cost Per Unit)`);let c=parseFloat(n.replace(/[$,\s]/g,""));if(isNaN(c)||c<0)throw Error(`Row ${r}: Invalid cost per unit "${n}"`);i.push({itemName:t,description:o||t,costPerUnit:c,currency:l||"USD",lineNumber:r})}),i}async function y(e){console.log(`üîÑ Updating production orders for ${e.length} items...`);let r=0,t=0;for(let o of e)try{let e=await a.Z.standardCost.findUnique({where:{itemName:o},select:{costPerUnit:!0,isActive:!0}});if(!e||!e.isActive){console.warn(`‚ö†Ô∏è  Standard cost not found or inactive for item: ${o}`);continue}let s=await a.Z.productionOrder.updateMany({where:{itemName:o,OR:[{costPerUnit:null},{costPerUnit:0}],status:{not:"Completed"}},data:{costPerUnit:e.costPerUnit,lastCostUpdate:new Date}});s.count>0?(r+=s.count,console.log(`‚úÖ Updated ${s.count} production orders for ${o} with cost $${e.costPerUnit}`)):t++}catch(e){console.error(`‚ùå Error updating production orders for ${o}:`,e),t++}return console.log(`üìä Production order update summary: ${r} updated, ${t} skipped`),{updated:r,skipped:t}}async function P(e,r){let t=0,o=[],s=[];for(let n of e)try{await a.Z.standardCost.upsert({where:{itemName:n.itemName},update:{description:n.description,costPerUnit:n.costPerUnit,currency:n.currency,updatedById:r,updatedAt:new Date},create:{itemName:n.itemName,description:n.description,costPerUnit:n.costPerUnit,currency:n.currency,isActive:!0,createdById:r}}),t++,s.push(n.itemName)}catch(e){console.error(`Error processing ${n.itemName}:`,e),o.push(`Line ${n.lineNumber}: Failed to process ${n.itemName} - ${e instanceof Error?e.message:"Unknown error"}`)}return{success:t,errors:o,updatedItems:s}}async function C(e,r,t){let o=Date.now();try{console.log("API: StandardCosts import auth session validated, user:",t?.user?.name);let s=t?.user?.role||"";if("admin"!==s.toLowerCase())return r.status(403).json({error:"Admin access required"});if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});console.log("Processing file upload..."),await $(e,r,h.single("file"));let n=e.file;if(!n)return r.status(400).json({error:"No file uploaded"});let i=e.body?.replaceAll==="true";console.log(`Import mode: ${i?"Replace All":"Update/Add"}`);let l=f().extname(n.originalname).toLowerCase();console.log(`Received file: ${n.originalname}, size: ${n.size} bytes, type: ${l}`);let c=t?.user?.id?parseInt(t.user.id):null,d=[],u=0,p=[];try{if(".csv"===l){console.log("Parsing CSV file...");let e=n.buffer.toString("utf-8");d=function(e){let r=e.split("\n").map(e=>e.trim()).filter(e=>e),t=[],o=[];if(r.length<2)throw Error("CSV file must have at least a header and one data row");for(let e=1;e<r.length;e++){let s=r[e];if(s)try{let r=s.match(/^"?([^",]+)"?,\s*"?([^",]*)"?,\s*([^,]+),\s*(.+)$/);if(!r){o.push(`Line ${e+1}: Invalid CSV format`);continue}let[,n,i,a,l]=r;if(!n||!a){o.push(`Line ${e+1}: Missing Item Name or Cost Per Unit`);continue}let c=a.replace(/[$,\s]/g,""),d=parseFloat(c);if(isNaN(d)||d<0){o.push(`Line ${e+1}: Invalid cost per unit "${a}"`);continue}t.push({itemName:n.trim(),description:i?.trim()||n.trim(),costPerUnit:d,currency:l?.trim()||"USD",lineNumber:e+1})}catch(r){o.push(`Line ${e+1}: Parse error - ${r instanceof Error?r.message:"Unknown error"}`)}}return o.length>0&&console.warn("CSV parsing errors:",o),t}(e)}else console.log("Parsing Excel file..."),d=await x(n.buffer);console.log(`Validation complete: ${d.length} valid records`)}catch(e){return console.error("Error parsing file:",e),r.status(400).json({error:e instanceof Error?e.message:"Failed to parse file"})}if(0===d.length)return r.status(400).json({error:"No valid records found in file",errors:p.slice(0,10)});let m=0,g=0,w=[];if(i)console.log("\uD83D\uDD04 Replace All mode: Starting transaction..."),await a.Z.$transaction(async e=>{g=(await e.standardCost.deleteMany({})).count,console.log(`üóëÔ∏è  Deleted ${g} existing standard costs`),console.log(`üì¶ Creating ${d.length} new records in batches of 50...`);for(let r=0;r<d.length;r+=50){let t=d.slice(r,r+50),s=Math.floor(r/50)+1,n=Math.ceil(d.length/50);for(let r of(console.log(`Processing batch ${s}/${n} (${t.length} records)...`),t))try{await e.standardCost.create({data:{itemName:r.itemName,description:r.description,costPerUnit:r.costPerUnit,currency:r.currency,isActive:!0,createdById:c}}),m++,w.push(r.itemName)}catch(e){console.error(`Error creating ${r.itemName}:`,e),p.push(`Line ${r.lineNumber}: Failed to create ${r.itemName} - ${e instanceof Error?e.message:"Unknown error"}`),u++}let i=Date.now()-o;if(i>18e3){console.log(`Approaching timeout at ${i}ms, stopping batch processing`);let e=d.length-(r+50);e>0&&p.push(`Timeout: ${e} records were not processed due to time limit`);break}}}),console.log(`‚úÖ Replace All transaction completed: ${g} deleted, ${m} created`);else{console.log(`Processing ${d.length} records in batches of 50...`);for(let e=0;e<d.length;e+=50){let r=d.slice(e,e+50),t=Math.floor(e/50)+1,s=Math.ceil(d.length/50);console.log(`Processing batch ${t}/${s} (${r.length} records)...`);let n=await P(r,c);m+=n.success,u+=n.errors.length,p.push(...n.errors),w.push(...n.updatedItems);let i=Date.now()-o;if(i>2e4){console.log(`Approaching timeout at ${i}ms, stopping batch processing`);let r=d.length-(e+50);r>0&&p.push(`Timeout: ${r} records were not processed due to time limit`);break}}}let C={updated:0,skipped:0};if(w.length>0)try{C=await y(w)}catch(e){console.error("Error updating production orders:",e),p.push(`Production order update failed: ${e instanceof Error?e.message:"Unknown error"}`)}let U=Date.now()-o;return console.log(`Import completed in ${U}ms: ${m} success, ${u} errors`),r.status(200).json({success:!0,message:i?`${l.toUpperCase()} replace completed`:`${l.toUpperCase()} import completed`,successCount:m,errorCount:u,deletedCount:g,replaceAll:i,errors:p.slice(0,20),processingTime:U,productionOrdersUpdated:C.updated,productionOrdersSkipped:C.skipped})}catch(t){let e=Date.now()-o;return console.error(`Error in import handler after ${e}ms:`,t),r.status(500).json({error:"Failed to import file",details:t instanceof Error?t.message:"Unknown error",processingTime:e})}}let U=(0,l.QO)(C),v=(0,i.l)(o,"default"),N=(0,i.l)(o,"config"),E=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/standard-costs/import",pathname:"/api/standard-costs/import",bundlePath:"",filename:""},userland:o})}};var r=require("../../../webpack-api-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[549],()=>t(94248));module.exports=o})();