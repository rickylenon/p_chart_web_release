"use strict";(()=>{var e={};e.id=814,e.ids=[814],e.modules={53524:e=>{e.exports=require("@prisma/client")},98432:e=>{e.exports=require("bcryptjs")},60614:e=>{e.exports=require("next-auth/jwt")},62113:e=>{e.exports=require("next-auth/next")},47449:e=>{e.exports=require("next-auth/providers/credentials")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},11783:(e,t,r)=>{r.r(t),r.d(t,{config:()=>f,default:()=>p,routeModule:()=>g});var o={};r.r(o),r.d(o,{default:()=>c});var n=r(71802),a=r(47153),i=r(56249),d=r(66826),l=r(44507),s=r(41099);async function u(e,t,r){console.log("Operation Defect ID API called with method:",e.method);let{id:o}=e.query,n=parseInt(o);if(isNaN(n))return t.status(400).json({error:"Invalid operation defect ID"});console.log(`Processing operation defect ID: ${n}`);let a=r?.user?.role||"",i="string"==typeof a&&"admin"===a.toLowerCase();console.log("User role:",a,"Is admin?",i);let d=r?.user?.id?parseInt(r.user.id):null;if(!d)return t.status(401).json({error:"User ID is required for this operation"});let u=(0,s.n)(e);if("DELETE"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let e=await l.Z.operationDefect.findUnique({where:{id:n},include:{operation:!0}});if(!e)return t.status(404).json({error:"Operation defect not found"});if(e.operation.endTime&&!i)return console.log("Non-admin user tried to delete a defect from a completed operation"),t.status(403).json({error:"Only admin users can delete defects from completed operations"});let r=await l.Z.$transaction(async t=>{let r={...e};await t.operationDefect.delete({where:{id:n}}),console.log(`Deleted operation defect ID ${n}`),await (0,s.U)({tableName:"operation_defects",recordId:n,action:"delete",oldValues:r,userId:d,...u});let o=await t.operationDefect.findMany({where:{operationId:e.operationId}}),a=o.reduce((e,t)=>{let r=t.defectReworkable?t.quantity-t.quantityRework:t.quantity;return console.log(`Defect ID: ${t.defectId}, Effective: ${r}`),e+r},0);console.log(`Input quantity: ${e.operation.inputQuantity}, Total effective defects: ${a}`);let i=o.reduce((e,t)=>e+(t.quantityReplacement||0),0);console.log(`Total replacements: ${i}`);let l=Math.max(0,e.operation.inputQuantity-a+i);console.log(`Recalculated output quantity: ${l}`);let c=await t.operation.findUnique({where:{id:e.operationId}}),p=await t.operation.update({where:{id:e.operationId},data:{outputQuantity:l}});return await (0,s.U)({tableName:"operations",recordId:e.operationId,action:"update",oldValues:c,newValues:p,userId:d,...u}),await t.operation.findUnique({where:{id:e.operationId},include:{productionOrder:!0}})}),o=await l.Z.productionOrder.findUnique({where:{id:r?.productionOrder.id},include:{operations:!0}});return t.status(200).json(o)}catch(e){return console.error("Error deleting operation defect:",e),t.status(500).json({error:e instanceof Error?e.message:"An unknown error occurred while deleting the operation defect"})}}let c=(0,d.QO)(u),p=(0,i.l)(o,"default"),f=(0,i.l)(o,"config"),g=new n.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/operation-defects/[id]",pathname:"/api/operation-defects/[id]",bundlePath:"",filename:""},userland:o})},41099:(e,t,r)=>{r.d(t,{U:()=>n,n:()=>a});var o=r(44507);async function n(e){console.log(`Creating audit log for ${e.tableName}:${e.recordId}, action: ${e.action}`);try{let t=String(e.recordId),r=e.oldValues?JSON.stringify(e.oldValues):null,n=e.newValues?JSON.stringify(e.newValues):null,a=await o.Z.auditLog.create({data:{tableName:e.tableName,recordId:t,action:e.action,oldValues:r,newValues:n,userId:e.userId,ipAddress:e.ipAddress||null,userAgent:e.userAgent||null}});return console.log(`Audit log created with ID: ${a.id}`),a}catch(e){return console.error("Error creating audit log:",e),null}}function a(e){let t=e.headers["x-forwarded-for"]||e.socket.remoteAddress||null,r=e.headers["user-agent"]||null;return{ipAddress:"string"==typeof t?t.split(",")[0].trim():null,userAgent:r}}}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[549],()=>r(11783));module.exports=o})();