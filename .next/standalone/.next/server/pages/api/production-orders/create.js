"use strict";(()=>{var e={};e.id=672,e.ids=[672],e.modules={53524:e=>{e.exports=require("@prisma/client")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},56249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,o){return o in r?r[o]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,o)):"function"==typeof r&&"default"===o?r:void 0}}})},85981:(e,r,o)=>{o.r(r),o.d(r,{config:()=>p,default:()=>c,routeModule:()=>f});var t={};o.r(t),o.d(t,{default:()=>l});var n=o(71802),a=o(47153),i=o(56249),s=o(19001),d=o(44507);async function u(e,r){if(console.log("Create production order API called"),"POST"!==e.method)return r.status(405).json({error:"Method not allowed"});try{let o="string"==typeof e.body?JSON.parse(e.body):e.body;console.log("Creating production order with data:",o);let{poNumber:t,lotNumber:n,poQuantity:a,itemName:i}=o;if(!t)return r.status(400).json({error:"PO Number is required"});if(!a||isNaN(parseInt(a)))return r.status(400).json({error:"Valid quantity is required"});if(await d.Z.productionOrder.findUnique({where:{poNumber:t}}))return r.status(409).json({error:"Production order with this PO Number already exists"});try{let e=await d.Z.$transaction(async e=>{let r=await e.productionOrder.create({data:{poNumber:t,lotNumber:n||null,poQuantity:parseInt(a),itemName:i||null,status:"CREATED",currentOperation:null}});console.log(`Created production order: ${r.id}`);let o=await e.operationStep.findMany({orderBy:{stepOrder:"asc"}});if(console.log(`Found ${o.length} operation steps`),0===o.length)throw console.error("No operation steps found in the database"),Error("No operation steps found. Please seed the database with operation steps.");let s=await e.user.findFirst();if(!s)throw console.error("No users found in the database"),Error("No users found in the system. Please seed the database with at least one user.");for(let n of(console.log(`Using default user ID: ${s.id} for operations`),console.log(`Creating ${o.length} operations`),o)){console.log(`Creating operation for step: ${n.operationNumber} (Step Order: ${n.stepOrder})`);try{let i=n.stepOrder===Math.min(...o.map(e=>e.stepOrder))?parseInt(a):0,d=await e.operation.create({data:{productionOrderId:r.id,operation:n.operationNumber,operatorId:s.id,inputQuantity:i,encodedById:s.id,rf:1}});console.log(`Created operation ${n.operationNumber} for PO: ${t} (Operation ID: ${d.id}, Input Qty: ${i})`)}catch(e){throw console.error(`Error creating operation for ${n.operationNumber}:`,e),e}}let d=await e.productionOrder.findUnique({where:{id:r.id},include:{operations:{include:{operationDefects:!0}}}});return console.log(`Found ${d?.operations?.length||0} operations for created order`),d});return console.log(`Production order transaction completed successfully: ${e?.id}`),r.status(201).json(e)}catch(e){throw console.error("Transaction error creating production order:",e),Error(`Transaction failed: ${e.message}`)}}catch(e){return console.error("Error creating production order:",e),r.status(500).json({error:"Failed to create production order",details:e instanceof Error?e.message:"Unknown error"})}}let l=(0,s.E)(u),c=(0,i.l)(t,"default"),p=(0,i.l)(t,"config"),f=new n.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/production-orders/create",pathname:"/api/production-orders/create",bundlePath:"",filename:""},userland:t})},44507:(e,r,o)=>{o.d(r,{Z:()=>a,_:()=>n});var t=o(53524);let n=global.prisma||new t.PrismaClient,a=n},19001:(e,r,o)=>{o.d(r,{E:()=>t});function t(e){return async function(r,o){console.log("API Middleware: Checking auth");try{return console.log("API Middleware: Auth passed (dev mode)"),e(r,o)}catch(e){return console.error("API Auth middleware error:",e),o.status(500).json({error:"Internal server error in auth middleware"})}}}},47153:(e,r)=>{var o;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return o}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(o||(o={}))},71802:(e,r,o)=>{e.exports=o(20145)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var o=r(r.s=85981);module.exports=o})();